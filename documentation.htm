<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.3.0"/>
    <title>rundic_docs API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#LoadSettings">LoadSettings</a>
            </li>
            <li>
                    <a class="function" href="#LoadStereoImages">LoadStereoImages</a>
            </li>
            <li>
                    <a class="function" href="#LoadPlanarImages">LoadPlanarImages</a>
            </li>
            <li>
                    <a class="function" href="#SubsetRelativeCoordinates">SubsetRelativeCoordinates</a>
            </li>
            <li>
                    <a class="function" href="#PlanarDICLocal">PlanarDICLocal</a>
            </li>
            <li>
                    <a class="function" href="#StereoDICPlanar">StereoDICPlanar</a>
            </li>
            <li>
                    <a class="function" href="#StereoDICCurved">StereoDICCurved</a>
            </li>
            <li>
                    <a class="function" href="#SIFTquick">SIFTquick</a>
            </li>
            <li>
                    <a class="function" href="#KeypointMatchRobust">KeypointMatchRobust</a>
            </li>
            <li>
                    <a class="function" href="#kNNSubCentres">kNNSubCentres</a>
            </li>
            <li>
                    <a class="function" href="#AffineFitKeypointsRANSAC">AffineFitKeypointsRANSAC</a>
            </li>
            <li>
                    <a class="function" href="#KPMatchMeasurementPoints">KPMatchMeasurementPoints</a>
            </li>
            <li>
                    <a class="function" href="#ProjectiveFitKeypointsRANSAC">ProjectiveFitKeypointsRANSAC</a>
            </li>
            <li>
                    <a class="function" href="#MatchStereoViews">MatchStereoViews</a>
            </li>
            <li>
                    <a class="function" href="#ReferenceImage">ReferenceImage</a>
            </li>
            <li>
                    <a class="function" href="#DeformedImage">DeformedImage</a>
            </li>
            <li>
                    <a class="function" href="#ConvergenceParametersGlobal">ConvergenceParametersGlobal</a>
            </li>
            <li>
                    <a class="function" href="#HessianLocal">HessianLocal</a>
            </li>
            <li>
                    <a class="function" href="#InitialiseConvergenceParamtersLocal">InitialiseConvergenceParamtersLocal</a>
            </li>
            <li>
                    <a class="function" href="#InitialiseDeformationModelSubsets">InitialiseDeformationModelSubsets</a>
            </li>
            <li>
                    <a class="function" href="#InitialiseCoefficientUpdate">InitialiseCoefficientUpdate</a>
            </li>
            <li>
                    <a class="function" href="#GaussNewtonLocal">GaussNewtonLocal</a>
            </li>
            <li>
                    <a class="function" href="#CrossCorrelateViews">CrossCorrelateViews</a>
            </li>
            <li>
                    <a class="function" href="#CompositionalUpdate">CompositionalUpdate</a>
            </li>
            <li>
                    <a class="function" href="#DeformationModelSubset">DeformationModelSubset</a>
            </li>
            <li>
                    <a class="function" href="#ReferenceSubset">ReferenceSubset</a>
            </li>
            <li>
                    <a class="function" href="#DeformedSubset">DeformedSubset</a>
            </li>
            <li>
                    <a class="function" href="#UpdateMeasurementPoints">UpdateMeasurementPoints</a>
            </li>
            <li>
                    <a class="function" href="#UpdateROI">UpdateROI</a>
            </li>
            <li>
                    <a class="function" href="#ExitCriteriaLocal">ExitCriteriaLocal</a>
            </li>
            <li>
                    <a class="function" href="#IncrementalLocal">IncrementalLocal</a>
            </li>
            <li>
                    <a class="function" href="#RefineImageSet">RefineImageSet</a>
            </li>
            <li>
                    <a class="function" href="#LocalMeasurementPoints">LocalMeasurementPoints</a>
            </li>
            <li>
                    <a class="function" href="#FastInterpolation">FastInterpolation</a>
            </li>
            <li>
                    <a class="function" href="#GlobalMeasurementPoints">GlobalMeasurementPoints</a>
            </li>
            <li>
                    <a class="function" href="#AbsoluteReferencing">AbsoluteReferencing</a>
            </li>
            <li>
                    <a class="function" href="#GaussNewtonGlobal">GaussNewtonGlobal</a>
            </li>
            <li>
                    <a class="function" href="#EstimateDisplacementsFourier">EstimateDisplacementsFourier</a>
            </li>
            <li>
                    <a class="function" href="#IncrementalGlobal">IncrementalGlobal</a>
            </li>
            <li>
                    <a class="function" href="#PlaneFitLS">PlaneFitLS</a>
            </li>
            <li>
                    <a class="function" href="#RotationMatrixFromBases">RotationMatrixFromBases</a>
            </li>
            <li>
                    <a class="function" href="#ReadCalibrationParamters">ReadCalibrationParamters</a>
            </li>
            <li>
                    <a class="function" href="#BestPlaneFit">BestPlaneFit</a>
            </li>
            <li>
                    <a class="function" href="#UndistortPoints">UndistortPoints</a>
            </li>
            <li>
                    <a class="function" href="#TriangulateOCV">TriangulateOCV</a>
            </li>
            <li>
                    <a class="function" href="#VirtualStrainGauge">VirtualStrainGauge</a>
            </li>
            <li>
                    <a class="function" href="#DepthFromTwoViewsCameraCS">DepthFromTwoViewsCameraCS</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
rundic_docs    </h1>

                
                        <input id="mod-rundic_docs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-rundic_docs-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1">##IMPORT LIBRARIESMatchStereoViews</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="k">as</span> <span class="nn">la</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">norm</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="nn">cv</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">loadtxt</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="c1"># from fast_interp import interp2d</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="c1">#SKIMAGE packages</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span>  <span class="n">AffineTransform</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">ProjectiveTransform</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">ransac</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span> <span class="nn">platform</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="c1"># import GQ_rosettacode_Python3 as gq</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="c1"># Versioning the library</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="n">__version__</span><span class="o">=</span> <span class="s2">&quot;0.3.1&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="c1">#</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="k">def</span> <span class="nf">LoadSettings</span><span class="p">():</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="w">    </span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Parses the user-specified DIC settings from the &#39;Settings.ini&#39; (config) file</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">    </span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">    These include, amongst others:\n</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">    i. DIC mode: planar/stereo \n</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">    ii. planar-dic solver type: local/global \n</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">    iii. reference strategy \n</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">    Creates a dictionary/dict() variable which stores the intial user settings, named &#39;settings&#39;.</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">    The settings dictionary is passed (by reference) as the first argument to most functions in the library.</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">    The settings dictionary &#39;floats&#39; through the program and the individual dictionary entries may be changed/updated. &quot;&quot;&quot;</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>    
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>    <span class="c1">#load the configuration file containing the DIC settings</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>    <span class="n">configur</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>    <span class="n">configur</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;Settings.ini&#39;</span><span class="p">)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>    <span class="c1">#settings dictionary</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>    <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>    
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>    <span class="c1">#measurement and discretisation type</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="n">meas_type</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DICMode&#39;</span><span class="p">,</span> <span class="s1">&#39;MeasurementType&#39;</span><span class="p">)</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>    <span class="n">discretisation</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DICMode&#39;</span><span class="p">,</span> <span class="s1">&#39;Discretisation&#39;</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>    <span class="c1">#</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meas_type</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Discretisation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discretisation</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Planar&#39;</span><span class="p">:</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>        
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;planar_images&#39;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        <span class="c1">#single image series</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>      
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;StereoPlanar&#39;</span><span class="p">,</span> <span class="s1">&#39;StereoCurved&#39;</span><span class="p">}:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>        
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="c1">#stereo camera-configuration image folders</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>        <span class="n">stereo_images_folder_0</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Stereo&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftCameraImageFolder&#39;</span><span class="p">)</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stereo_images_folder_0</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="n">stereo_images_folder_1</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Stereo&#39;</span><span class="p">,</span> <span class="s1">&#39;RightCameraImageFolder&#39;</span><span class="p">)</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stereo_images_folder_1</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>        <span class="c1">#view-matching</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="n">view_match</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ViewMatching&#39;</span><span class="p">,</span> <span class="s1">&#39;InitializeViewMatch&#39;</span><span class="p">)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>        <span class="n">refine_view_match</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ViewMatching&#39;</span><span class="p">,</span> <span class="s1">&#39;RefineViewMatch&#39;</span><span class="p">)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>        <span class="c1">#</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InitializeViewMatch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_match</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;RefineViewMatch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refine_view_match</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>        
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>        <span class="c1">#first image series to analyse is the left camera/camera 0</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>        
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>        <span class="c1">#internal and stereo calibration parameters folder</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="n">cal_parameters_folder</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Stereo&#39;</span><span class="p">,</span> <span class="s1">&#39;CalibrationParametersFolder&#39;</span><span class="p">)</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CalibrationParametersFolder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cal_parameters_folder</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Discretisation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Local&#39;</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="n">sub_size</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span> <span class="s1">&#39;SubsetSize&#39;</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="n">step_size</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span> <span class="s1">&#39;StepSize&#39;</span><span class="p">)</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="n">sub_shape</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span> <span class="s1">&#39;SubsetShape&#39;</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="n">shape_function</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span> <span class="s1">&#39;DeformationModel&#39;</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="n">import_</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Import&#39;</span><span class="p">,</span> <span class="s1">&#39;Local&#39;</span><span class="p">)</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPointsName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Import&#39;</span><span class="p">,</span> <span class="s1">&#39;MeasurementPointsName&#39;</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_size</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape_function</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StepSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_size</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetShape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_shape</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImportMeasurementPointsFromExternal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">import_</span> 
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a> 
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Global&#39;</span><span class="p">:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="n">element_size</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;ElementSize&#39;</span><span class="p">)</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="n">element_type</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;ElementType&#39;</span><span class="p">)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>        <span class="n">FE_regularization</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;RegularizationType&#39;</span><span class="p">)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>        <span class="n">import_</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Import&#39;</span><span class="p">,</span> <span class="s1">&#39;Global&#39;</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>        <span class="n">quadrature_order</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;QuadratureOrder&#39;</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ElementSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element_size</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ElementType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element_type</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;RegularizationType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FE_regularization</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImportMeasurementPointsFromExternal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">import_</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;QuadratureOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quadrature_order</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>        <span class="k">if</span> <span class="n">import_</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeshParser&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Import&#39;</span><span class="p">,</span> <span class="s1">&#39;MeshParser&#39;</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="c1">#preprocessing of image data</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>    <span class="n">GF_stddev</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;PreProcessing&#39;</span><span class="p">,</span> <span class="s1">&#39;GaussianFilterStdDev&#39;</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>    <span class="n">GF_filtsize</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;PreProcessing&#39;</span><span class="p">,</span> <span class="s1">&#39;GaussianFilterSize&#39;</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>    <span class="n">ROISelection</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PreProcessing&#39;</span><span class="p">,</span> <span class="s1">&#39;ROISelection&#39;</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>    <span class="c1">#</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterStdDev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GF_stddev</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GF_filtsize</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>    <span class="c1">#reference strategy</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>    <span class="n">corr_refstrat</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;CorrelationReferenceStrategy&#39;</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>    <span class="n">datum_image</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;DatumImage&#39;</span><span class="p">)</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>    <span class="n">target_image</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;TargetImage&#39;</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="n">increment</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;Increment&#39;</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>    <span class="n">reference_interpolation</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">)</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>    <span class="c1">#</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CorrelationReferenceStrategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_refstrat</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DatumImage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datum_image</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;TargetImage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_image</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Increment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">increment</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_interpolation</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>    <span class="c1">#Initialization of optimisation routine</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Optimisation&#39;</span><span class="p">,</span> <span class="s1">&#39;GNInitialization&#39;</span><span class="p">)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>    <span class="c1">#strain</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Strain&#39;</span><span class="p">,</span> <span class="s1">&#39;VSGFilterOrder&#39;</span><span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;Strain&#39;</span><span class="p">,</span> <span class="s1">&#39;VSGFilterSize&#39;</span><span class="p">)</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a> 
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initial settings:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>    <span class="k">return</span> <span class="n">settings</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="c1">#</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="k">def</span> <span class="nf">LoadStereoImages</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the image sets for DIC analysis captured by the respective cameras in the stereo-configuration.\n The folder directory is set in (Settings.ini, Stereo, LeftCameraImageFolder, RightCameraImageFolder)&quot;&quot;&quot;</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>    <span class="n">operating_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>    <span class="n">current_working_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>    <span class="c1">#STEREO DIC</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>    <span class="c1">#load image sets</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>    <span class="k">if</span> <span class="n">operating_system</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;Linux&#39;</span><span class="p">}:</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="n">image_folder_0</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">])</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="n">image_folder_1</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">])</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>    <span class="c1">#Windows</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="n">image_folder_0</span> <span class="o">=</span> <span class="s1">&#39;\</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">])</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>        <span class="n">image_folder_1</span> <span class="o">=</span> <span class="s1">&#39;\</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">])</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>    <span class="c1">#two image sets for stereo-dic</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>    <span class="n">image_location_0</span> <span class="o">=</span> <span class="n">current_working_directory</span> <span class="o">+</span> <span class="n">image_folder_0</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>    <span class="n">image_location_1</span> <span class="o">=</span> <span class="n">current_working_directory</span> <span class="o">+</span> <span class="n">image_folder_1</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>    
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>    <span class="c1">#read images in directory</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>    <span class="n">image_set_0</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>    <span class="n">image_set_1</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>    <span class="c1">#first image set</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>    <span class="k">for</span> <span class="n">filename_0</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_location_0</span><span class="p">):</span>    
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>        <span class="n">image_set_0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename_0</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>    <span class="c1">#second image set</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>    <span class="k">for</span> <span class="n">filename_1</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_location_1</span><span class="p">):</span>    
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>        <span class="n">image_set_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename_1</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Stereo images loaded</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;image_set_0:&#39;</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">image_set_0</span><span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;image_set_1:&#39;</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">image_set_1</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>    <span class="k">return</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="c1">#</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="k">def</span> <span class="nf">LoadPlanarImages</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the image set for DIC analysis captured by a single camera.\n The folder directory is set in (Settings.ini, Planar, ImageFolder)&quot;&quot;&quot;</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>    <span class="n">operating_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>    <span class="n">current_working_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>    
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>    <span class="c1">#Linux (need to add macOS option, same as Linux ?)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>    <span class="k">if</span> <span class="n">operating_system</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;Linux&#39;</span><span class="p">}:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>        <span class="n">image_folder</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">])</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>    <span class="c1">#Windows</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>        <span class="n">image_folder</span> <span class="o">=</span> <span class="s1">&#39;\</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">])</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>    <span class="c1">#location of images for DIC measurement</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>    <span class="n">image_location</span> <span class="o">=</span> <span class="n">current_working_directory</span> <span class="o">+</span> <span class="n">image_folder</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>    <span class="c1">#read images in directory</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>    <span class="n">image_set</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_location</span><span class="p">):</span>    
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="n">image_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Planar images loaded, image set:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">image_set</span><span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="k">return</span> <span class="n">image_set</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="c1">#</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="k">def</span> <span class="nf">SubsetRelativeCoordinates</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates the sampling point relative coordinates in the subset, based on the subset size, which is set in (Settings.ini, Local, SubsetSize)&quot;&quot;&quot;</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">])</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>    <span class="c1">#relative/local coordinates of pixels within subset (the same for all subsets)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>    <span class="p">[</span><span class="n">eta</span><span class="p">,</span> <span class="n">xsi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">sub_size</span><span class="p">),</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>                              <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">sub_size</span><span class="p">),</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>                              <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span> <span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>    <span class="c1">#flatten local coordinates to vectors</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>    <span class="n">xsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xsi</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>    <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eta</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>    <span class="k">return</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="c1">#</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="k">def</span> <span class="nf">PlanarDICLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">):</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="c1">#------------------------------------------------------------------------------------</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform planar, local-DIC on an image set captured by a single camera.</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">    Further relevant settings include whether to import the measurement point coordinates (subset centres) set in, </span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">    </span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">    Parameters</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">    ----------</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">        settings[&#39;ReferenceStrategy&#39;] : Reference strategy used to correlate multiple images in an image series,</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">                                        to determine relative displacements. </span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">                                        Parsed from: (Settings.ini, ImageReferencing, CorrelationReferenceStrategy)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">        settings[&#39;MeasurementPoints&#39;] : Subset centre (measurement point) coordinates</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a><span class="sd">                                        Can be imported from an external .csv file where the coordinates are predfined</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a><span class="sd">                                        using an external program. Can be created by populating a rectangular ROI in the</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">                                        reference image (default option).</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a><span class="sd">                                        Parsed from: i.(Settings.ini, Import, Local);</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a><span class="sd">                                                     ii.(Settings.ini, Import, MeasurementPointsName)</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="sd">        </span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="sd">    Returns</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a><span class="sd">    -------</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a><span class="sd">        coefficients : Subset deformation model coefficients</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>    <span class="c1">#measurement point coordinates defined in datum image</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>    <span class="c1">#xsi, eta: local coordinates defined within subset(s)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">}:</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>        <span class="c1">#load measurement point from external file</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImportMeasurementPointsFromExternal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>            <span class="n">measurement_points_name</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPointsName&#39;</span><span class="p">]</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="n">measurement_points</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measurement_points_name</span><span class="p">),</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>                                          <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>           
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>        <span class="c1">#define measurement points using the settings specified in the config file </span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImportMeasurementPointsFromExternal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="n">measurement_points</span> <span class="o">=</span> <span class="n">LocalMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="c1">#append the measurement points to the settings file</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="c1">#temporary line of code to store measurement points for later triangulation of displacement coefficients</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="c1">#np.savetxt(&quot;measurement_points.csv&quot;, measurement_points, delimiter = &quot;,&quot;)</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>    
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>        <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">SubsetRelativeCoordinates</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xsi</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eta</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">measurement_points</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>        
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="c1">#save measurement point coordinates in datum image of left camera as reference</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="c1">#for later use in cross correlation</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;StereoCurved&#39;</span><span class="p">,</span> <span class="s1">&#39;StereoPlanar&#39;</span><span class="p">}:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ROI_L0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROI</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CorrelationReferenceStrategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Incremental&#39;</span><span class="p">:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">IncrementalLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>    <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CorrelationReferenceStrategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Absolute&#39;</span><span class="p">:</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">AbsoluteReferencing</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>    <span class="k">return</span> <span class="n">coefficients</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="c1">#</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="k">def</span> <span class="nf">StereoDICPlanar</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="n">ROI_0</span><span class="p">):</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Discretisation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Local&#39;</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="c1">#perform 2D-DIC on left camera image series</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="n">coefficients_0</span> <span class="o">=</span> <span class="n">PlanarDICLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">ROI_0</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">left camera image series correlation complete&#39;</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>        <span class="c1">#right camera/ camera 1</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>        <span class="n">ROI_1</span> <span class="o">=</span> <span class="n">MatchStereoViews</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="n">coefficients_1</span> <span class="o">=</span> <span class="n">PlanarDICLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="n">ROI_1</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">right camera image series correlation complete&#39;</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="c1">#displacements = TriangulateDisplacements(settings, coefficients_0, coefficients_1)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>         
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>        <span class="c1">#global</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>        <span class="k">pass</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>    <span class="c1">#store output data in a dictionary</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>    <span class="c1">#store DIC displacement measurements to data dictionary</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>        
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_R&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>                                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>    
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_0</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>        
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_R&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>                                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_1</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>    <span class="k">return</span> <span class="n">coefficients_0</span><span class="p">,</span> <span class="n">coefficients_1</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="c1">#</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="k">def</span> <span class="nf">StereoDICCurved</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>    <span class="k">pass</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="c1">#</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="k">def</span> <span class="nf">SIFTquick</span><span class="p">(</span><span class="n">F_ROI_padded</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>    <span class="c1">#keypoint matching/feature detection between reference images of from both cameras</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>    <span class="c1">#create SIFT feature detector object</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">xfeatures2d</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>    <span class="c1">#find keypoints and descriptors in both images</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>    <span class="n">kp1</span><span class="p">,</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">F_ROI_padded</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>    <span class="n">kp2</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>    <span class="c1">#cast keypoints to numpy arrays for ease of use</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>    <span class="c1">#F keypoints x and y coordinates</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>    <span class="n">N_xk1</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>    <span class="n">xk1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_xk1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>    <span class="n">yk1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_xk1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_xk1</span><span class="p">):</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="n">xk1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">kp1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>        <span class="n">yk1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">kp1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>    <span class="n">Xk1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xk1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">yk1</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>    <span class="c1">#F1 keypoints x and y coordinates</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>    <span class="n">N_xk2</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>    <span class="n">xk2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_xk2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>    <span class="n">yk2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_xk2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_xk2</span><span class="p">):</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="n">xk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">kp2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="n">yk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">kp2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>    <span class="n">Xk2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xk2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">yk2</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>    <span class="k">return</span> <span class="p">[</span><span class="n">Xk1</span><span class="p">,</span> <span class="n">Xk2</span><span class="p">],</span> <span class="p">[</span><span class="n">kp1</span><span class="p">,</span> <span class="n">kp2</span><span class="p">],</span> <span class="p">[</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">]</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="c1">#</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a><span class="k">def</span> <span class="nf">KeypointMatchRobust</span><span class="p">(</span><span class="n">Xk</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>    <span class="c1">#find matches between two images with knnmatch and identify good matches</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>    <span class="c1">#store the indices of the matches in F and G</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>    <span class="c1">#only keep good matches using condition inisde for loop</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>            <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m</span><span class="p">])</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>    <span class="c1">#cast good match indices to numpy array</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>    <span class="n">n_matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>    <span class="n">goood_matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_matches</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_matches</span><span class="p">):</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>        <span class="c1">#F descriptors</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>        <span class="n">goood_matches</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_matches</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">queryIdx</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>        <span class="c1">#G descriptors</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>        <span class="n">goood_matches</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_matches</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainIdx</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>    <span class="c1">#remove bad matches from feature detection results</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>    <span class="n">Xk1</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">goood_matches</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>    <span class="n">Xk2</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">goood_matches</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>    <span class="k">return</span> <span class="p">[</span><span class="n">Xk1</span><span class="p">,</span> <span class="n">Xk2</span><span class="p">]</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="c1">#</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="k">def</span> <span class="nf">kNNSubCentres</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>    <span class="c1">#measurement point coordinates of reference image</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>    <span class="c1">#image series from single camera (affine fit)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>        <span class="n">Xo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>    <span class="c1">#cross correlation of left and right cameras (projective transformation fit)</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>        <span class="n">Xo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">]</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>    <span class="c1">#identify K nearest keypoints(neighbours) to each subset centre, respectively</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>    <span class="n">kNN_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_subsets</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="c1">#SSD between subset centre i and all keypoints</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Xo1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Xo1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="c1">#k minimum SSD between subset centre i and all keypoints</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>    <span class="k">return</span> <span class="n">kNN_indices</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="c1">#</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="k">def</span> <span class="nf">AffineFitKeypointsRANSAC</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">kNN_indices</span><span class="p">):</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>    <span class="c1">#storage array for relative displacement between matched</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>    <span class="c1">#measurement points in reference and deformed image</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">])</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>    <span class="k">for</span> <span class="n">i_subset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>        <span class="c1">#measurement point coordinates in reference image</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>        <span class="n">xo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>        <span class="n">yo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="c1">#find kNN keypoint coordinates for current subset</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>        <span class="n">xkp1</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i_subset</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>        <span class="n">xkp2</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i_subset</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>        <span class="n">model_robust</span><span class="p">,</span> <span class="n">inliers</span> <span class="o">=</span> <span class="n">ransac</span><span class="p">((</span><span class="n">xkp1</span><span class="p">,</span> <span class="n">xkp2</span><span class="p">),</span> <span class="n">AffineTransform</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>                                        <span class="n">residual_threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>        
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="c1">#affine transformation homography coefficients</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>        <span class="n">h11</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>        <span class="n">h12</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="n">h13</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>        <span class="n">h21</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>        <span class="n">h22</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="n">h23</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>        <span class="c1">#coordinates of measurement points in the deformed image</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>        <span class="n">xo2</span> <span class="o">=</span> <span class="n">h11</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h12</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h13</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>        <span class="n">yo2</span> <span class="o">=</span> <span class="n">h21</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h22</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h23</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>        <span class="c1">#relative displacement between measurement points in reference and</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="c1">#deformed image</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="c1">#(note that the coordinate systems of the reference and deformed images</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="c1">#are identical - this implies that we can find relative displacements</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="c1">#of the measurement points between two images using a single coordinate frame)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xo2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">xo1</span><span class="p">,</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yo2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">yo1</span> <span class="p">]</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>        
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>    <span class="k">return</span> <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="c1">#</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="k">def</span> <span class="nf">KPMatchMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">F_ROI_padded</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>    
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>    <span class="c1">#keypoint coordinates, keypoint objects, descriptors</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>    <span class="n">Xk</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">SIFTquick</span><span class="p">(</span><span class="n">F_ROI_padded</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>    <span class="c1">#robust matching of keypoints between images</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>    <span class="n">Xk</span> <span class="o">=</span> <span class="n">KeypointMatchRobust</span><span class="p">(</span><span class="n">Xk</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>    <span class="c1">#find k nearest keypoints (neighbours) to each subset centre</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>    <span class="n">kNN_indices</span> <span class="o">=</span> <span class="n">kNNSubCentres</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>    <span class="c1">#find measurementpoints defined in reference image in the</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>    <span class="c1">#deformed image and estimate deformation as displacements</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>    <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">AffineFitKeypointsRANSAC</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">kNN_indices</span><span class="p">)</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>    <span class="k">return</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="c1">#</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="k">def</span> <span class="nf">ProjectiveFitKeypointsRANSAC</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">kNN_indices</span><span class="p">):</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>    <span class="c1">#storage array for relative displacement between matched</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>    <span class="c1">#measurement points in reference and deformed image</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>    <span class="n">Xo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">])</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>    <span class="k">for</span> <span class="n">i_subset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="c1">#measurement point coordinates in reference image</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="n">xo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="n">yo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="c1">#find kNN keypoint coordinates for current subset</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="n">xkp1</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i_subset</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="n">xkp2</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i_subset</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="n">model_robust</span><span class="p">,</span> <span class="n">inliers</span> <span class="o">=</span> <span class="n">ransac</span><span class="p">((</span><span class="n">xkp1</span><span class="p">,</span> <span class="n">xkp2</span><span class="p">),</span> <span class="n">ProjectiveTransform</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>                                        <span class="n">residual_threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="c1">#projective transformation homography coefficients</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>        <span class="n">h11</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>        <span class="n">h12</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>        <span class="n">h13</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>        <span class="n">h21</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>        <span class="n">h22</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>        <span class="n">h23</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>        <span class="n">h31</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>        <span class="n">h32</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="n">h33</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="c1">#coordinates of measurement points in deformed image</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>        <span class="n">xo2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h11</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h12</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h13</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">h31</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h32</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h33</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="n">yo2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h21</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h22</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h23</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">h31</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h32</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h33</span><span class="p">)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>            <span class="n">xo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xo2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>            <span class="n">yo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yo2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">xo2</span><span class="p">,</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>                                               <span class="n">yo2</span> <span class="p">]</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>    <span class="c1">#store measurement points for planar DIC on the right camera image series</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo2</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo2</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>    <span class="c1">#temporary line of code to store measurement points for later triangulation of displacement coefficients</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>    <span class="c1">#np.savetxt(&quot;R_measurement_points.csv&quot;, Xo2, delimiter = &quot;,&quot;)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>    <span class="c1">#xy bounds for ROI of datum image of right camera image series</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>    <span class="n">rx_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>    <span class="n">rx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>    <span class="n">ry_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>    <span class="n">ry_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>    <span class="c1">#ROI in right camera image series</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>    <span class="n">ROI_1</span> <span class="o">=</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rx_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>              <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ry_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>              <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rx_max</span> <span class="o">-</span> <span class="n">rx_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>              <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ry_max</span> <span class="o">-</span> <span class="n">ry_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">))</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>    <span class="k">return</span> <span class="n">ROI_1</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a><span class="c1">#</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="k">def</span> <span class="nf">MatchStereoViews</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">):</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>    <span class="c1">#left camera datum image ROI</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>    <span class="n">ROI_L0</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ROI_L0&#39;</span><span class="p">]</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>    
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>    <span class="c1">#left and right camera datum images</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>    <span class="n">L0_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set_0</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DatumImage&#39;</span><span class="p">]]</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>    <span class="n">R0_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set_1</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DatumImage&#39;</span><span class="p">]]</span> 
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>   
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>    <span class="n">L0_8bit</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">L0_8bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>    <span class="n">R0_8bit</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">R0_8bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>    <span class="c1">#change storage to data dictionary</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;L0_8bit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0_8bit</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;R0_8bit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R0_8bit</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>    
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>    <span class="n">L0_ROI_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">L0_8bit</span><span class="p">)</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>    <span class="c1">#pad the left camera reference image ROI with zeros</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>    <span class="n">L0_ROI_padded</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                  <span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span> \
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>    <span class="o">=</span> <span class="n">L0_8bit</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>              <span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>    <span class="c1">#perform keypoint matching between L0 and R0, find the corresponding measurement</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>    <span class="c1">#points in R0 that are defined in L0 by fitting a projective transformation model</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>    <span class="c1">#between corresponding keypoints in the images around the measurement points in L0</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>    
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>    <span class="c1">#keypoint coordinates, keypoint objects, descriptors</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>    <span class="c1">#settings, F_ROI_padded, F, G</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>    <span class="n">Xk</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">SIFTquick</span><span class="p">(</span><span class="n">L0_ROI_padded</span><span class="p">,</span> <span class="n">R0_8bit</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>    
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>    <span class="c1">#robust matching of keypoints between images</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>    <span class="n">Xk</span> <span class="o">=</span> <span class="n">KeypointMatchRobust</span><span class="p">(</span><span class="n">Xk</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>    <span class="c1">#find k nearest keypoints (neighbours) to each subset centre</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>    <span class="n">kNN_indices</span> <span class="o">=</span> <span class="n">kNNSubCentres</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>    <span class="c1">#find measurement points defined in reference image in the</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>    <span class="c1">#deformed image and estimate deformation as displacements</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>    <span class="n">ROI_1</span> <span class="o">=</span> <span class="n">ProjectiveFitKeypointsRANSAC</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">kNN_indices</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;RefineViewMatch&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>        <span class="n">CrossCorrelateViews</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>    <span class="k">return</span> <span class="n">ROI_1</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a><span class="c1">#</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="k">def</span> <span class="nf">ReferenceImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">):</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>    <span class="c1">#pre-blur filter parameters</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>    <span class="n">GF_filt_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterSize&#39;</span><span class="p">]</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>    <span class="n">GF_std_dev</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterStdDev&#39;</span><span class="p">]</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;StereoPlanar&#39;</span><span class="p">,</span> <span class="s1">&#39;StereoCurved&#39;</span><span class="p">}:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>        <span class="c1">#left camera</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="n">F_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span><span class="p">]</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>        <span class="c1">#right camera</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>            <span class="n">F_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span><span class="p">]</span>  
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>    
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>    <span class="c1">#2D dic</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>        <span class="n">F_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span><span class="p">]</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">F_8bit</span><span class="p">)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>    <span class="n">F_8bit</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">F_8bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>    
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>    <span class="c1">#normalise 8 bit image, (0,255) -&gt; (0,1)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>    <span class="n">F</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">F_8bit</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>    <span class="c1">#blur image with gaussian filter</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>    <span class="k">if</span> <span class="n">GF_filt_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">GF_std_dev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">F</span><span class="p">,</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                            <span class="p">(</span><span class="n">GF_filt_size</span><span class="p">,</span> <span class="n">GF_filt_size</span><span class="p">),</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                            <span class="n">GF_std_dev</span><span class="p">)</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                             
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>    <span class="c1">#gradient of F (reference image) in xy directions</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>    <span class="n">delF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>    <span class="n">F_interpolated</span> <span class="o">=</span> <span class="n">FastInterpolation</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>    <span class="n">delF_interpolated</span> <span class="o">=</span> <span class="p">[</span><span class="n">FastInterpolation</span><span class="p">(</span><span class="n">delF</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">FastInterpolation</span><span class="p">(</span><span class="n">delF</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>    <span class="k">return</span> <span class="n">F</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">delF_interpolated</span>    
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="c1">#</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="k">def</span> <span class="nf">DeformedImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">):</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>    <span class="c1">#gaussian filter settings</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>    <span class="n">GF_filt_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterSize&#39;</span><span class="p">]</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>    <span class="n">GF_std_dev</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterStdDev&#39;</span><span class="p">]</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;StereoPlanar&#39;</span><span class="p">,</span> <span class="s1">&#39;StereoCurved&#39;</span><span class="p">}:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>        <span class="c1">#left or right camera</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="n">G_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Increment&#39;</span><span class="p">]]</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="n">G_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Increment&#39;</span><span class="p">]]</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>    
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>    <span class="c1">#2D dic</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="n">G_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span><span class="p">]</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>    <span class="n">G_8bit</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">G_8bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>    
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>    <span class="c1">#normalise 8 bit image, (0,255) -&gt; (0,1)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>    <span class="n">G</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">G_8bit</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>    <span class="c1">#blur image with gaussian filter</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>    <span class="k">if</span> <span class="n">GF_filt_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">GF_std_dev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">G</span><span class="p">,</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>                            <span class="p">(</span><span class="n">GF_filt_size</span><span class="p">,</span> <span class="n">GF_filt_size</span><span class="p">),</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>                            <span class="n">GF_std_dev</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>    <span class="n">G_interpolated</span> <span class="o">=</span> <span class="n">FastInterpolation</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>    
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>    <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">G_interpolated</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="c1">#</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="k">def</span> <span class="nf">ConvergenceParametersGlobal</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>    <span class="k">pass</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="c1">#</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a><span class="k">def</span> <span class="nf">HessianLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delf</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>    <span class="c1">#flatten subset intensity gradients to vectors</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">delf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>        <span class="n">dfdy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">delf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">delf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>        <span class="n">dfdy</span> <span class="o">=</span> <span class="n">delf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>    <span class="c1">#Affine transformation</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span> 
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>        
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>        <span class="n">Jacobian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="p">])</span><span class="o">.</span><span class="n">T</span>                            
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>    
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>    <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>        <span class="n">Jacobian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>                                
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>    <span class="n">Hessian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Jacobian</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Jacobian</span><span class="p">)</span> 
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>    <span class="k">return</span> <span class="n">Hessian</span><span class="p">,</span> <span class="n">Jacobian</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="c1">#</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="k">def</span> <span class="nf">InitialiseConvergenceParamtersLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>    <span class="n">correlation_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>    <span class="n">exit_crits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>    <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>    <span class="k">return</span> <span class="n">correlation_coefficients</span><span class="p">,</span> <span class="n">exit_crits</span><span class="p">,</span> <span class="n">n_iterations</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="c1">#</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="k">def</span> <span class="nf">InitialiseDeformationModelSubsets</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">ROI</span><span class="p">):</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>    
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>    <span class="c1">#initial estimate of the deformation model</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>    <span class="c1">#the initial model estimate contains only displacements: u0, v0</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>    <span class="c1">#performed here for all the subsets in the ROI</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PhaseCorrelation&#39;</span><span class="p">:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>        <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">EstimateDisplacementsFourier</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TinyDisplacements&#39;</span><span class="p">:</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;KeypointDetection&#39;</span><span class="p">:</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>        <span class="c1">#pad the ROI intensity values with zeros</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>        <span class="n">F_ROI_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">F_8bit</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>        <span class="n">F_ROI_padded</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ROI</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                     <span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ROI</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span> <span class="o">=</span> <span class="n">F_8bit</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ROI</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>                                                              <span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ROI</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>        <span class="n">F_ROI_padded</span> <span class="o">=</span> <span class="n">F_ROI_padded</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>        <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">KPMatchMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                                          <span class="n">F_ROI_padded</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HornSchunck&#39;</span><span class="p">:</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>        <span class="k">pass</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>    
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span>  <span class="o">==</span> <span class="s1">&#39;LucasKanade&#39;</span><span class="p">:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>        <span class="k">pass</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>    <span class="c1">#the estimated displacements correspond to the &#39;zeroth&#39; coefficients of</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>    <span class="c1">#the deformation model</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>        <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>    <span class="c1">#</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>        <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">6</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>    <span class="k">return</span> <span class="n">coeffs</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="c1">#</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="k">def</span> <span class="nf">InitialiseCoefficientUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="n">deltaP</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>    <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>        <span class="n">deltaP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>    <span class="k">return</span> <span class="n">deltaP</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="c1">#</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="k">def</span> <span class="nf">GaussNewtonLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">,</span> <span class="n">image_pair</span><span class="p">):</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>    <span class="c1">#number of intensity values in the subset/template</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>    
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>    <span class="c1">#reference subset local/relative coordinates (same for all subsets)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>    <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>    <span class="n">CC</span><span class="p">,</span> <span class="n">exit_crits</span><span class="p">,</span> <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">InitialiseConvergenceParamtersLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>    <span class="c1">#define reference and target images for current image pair</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>    <span class="c1">#delF: dFdy = delF[0], dFdx = delF[1]</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>    <span class="n">F</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">delF_interpolated</span> <span class="o">=</span> <span class="n">ReferenceImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>                                                     <span class="n">i_image</span><span class="p">)</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>    <span class="n">G</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">G_interpolated</span> <span class="o">=</span> <span class="n">DeformedImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>    
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>    <span class="c1">#deformation model coefficients initialisation (all subsets)</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>    <span class="c1">#p is the vector of coefficients of the subset deformaton model</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">InitialiseDeformationModelSubsets</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>    
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>    <span class="c1">#loop through all subsets/measurement points, determine the model coefficients for</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>    <span class="c1">#each subset independently</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>    <span class="k">for</span> <span class="n">i_subset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="c1">#measurement point/subset centre coordinates for i&#39;th/current subset</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>        <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span> <span class="o">=</span> <span class="p">[</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_subset</span><span class="p">],</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                   <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i_subset</span><span class="p">]</span> <span class="p">]</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="c1">#intensity data for reference subset</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="n">delf</span> <span class="o">=</span> <span class="n">ReferenceSubset</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="n">delf</span> <span class="o">=</span> <span class="n">ReferenceSubset</span><span class="p">(</span><span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF_interpolated</span><span class="p">,</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                                                       <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>        <span class="c1">#Hessian and Jacobian operators for GN optimization routine, derived from</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="c1">#reference subset intensity gradient data</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>        <span class="n">H</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">HessianLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delf</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="c1">#initial estimate for the incremental update of the model coefficients</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>        <span class="n">delta_p_i</span> <span class="o">=</span> <span class="n">InitialiseCoefficientUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>        <span class="c1">#model coefficients</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>        <span class="n">p_i</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="c1">#check the dimensions</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>        <span class="c1">#perform GN optimisation routine</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="k">while</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>            
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>            <span class="c1">#relative coordinates of intensity values within subset</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>            <span class="c1">#of deformed image, based on current iteration of deformation model</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>            <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span> <span class="o">=</span> <span class="n">DeformationModelSubset</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>            <span class="c1">#intensity data of deformed subset</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>            <span class="n">g</span><span class="p">,</span> <span class="n">g_mean</span><span class="p">,</span> <span class="n">g_tilde</span> <span class="o">=</span> <span class="n">DeformedSubset</span><span class="p">(</span><span class="n">G_interpolated</span><span class="p">,</span> <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>            <span class="c1">#</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>            <span class="n">exit_criteria</span> <span class="o">=</span> <span class="n">ExitCriteriaLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delta_p_i</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="k">if</span> <span class="n">exit_criteria</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                <span class="k">break</span> 
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                <span class="n">residual</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="o">-</span><span class="n">f_tilde</span><span class="o">/</span><span class="n">g_tilde</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                <span class="c1">#Gauss-Newton update of deformation model coefficients (for current subset)</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>                <span class="c1">#i.e solve the linear system H*dp = b for i&#39;th subset</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>                <span class="n">delta_p_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>                <span class="n">p_i</span> <span class="o">=</span> <span class="n">CompositionalUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">delta_p_i</span><span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>        <span class="c1">#store convergence information for current subset</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>        <span class="c1">#coefficients of deformation model, correlation criterion,</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="c1">#exit criterion, number of iterations</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="n">CC</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(((</span><span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="p">)</span><span class="o">/</span><span class="n">f_tilde</span><span class="o">-</span><span class="p">(</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span><span class="o">/</span><span class="n">g_tilde</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="n">exit_crits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">exit_criteria</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="n">n_iterations</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>  <span class="o">=</span> <span class="n">iteration</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>        <span class="n">p</span><span class="p">[:,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_i</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>    <span class="k">return</span> <span class="n">p</span> 
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="c1">#</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="k">def</span> <span class="nf">CrossCorrelateViews</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">):</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>    <span class="c1">#number of intensity values in the subset/template</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>    
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>    <span class="c1">#reference subset local/relative coordinates (same for all subsets)</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>    <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>    <span class="n">CC</span><span class="p">,</span> <span class="n">exit_crits</span><span class="p">,</span> <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">InitialiseConvergenceParamtersLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>    <span class="c1">#define reference and target images for current image pair</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>    <span class="c1">#delF: dFdy = delF[0], dFdx = delF[1]</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>    <span class="n">F</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">delF_interpolated</span> <span class="o">=</span> <span class="n">ReferenceImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>    <span class="n">G</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">G_interpolated</span> <span class="o">=</span> <span class="n">DeformedImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>    
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>    <span class="c1">#deformation model coefficients initialisation (all subsets)</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>    <span class="c1">#p is the vector of coefficients of the subset deformaton model</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>    <span class="c1">#initial estimate for the incremental update of the model coefficients</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>        <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>    
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>        <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>    <span class="n">Xo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">])</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>    <span class="k">for</span> <span class="n">i_subset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="c1">#measurement point/subset centre coordinates for i&#39;th/current subset</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span> <span class="o">=</span> <span class="p">[</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_subset</span><span class="p">],</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>                   <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i_subset</span><span class="p">]</span> <span class="p">]</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>        <span class="c1">#intensity data for reference subset</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="n">delf</span> <span class="o">=</span> <span class="n">ReferenceSubset</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>            <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="n">delf</span> <span class="o">=</span> <span class="n">ReferenceSubset</span><span class="p">(</span><span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF_interpolated</span><span class="p">,</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                                                       <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="c1">#Hessian and Jacobian operators for GN optimization routine, derived from</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>        <span class="c1">#reference subset intensity gradient data</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>        <span class="n">H</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">HessianLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delf</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>        <span class="c1">#initial estimate for the incremental update of the model coefficients</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>        <span class="n">delta_p_i</span> <span class="o">=</span> <span class="n">InitialiseCoefficientUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>        <span class="c1">#model coefficients</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>        <span class="n">p_i</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>        <span class="c1">#perform GN optimisation routine</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="k">while</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>            
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>            <span class="c1">#relative coordinates of intensity values within subset</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>            <span class="c1">#of deformed image, based on current iteration of deformation model</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>            <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span> <span class="o">=</span> <span class="n">DeformationModelSubset</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>            <span class="c1">#intensity data of deformed subset</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>            <span class="n">g</span><span class="p">,</span> <span class="n">g_mean</span><span class="p">,</span> <span class="n">g_tilde</span> <span class="o">=</span> <span class="n">DeformedSubset</span><span class="p">(</span><span class="n">G_interpolated</span><span class="p">,</span> <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>            <span class="c1">#</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>            <span class="n">exit_criteria</span> <span class="o">=</span> <span class="n">ExitCriteriaLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delta_p_i</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>            <span class="k">if</span> <span class="n">exit_criteria</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                <span class="k">break</span> 
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>                <span class="n">residual</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="o">-</span><span class="n">f_tilde</span><span class="o">/</span><span class="n">g_tilde</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>                <span class="c1">#Gauss-Newton update of deformation model coefficients (for current subset)</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>                <span class="c1">#i.e solve the linear system H*dp = b for i&#39;th subset</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                <span class="n">delta_p_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                <span class="n">p_i</span> <span class="o">=</span> <span class="n">CompositionalUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">delta_p_i</span><span class="p">)</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="c1">#store convergence information for current subset</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>        <span class="c1">#coefficients of deformation model, correlation criterion,</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>        <span class="c1">#exit criterion, number of iterations</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>        <span class="n">CC</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(((</span><span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="p">)</span><span class="o">/</span><span class="n">f_tilde</span><span class="o">-</span><span class="p">(</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span><span class="o">/</span><span class="n">g_tilde</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>        <span class="n">exit_crits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">exit_criteria</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="n">n_iterations</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>  <span class="o">=</span> <span class="n">iteration</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>        <span class="n">p</span><span class="p">[:,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_i</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="c1">#check interpolation of the reference image</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>            
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>            <span class="c1">#check the deformation model order</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>                <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>                                                        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="p">]</span>   
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>            <span class="k">else</span><span class="p">:</span> 
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>                
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>                <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                                                        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="p">]</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>            <span class="c1">#check the deformation model order</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>            
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>                <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">xo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>                                                        <span class="n">yo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="p">]</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>                
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>                <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">xo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>                                                        <span class="n">yo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="p">]</span>   
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s2">&quot;R_measurement_points_CC.csv&quot;</span><span class="p">,</span> <span class="n">CC</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo2</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo2</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>    <span class="c1">##np.savetxt(&quot;R_measurement_points.csv&quot;, Xo2, delimiter = &quot;,&quot;)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cross Correlation complete&#39;</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>    <span class="k">pass</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="k">def</span> <span class="nf">CompositionalUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dp</span><span class="p">):</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>    <span class="c1">#</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="c1">#w of current estimate of SFPs</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="c1">#order of SFP&#39;s P[1]: 0,  1,  2,  3,  4,  5</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="c1">#                     u   ux  uy  v   vx  vy</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>        <span class="n">w_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>    <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>    <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>                         <span class="p">[</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>    <span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>   <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>                         <span class="p">[</span>  <span class="mi">0</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span>        <span class="mi">1</span> <span class="p">]</span> <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="c1">#w of current delta_p               </span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>        <span class="n">w_dP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>     <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>    <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>                          <span class="p">[</span> <span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>     <span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>   <span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>                          <span class="p">[</span>   <span class="mi">0</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>        <span class="mi">1</span>  <span class="p">]</span> <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>        <span class="c1">#p coefficients compositional update matrix                </span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">w_dP</span><span class="p">,</span><span class="n">w_P</span><span class="p">)</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="c1">#extract updated coefficients from p update/up matrix</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="n">subset_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">])</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>        <span class="c1">#order of SFP&#39;s P[j]: 0,  1,  2,   3,   4,   5,  6,  7,  8,   9,   10,    11</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>        <span class="c1">#                     u   ux  uy  uxx  uxy  uyy  v   vx  vy  vxx   vxy   vyy</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>        <span class="n">A1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>        <span class="n">A2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>        <span class="n">A3</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>        <span class="n">A4</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>        <span class="n">A5</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>        <span class="n">A6</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>        <span class="n">A7</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> 
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>        <span class="n">A8</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>        <span class="n">A9</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        <span class="n">A10</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>        <span class="n">A11</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="n">A12</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>        <span class="n">A13</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>        <span class="n">A14</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>        <span class="n">A15</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="n">A16</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> 
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="n">A17</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="n">A18</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="c1">#entries of w for update</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="n">dA1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>        <span class="n">dA2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="n">dA3</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>        <span class="n">dA4</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>        <span class="n">dA5</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="n">dA6</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="n">dA7</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> 
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="n">dA8</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>        <span class="n">dA9</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="n">dA10</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        <span class="n">dA11</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="n">dA12</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="n">dA13</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>        <span class="n">dA14</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>        <span class="n">dA15</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>        <span class="n">dA16</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> 
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>        <span class="n">dA17</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>        <span class="n">dA18</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="c1">#order of SFP&#39;s P[j]: 0,  1,  2,   3,   4,   5,  6,  7,  8,   9,   10,    11</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        <span class="c1">#                     u   ux  uy  uxx  uxy  uyy  v   vx  vy  vxx   vxy   vyy</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>        <span class="c1">#w of current estimate of SFP&#39;s</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>        <span class="n">w_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">A1</span><span class="p">,</span>       <span class="n">A2</span><span class="p">,</span>       <span class="n">A3</span><span class="p">,</span>       <span class="n">A4</span><span class="p">,</span>     <span class="n">A5</span><span class="p">,</span>      <span class="n">A6</span><span class="p">],</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                         <span class="p">[</span> <span class="n">A7</span><span class="p">,</span>       <span class="mi">1</span><span class="o">+</span><span class="n">A8</span><span class="p">,</span>      <span class="n">A9</span><span class="p">,</span>      <span class="n">A10</span><span class="p">,</span>    <span class="n">A11</span><span class="p">,</span>     <span class="n">A12</span><span class="p">],</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>                         <span class="p">[</span><span class="n">A13</span><span class="p">,</span>       <span class="n">A14</span><span class="p">,</span>     <span class="mi">1</span><span class="o">+</span> <span class="n">A15</span><span class="p">,</span>    <span class="n">A16</span><span class="p">,</span>    <span class="n">A17</span><span class="p">,</span>     <span class="n">A18</span><span class="p">],</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>                         <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>   <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>   <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>                         <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>  <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>  <span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>                         <span class="p">[</span><span class="mi">0</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span>        <span class="mi">1</span><span class="p">]</span> 
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>                       <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>                        
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>        <span class="c1">#w of current deltaP</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="n">w_dP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">dA1</span><span class="p">,</span>       <span class="n">dA2</span><span class="p">,</span>       <span class="n">dA3</span><span class="p">,</span>       <span class="n">dA4</span><span class="p">,</span>     <span class="n">dA5</span><span class="p">,</span>      <span class="n">dA6</span><span class="p">],</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>                          <span class="p">[</span> <span class="n">dA7</span><span class="p">,</span>       <span class="mi">1</span><span class="o">+</span><span class="n">dA8</span><span class="p">,</span>      <span class="n">dA9</span><span class="p">,</span>      <span class="n">dA10</span><span class="p">,</span>    <span class="n">dA11</span><span class="p">,</span>     <span class="n">dA12</span><span class="p">],</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>                          <span class="p">[</span><span class="n">dA13</span><span class="p">,</span>       <span class="n">dA14</span><span class="p">,</span>     <span class="mi">1</span><span class="o">+</span> <span class="n">dA15</span><span class="p">,</span>    <span class="n">dA16</span><span class="p">,</span>    <span class="n">dA17</span><span class="p">,</span>     <span class="n">dA18</span><span class="p">],</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>                          <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>   <span class="mf">0.5</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>   <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>                          <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>  <span class="mf">0.5</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>  <span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span>         <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>                        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>                        
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="c1">#P update matrix                </span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>        <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">w_dP</span><span class="p">,</span><span class="n">w_P</span><span class="p">)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>        <span class="n">subset_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]],</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>                                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>                                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>                                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="p">])</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>    <span class="k">return</span> <span class="n">subset_coefficients</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="c1">#</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="k">def</span> <span class="nf">DeformationModelSubset</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>    <span class="c1">#p are the subset warp coefficients, abbreviated here as p for readability</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="c1">#displace, stretch and shear subset in xy-coordinates (Affine):</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="c1">#order of SFP&#39;s p[j]: 0,  1,  2,  3,  4,  5</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="c1">#                     u   ux  uy  v   vx  vy</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="n">xsi_d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">xsi</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="n">eta_d</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="c1">#order of SFP&#39;s p[j]: 0,  1,  2,   3,   4,   5,  6,  7,  8,   9,   10,    11</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="c1">#                     u   ux  uy  uxx  uxy  uyy  v   vx  vy  vxx   vxy   vyy</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="n">xsi_d</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">xsi</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="n">eta_d</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> 
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>    
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>    <span class="c1">#xsi_eta_deformed = np.hstack([xsi_d, eta_d])</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>    <span class="k">return</span> <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="c1">#</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="k">def</span> <span class="nf">ReferenceSubset</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>    <span class="c1">#extract  refrence subset intensity values, f, from mother image, F,</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>    <span class="c1">#based on subset center coordinates</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="n">yi</span> <span class="o">=</span> <span class="n">yo</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">]</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">xo</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>        <span class="n">dfdy</span> <span class="o">=</span> <span class="n">delF</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">delF</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span> <span class="n">yo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">yo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>            <span class="n">xo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">xo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>        <span class="c1"># subset gradients</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        <span class="c1"># Fy = delF[0], Fx = delF[1]</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="n">dfdy</span> <span class="o">=</span> <span class="n">delF</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span> <span class="n">yo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">yo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>                        <span class="n">xo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">xo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">delF</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span> <span class="n">yo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">yo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>                        <span class="n">xo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">xo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>    <span class="c1">#average subset intensity, and normalsied sum of squared differences</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>    <span class="n">f_mean</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>    <span class="n">f_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>    
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="p">[</span><span class="n">dfdy</span><span class="p">,</span> <span class="n">dfdx</span><span class="p">]</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="c1">#</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="k">def</span> <span class="nf">DeformedSubset</span><span class="p">(</span><span class="n">G_interpolated</span><span class="p">,</span> <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">):</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>    <span class="c1">#coordintes of intensity values of deformed subset/template</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>    <span class="c1">#(all intesity values in the subset)</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>    <span class="n">yd</span> <span class="o">=</span> <span class="n">yo</span> <span class="o">+</span> <span class="n">eta_d</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>    <span class="n">xd</span> <span class="o">=</span> <span class="n">xo</span> <span class="o">+</span> <span class="n">xsi_d</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>    <span class="c1">#extract  deformed subset intensity values, g, from mother image at sub-pixel coordinates</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G_interpolated</span><span class="p">(</span><span class="n">yd</span><span class="p">,</span> <span class="n">xd</span><span class="p">))</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>    <span class="c1">#determine average intensity value of subset g,</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>    <span class="c1"># and normalised sum of squared differences of subset, g_tilde</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>    <span class="n">g_mean</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>    <span class="n">g_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">g_mean</span><span class="p">,</span> <span class="n">g_tilde</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="c1">#</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="k">def</span> <span class="nf">UpdateMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">i_coeffs</span><span class="p">):</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>    
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>        
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">i_coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_coeffs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>        
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">i_coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_coeffs</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>            
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>    <span class="c1">#(introduce round-off error)</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>    <span class="c1">#(if Yes introduce interpolation error)</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>                
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>                                                                                <span class="n">u</span><span class="p">,</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>                                                                                <span class="n">v</span> 
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>                                                                              <span class="p">))</span> 
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>    <span class="k">pass</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="c1">#</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="k">def</span> <span class="nf">UpdateROI</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>    <span class="n">xo</span> <span class="o">=</span>  <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>    <span class="n">yo</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>    <span class="c1">#ROI of new reference image</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>    <span class="n">x_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sub_size</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>    <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">sub_size</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>    <span class="n">y_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sub_size</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>    <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">sub_size</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>    <span class="n">ROI</span> <span class="o">=</span>  <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="o">-</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span><span class="o">-</span><span class="n">y_min</span><span class="p">)</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>    
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>    <span class="k">return</span> <span class="n">ROI</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="c1">#</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="k">def</span> <span class="nf">ExitCriteriaLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delta_p</span><span class="p">,</span> <span class="n">hw</span><span class="p">):</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>    <span class="c1">#hw is the half-width of the subset</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>        <span class="n">hw_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>                               <span class="mi">1</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">hw</span><span class="p">]])</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="n">hw_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>                              <span class="mi">1</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>    
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>    <span class="n">exit_criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">delta_p</span><span class="o">*</span><span class="n">hw_vector</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>    <span class="k">return</span> <span class="n">exit_criteria</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="c1">#</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="k">def</span> <span class="nf">IncrementalLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">):</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>    <span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">n_image_pairs</span> <span class="o">=</span> <span class="n">RefineImageSet</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>    <span class="c1">#number of coefficients in deformation model</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="n">n_coeffs</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>        <span class="n">n_coeffs</span> <span class="o">=</span> <span class="mi">12</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>    
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>    <span class="c1">#storage array for deformation model coefficients of</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>    <span class="c1">#EACH respective image pair</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>    <span class="n">relative_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([(</span><span class="n">n_coeffs</span><span class="o">*</span><span class="n">n_image_pairs</span><span class="p">),</span> 
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>                                 <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>    
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>    <span class="c1">#loop through all image pairs in the incremental range</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>    <span class="n">image_pair</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>    <span class="k">for</span> <span class="n">i_image</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span><span class="p">,</span> <span class="n">increment</span><span class="p">):</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="c1">#coefficients at convergence for current (i&#39;th) image pair</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="n">i_coeffs</span> <span class="o">=</span> <span class="n">GaussNewtonLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">,</span> <span class="n">image_pair</span><span class="p">)</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>        <span class="c1">#store coefficients at convergence of current image pair</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="n">relative_coeffs</span><span class="p">[</span><span class="n">n_coeffs</span><span class="o">*</span><span class="n">image_pair</span><span class="p">:</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>                        <span class="n">n_coeffs</span><span class="o">*</span><span class="n">image_pair</span> <span class="o">+</span> <span class="n">n_coeffs</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">i_coeffs</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>        <span class="c1">#measurement point coordinates and ROI for next image pair</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>        <span class="n">UpdateMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">i_coeffs</span><span class="p">)</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>        <span class="n">ROI</span> <span class="o">=</span> <span class="n">UpdateROI</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image pair </span><span class="si">{}</span><span class="s1"> processed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_pair</span><span class="p">))</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>        <span class="n">image_pair</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>    <span class="k">return</span> <span class="n">relative_coeffs</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="c1">#</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="k">def</span> <span class="nf">RefineImageSet</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>    <span class="c1">#indices of datum and target images in image set</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>    <span class="n">image0</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DatumImage&#39;</span><span class="p">]</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>    <span class="n">image_target</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;TargetImage&#39;</span><span class="p">]</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>    <span class="c1">#size of referencing increment in image set</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>    <span class="n">increment</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Increment&#39;</span><span class="p">]</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>    
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>    <span class="c1">#number of image pairs to process for incremental referencing strategy</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>    <span class="n">n_image_pairs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">image_target</span> <span class="o">-</span> <span class="n">image0</span><span class="p">)</span><span class="o">/</span><span class="n">increment</span><span class="p">)</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">no. of image pairs:&#39;</span><span class="p">,</span> <span class="n">n_image_pairs</span><span class="p">)</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>    <span class="k">return</span> <span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">n_image_pairs</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a><span class="c1">#   </span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a><span class="k">def</span> <span class="nf">LocalMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>    
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>    <span class="c1">#default, case where the entire image should be populated with measurement points</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ROI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        <span class="n">x_origin</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>        <span class="n">y_origin</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>        <span class="n">x_bound</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImageColumns&#39;</span><span class="p">]</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="n">y_bound</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImageRows&#39;</span><span class="p">]</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>    <span class="c1">#case where the ROI has been manually refined </span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>    <span class="k">else</span><span class="p">:</span> 
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="n">x_origin</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="n">y_origin</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>        <span class="n">x_bound</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="n">y_bound</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">])</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>    <span class="n">step_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StepSize&#39;</span><span class="p">])</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>    <span class="c1">#measurement point coordinates: defined in reference image, i.e subset centres</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>    <span class="n">yo</span><span class="p">,</span> <span class="n">xo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_origin</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">step_size</span><span class="p">),</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>                                     <span class="nb">int</span><span class="p">(</span><span class="n">y_bound</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>                                     <span class="n">step_size</span><span class="p">),</span> 
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>                          <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_origin</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">step_size</span><span class="p">),</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>                                     <span class="nb">int</span><span class="p">(</span><span class="n">x_bound</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>                                     <span class="n">step_size</span><span class="p">),</span>     
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>                                                                
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>                          <span class="n">indexing</span> <span class="o">=</span> <span class="s1">&#39;ij&#39;</span> <span class="p">)</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>                   
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>    <span class="c1">#flatten measurement point coordinates to vectors</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>    <span class="n">xo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xo</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>    <span class="n">yo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">yo</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>    <span class="n">measurement_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xo</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">yo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>   
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>    <span class="k">return</span> <span class="n">measurement_points</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="c1">#</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="k">def</span> <span class="nf">FastInterpolation</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>    <span class="c1">#image dimensions</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>    <span class="n">ny</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>    <span class="n">nx</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>    <span class="c1">#interpolation</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>    <span class="n">image_interpolated</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">],</span> <span class="n">e</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>    <span class="k">return</span> <span class="n">image_interpolated</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="c1">#</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="k">def</span> <span class="nf">GlobalMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>    
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>    <span class="k">pass</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="c1">#</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="k">def</span> <span class="nf">AbsoluteReferencing</span><span class="p">():</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>    <span class="k">pass</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="c1">#</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="k">def</span> <span class="nf">GaussNewtonGlobal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">):</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>    <span class="c1">#return nodal_displacements</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>    <span class="k">pass</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="c1">#</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="k">def</span> <span class="nf">EstimateDisplacementsFourier</span><span class="p">():</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>    
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>    <span class="k">pass</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a><span class="c1">#</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a><span class="k">def</span> <span class="nf">IncrementalGlobal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">):</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>    <span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">n_image_pairs</span> <span class="o">=</span> <span class="n">RefineImageSet</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>                                                                <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Discretisation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Global&#39;</span><span class="p">:</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>        <span class="k">for</span> <span class="n">i_image</span> <span class="ow">in</span> <span class="p">(</span><span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span> <span class="o">+</span> <span class="n">increment</span><span class="p">,</span> <span class="n">increment</span><span class="p">):</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>            
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>            <span class="n">coefficients</span> <span class="o">=</span> <span class="n">GaussNewtonGlobal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">)</span>    
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>    <span class="c1">#return dofs</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>    
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>    <span class="k">pass</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="c1">#</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a><span class="k">def</span> <span class="nf">PlaneFitLS</span><span class="p">(</span><span class="n">Xo_camera</span><span class="p">):</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>    <span class="n">xo_c</span> <span class="o">=</span> <span class="n">Xo_camera</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>    <span class="n">yo_c</span> <span class="o">=</span> <span class="n">Xo_camera</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>    <span class="n">zo_c</span> <span class="o">=</span> <span class="n">Xo_camera</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>    <span class="c1">#plane coefficient matrix</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="o">*</span><span class="n">xo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="o">*</span><span class="n">yo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="p">)],</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>              
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="o">*</span><span class="n">yo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yo_c</span><span class="o">*</span><span class="n">yo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yo_c</span><span class="p">)],</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>              
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yo_c</span><span class="p">),</span> <span class="n">xo_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>    <span class="c1">#plane fit RHS</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="o">*</span><span class="n">zo_c</span><span class="p">)],</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>                  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yo_c</span><span class="o">*</span><span class="n">zo_c</span><span class="p">)],</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>                  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">zo_c</span><span class="p">)]])</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>    <span class="c1">#coefficients</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>    <span class="c1">#Z coordinates from plane fit parameters and XY camera coordinates</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xo_c</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">yo_c</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>    <span class="k">return</span> <span class="n">C</span><span class="p">,</span> <span class="n">Z</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="k">def</span> <span class="nf">RotationMatrixFromBases</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">axis_world</span><span class="p">):</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>    <span class="c1">#find the basis vectors of the best fit plane</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>    <span class="n">Zorigin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>    <span class="n">Zx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>    <span class="c1">#three basis vectors of best fit plane</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>    <span class="n">g3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>    <span class="n">g1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">axis_world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis_world</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">axis_world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Zx</span> <span class="o">-</span> <span class="n">Zorigin</span><span class="p">])</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>    <span class="n">g2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">g3</span><span class="p">,</span> <span class="n">g1</span><span class="p">)</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>    <span class="c1">#determine the rotation matrix fromm projections</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>    <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>    <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>    <span class="n">e3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>    <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e3</span><span class="p">))</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>    <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">g3</span><span class="p">))</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>    
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>            <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">G</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]))</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>    <span class="k">return</span> <span class="n">R</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a><span class="c1">#</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a><span class="k">def</span> <span class="nf">ReadCalibrationParamters</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>    <span class="n">folder</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CalibrationParametersFolder&#39;</span><span class="p">]</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>    <span class="c1">#left camera</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>    <span class="n">K0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/K0.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>    <span class="n">R_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/R_0.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>    <span class="n">t_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/t_0.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>    <span class="n">r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/r0.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>    <span class="n">t_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t_0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>    <span class="c1">#right camera</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>    <span class="n">K1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/K1.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>    <span class="n">R_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/R_1.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>    <span class="n">t_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/t_1.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>    <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/r1.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>    <span class="n">t_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t_1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>    <span class="c1">#homogeneous transformation matrics</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>    <span class="n">Rt_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R_0</span><span class="p">,</span> <span class="n">t_0</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>    <span class="n">Rt_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R_1</span><span class="p">,</span> <span class="n">t_1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>    <span class="c1">#camera projection matrices</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>    <span class="n">P0</span> <span class="o">=</span> <span class="n">K0</span><span class="nd">@Rt_0</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>    <span class="n">P1</span> <span class="o">=</span> <span class="n">K1</span><span class="nd">@Rt_1</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>    <span class="n">K0</span> <span class="o">=</span> <span class="n">K0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>    <span class="n">K1</span> <span class="o">=</span> <span class="n">K1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CalibrationParameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">]</span> 
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="k">def</span> <span class="nf">BestPlaneFit</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="n">xo_local_L</span><span class="p">):</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>    <span class="c1">#measurement point coordinates in reference image, camera coordinate system</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>    <span class="n">Xo_camera</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xo_camera&#39;</span><span class="p">]</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>    <span class="c1">#measurement point coordinate in deformed imagem, coordinate system of camera</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>    <span class="n">Xd_camera</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xd_camera&#39;</span><span class="p">]</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>    <span class="c1">#load calibration data</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>    <span class="n">K_L</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_L</span><span class="p">,</span> <span class="n">r_R</span><span class="p">,</span> <span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CalibrationParameters&#39;</span><span class="p">]</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>    <span class="n">C</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">PlaneFitLS</span><span class="p">(</span><span class="n">Xo_camera</span><span class="p">)</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>    <span class="c1">#find local axis pixel coordinates in right image</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;measurement_points_Local.csv&#39;</span><span class="p">,</span> <span class="n">xo_local_L</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>    <span class="c1">#temporarily change some settings</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>    <span class="n">settings_local</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>    <span class="n">settings_local</span><span class="p">[</span><span class="s1">&#39;Import&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Yes&#39;</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>    <span class="n">settings_local</span><span class="p">[</span><span class="s1">&#39;MeasurementPointsName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;measurement_points_Local&#39;</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>    <span class="n">settings_local</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>    <span class="n">p_specimen_L</span><span class="p">,</span> <span class="n">p_specimen_R</span><span class="p">,</span> <span class="n">settings_local</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">StereoDICPlanar</span><span class="p">(</span><span class="n">settings_local</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ROI_L0&#39;</span><span class="p">])</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>    <span class="n">xo_local_R</span> <span class="o">=</span> <span class="n">settings_local</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">]</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>    <span class="c1">#3D world coordinates on local axis coordinate system specimen surface</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>    <span class="n">axis_local</span> <span class="o">=</span> <span class="n">TriangulateOCV</span><span class="p">(</span><span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xo_local_L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_L</span><span class="p">,</span> <span class="n">r_L</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>                                          <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xo_local_R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_R</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>    
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>    <span class="c1">#rotation matrix that brings the left camera coordinate system into the local CS on specimen surface</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">RotationMatrixFromBases</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">axis_local</span><span class="p">)</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>    <span class="c1">#translation from camera coordinate system to origin of locally defined axis CS</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_local</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>    <span class="n">R_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>    <span class="c1">#homogeneous 3D coordinates in camera coordinate system</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>    <span class="n">Xo_camera_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">Xo_camera</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">])</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>    <span class="n">Xo_camera_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo_camera</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>    <span class="n">Xd_camera_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">Xd_camera</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">])</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>    <span class="n">Xd_camera_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xd_camera</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>    <span class="c1">#transform coordinates from camera coordinate system to the locally defined CS</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>    <span class="n">Xo_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R_t</span><span class="p">)</span><span class="nd">@Xo_camera_</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>    <span class="n">Xd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R_t</span><span class="p">)</span><span class="nd">@Xd_camera_</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>    <span class="n">U_w</span> <span class="o">=</span> <span class="n">Xd_w</span> <span class="o">-</span> <span class="n">Xo_w</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>    <span class="k">return</span> <span class="n">Xo_w</span><span class="p">,</span> <span class="n">Xd_w</span><span class="p">,</span> <span class="n">U_w</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a><span class="c1">#</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a><span class="k">def</span> <span class="nf">UndistortPoints</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">camera_matrix</span><span class="p">,</span> <span class="n">dist_coeff</span><span class="p">):</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>    <span class="c1">#number of coordinates to undistort</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>    <span class="n">n_points</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>    <span class="c1">#reshape coordinates to appropriate shape for cv.undistortpoints function</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>    <span class="n">X_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_points</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>    <span class="n">X_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:]</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>    <span class="c1"># do the actual undistort</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>    <span class="n">X_undistorted</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">camera_matrix</span><span class="p">,</span> <span class="n">dist_coeff</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">camera_matrix</span><span class="p">)</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>    <span class="k">return</span> <span class="n">X_undistorted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a><span class="c1">#</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a><span class="k">def</span> <span class="nf">TriangulateOCV</span><span class="p">(</span><span class="n">Q0</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>    <span class="n">coords_hom</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">triangulatePoints</span><span class="p">(</span><span class="n">Q0</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>    <span class="n">coords_3D</span> <span class="o">=</span> <span class="p">(</span><span class="n">coords_hom</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">/</span><span class="n">coords_hom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>    <span class="k">return</span> <span class="n">coords_3D</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="c1">#</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a><span class="k">def</span> <span class="nf">VirtualStrainGauge</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>    <span class="c1">#function can be used for either stereo or 2D-strain filtering</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>    <span class="n">size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterSize&#39;</span><span class="p">]</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>    <span class="n">kNN_VSG_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_subsets</span><span class="p">,</span> <span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>    <span class="n">kNN_VSG_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_subsets</span><span class="p">,</span> <span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>    <span class="n">kNN_VSG_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_subsets</span><span class="p">,</span> <span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>    <span class="c1">#storage array for each strain measurment</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>    <span class="n">ux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>    <span class="n">uy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>    <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>    <span class="n">vy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>    <span class="c1">#find the k nearest measurement points to each virtual strain gauge location</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_subsets</span><span class="p">):</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">xo</span><span class="p">[:])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span> <span class="n">yo</span><span class="p">[:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>        <span class="c1">#indices of nearest subsests</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>        <span class="c1">#k minimum SSD between subset centre i and all keypoints</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>        <span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>    <span class="c1">#fit a polynomial to each measurment point using measurement data in its local neighborhood</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_subsets</span><span class="p">):</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="c1">#relative coordinates of measurement points around current point for strain filter</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>        <span class="n">x_rel</span> <span class="o">=</span> <span class="n">xo</span><span class="p">[</span><span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">-</span> <span class="n">xo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>        <span class="n">y_rel</span> <span class="o">=</span> <span class="n">yo</span><span class="p">[</span><span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">-</span> <span class="n">yo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>        <span class="c1">#diplacements at measurement points around current point for strain filter</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterOrder&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Linear&#39;</span><span class="p">:</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>            <span class="c1">#strain filter coefficient matrix</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_rel</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_rel</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterOrder&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>            <span class="c1">#strain filter coefficient matrix</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_rel</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_rel</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_rel</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_rel</span><span class="o">*</span><span class="n">y_rel</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_rel</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="c1">#LS solution for the strain filter</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>        <span class="n">u_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="nd">@A</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="nd">@u</span><span class="p">)</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>        <span class="n">v_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="nd">@A</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="nd">@v</span><span class="p">)</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>        <span class="c1">#return coefficients for displacement gradients</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>        <span class="n">ux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>        <span class="n">uy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_coeffs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>        <span class="n">vx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="n">vy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_coeffs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>    <span class="c1">#green-lagrange strain tensor components</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>    <span class="n">Ex</span> <span class="o">=</span>  <span class="n">ux</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ux</span><span class="o">*</span><span class="n">ux</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">vx</span><span class="o">*</span><span class="n">vx</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>    <span class="n">Ey</span> <span class="o">=</span>  <span class="n">vy</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">vy</span><span class="o">*</span><span class="n">vy</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">uy</span><span class="o">*</span><span class="n">uy</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>    <span class="n">Exy</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">uy</span> <span class="o">+</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">ux</span><span class="o">*</span><span class="n">uy</span> <span class="o">+</span> <span class="n">vx</span><span class="o">*</span><span class="n">vy</span><span class="p">)</span>    
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>    <span class="k">return</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">Ey</span><span class="p">,</span> <span class="n">Exy</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a><span class="c1">#</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a><span class="k">def</span> <span class="nf">DepthFromTwoViewsCameraCS</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>    <span class="c1">#find the depth measurements in the reference and deformed positions</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>    <span class="c1">#in the coordinate system of the reference(left) camera</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a> 
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>    <span class="c1">#measurement points/subset centre coordinates</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>    <span class="n">xo_L</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">]</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>    <span class="n">xo_R</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">]</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>    <span class="c1">#total displacements, both image series</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>    <span class="n">U_L</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_L&#39;</span><span class="p">]</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>    <span class="n">U_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_R&#39;</span><span class="p">]</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>    <span class="c1">#load the internal and stereo calibration parameters</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>    <span class="n">K_L</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_L</span><span class="p">,</span> <span class="n">r_R</span><span class="p">,</span> <span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CalibrationParameters&#39;</span><span class="p">]</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>    <span class="c1">#displaced subset centre positions in deformed image</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>    <span class="n">xd_L</span> <span class="o">=</span> <span class="n">xo_L</span> <span class="o">+</span> <span class="n">U_L</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>    <span class="n">xd_R</span> <span class="o">=</span> <span class="n">xo_R</span> <span class="o">+</span> <span class="n">U_R</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>    <span class="c1">#3D world coordinates in (left) camera coordinate system, reference position</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>    <span class="n">Xo_camera</span> <span class="o">=</span> <span class="n">TriangulateOCV</span><span class="p">(</span><span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xo_L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_L</span><span class="p">,</span> <span class="n">r_L</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xo_R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_R</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>    <span class="c1">#3D world coordinates in (left) camera coordinate system, after deformation</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>    <span class="n">Xd_camera</span> <span class="o">=</span> <span class="n">TriangulateOCV</span><span class="p">(</span><span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xd_L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_L</span><span class="p">,</span> <span class="n">r_L</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xd_R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_R</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>    <span class="c1">#3D displacements in (left) camera coordinate system</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>    <span class="n">U_camera</span> <span class="o">=</span> <span class="n">Xd_camera</span> <span class="o">-</span> <span class="n">Xo_camera</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>    <span class="c1">#save data</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xo_camera&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo_camera</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xd_camera&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xd_camera</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_camera&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_camera</span> 
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>    <span class="c1">#u = U_camera[:, 0]</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a><span class="c1">#------------------------------------------------------------------------------------</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a><span class="c1"># def GaussQuadrature2D(order):</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a><span class="c1">#     xsi_eta, w2 = gq.ExportGQrundic(order)</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a><span class="c1">#     return xsi_eta, w2</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a><span class="c1"># #    </span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a><span class="c1"># def PlanarDICGlobal(settings, image_set, ROI):</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a><span class="c1">#     #measurement point coordinates defined in datum image</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a><span class="c1">#     #xsi, eta: local coordinates defined within subset(s)</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a><span class="c1">#     if settings[&#39;CameraNo&#39;] in {0, None}:</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a><span class="c1">#         #load measurement point from external file</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a><span class="c1">#         if settings[&#39;ImportMeasurementPointsFromExternal&#39;] == &#39;Yes&#39;:</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>            
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a><span class="c1">#             #mesh parser functions come here</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a><span class="c1">#             # measurement_points = open(&#39;measurement_points.csv&#39;, &#39;rb&#39;)</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="c1">#             # measurement_points = loadtxt(measurement_points, delimiter = &quot;,&quot;)</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a><span class="c1">#             # measurement_points = np.array(measurement_points)</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a><span class="c1">#             pass</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a><span class="c1">#         #should also have an option to create the mesh based on settings and</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a><span class="c1">#         #measurement point coordinates</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>        
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a><span class="c1">#         #define measurement points using the settings specified in the config file </span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a><span class="c1">#         if settings[&#39;ImportMeasurementPointsFromExternal&#39;] == &#39;No&#39;:</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>            
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a><span class="c1">#             mesh = RectangularMeshQuadrilaterals(settings, image_set, ROI)</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a><span class="c1">#             #append the measurement points to the settings file</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a><span class="c1">#             #store measurement points for later triangulation of displacement coefficients</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a><span class="c1">#             #np.savetxt(&quot;measurement_points.csv&quot;, measurement_points, delimiter = &quot;,&quot;)</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>        
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a><span class="c1">#         #save measurement point coordinates in datum image of left camera as reference</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a><span class="c1">#         #for later use in cross correlation</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a><span class="c1">#         if settings[&#39;MeasurementType&#39;] in {&#39;StereoCurved&#39;, &#39;StereoPlanar&#39;}:</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a><span class="c1">#             settings[&#39;MeasurementPoints_L0&#39;] = settings[&#39;MeasurementPoints&#39;]</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a><span class="c1">#             settings[&#39;ROI_L0&#39;] = ROI</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a><span class="c1">#     if settings[&#39;CorrelationReferenceStrategy&#39;] == &#39;Incremental&#39;:</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a><span class="c1">#         coefficients = IncrementalLocal(settings, image_set, ROI)</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a><span class="c1">#     elif settings[&#39;CorrelationReferenceStrategy&#39;] == &#39;Absolute&#39;:</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a><span class="c1">#         coefficients = AbsoluteReferencing(settings, image_set, ROI)</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a><span class="c1">#     return coefficients</span>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a><span class="c1"># #</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a><span class="c1"># def RectangularMeshQuadrilaterals(settings, ROI):</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a><span class="c1">#     element_size = settings[&#39;ElementSize&#39;]</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a><span class="c1">#     xsi_eta, w2 = GaussQuadrature2D(settings[&#39;GQOrder&#39;])</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a><span class="c1">#     #default, case where the entire image should be populated with nodes</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a><span class="c1">#     if np.sum(ROI) == 0:</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a><span class="c1">#         x_origin = 0</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a><span class="c1">#         y_origin = 0</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a><span class="c1">#         x_bound = settings[&#39;ImageColumns&#39;]</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a><span class="c1">#         y_bound = settings[&#39;ImageRows&#39;]</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a><span class="c1">#     #case where the ROI has been manually refined </span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a><span class="c1">#     else: </span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a><span class="c1">#         x_origin = ROI[0]</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a><span class="c1">#         y_origin = ROI[1]</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a><span class="c1">#         x_bound = ROI[0] + ROI[2]</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a><span class="c1">#         y_bound = ROI[1] + ROI[3]</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a><span class="c1">#     if settings[&#39;ElementType&#39;] == &#39;Q4&#39;:</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="c1">#         pass</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a><span class="c1">#     if settings[&#39;ElementType&#39;] == &#39;Q8&#39;:</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a><span class="c1">#         pass</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a><span class="c1">#     if settings[&#39;ElementType&#39;] == &#39;Q9&#39;:</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a><span class="c1">#         #structured grid of x and y coordinates</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a><span class="c1">#         yn, xn = np.meshgrid( np.arange(y_origin,</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a><span class="c1">#                                         y_bound,</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a><span class="c1">#                                         (element_size-1)/2),</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a><span class="c1">#                               np.arange(x_origin,</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a><span class="c1">#                                         x_bound,</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a><span class="c1">#                                         (element_size-1)/2),</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a><span class="c1">#                               indexing = &#39;ij&#39;)</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a><span class="c1">#         #number of nodes in the x and y directions</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a><span class="c1">#         n_nodes_y = yn.shape[0]</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a><span class="c1">#         n_nodes_x = xn.shape[1]</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a><span class="c1">#         n_elements = int(((n_nodes_x-1)/2)*((n_nodes_y-1)/2))</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a><span class="c1">#         #node XY coordinates as vectors</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a><span class="c1">#         node_coords = np.vstack(( xn.ravel(order = &#39;F&#39;),</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a><span class="c1">#                                   yn.ravel(order = &#39;F&#39;) )).T</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a><span class="c1">#         n_nodes = node_coords.shape[0]</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="c1">#         #create the Q9 mesh and label the nodes</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="c1">#         #(should add function here that exports a graphic of the mesh showing</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="c1">#         #the node numbering)</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a><span class="c1">#         mesh_node_no = np.arange(0, n_nodes).reshape(n_nodes_y, n_nodes_x, order = &#39;F&#39;)</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>        
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a><span class="c1">#         #element connectivity table</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a><span class="c1">#         element_conn = np.zeros([n_elements, 9]).astype(int)</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a><span class="c1">#         l = 0</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a><span class="c1">#         for j in range(0, int(((n_nodes_x-1)/2)) + 2, 2):</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a><span class="c1">#             #rows</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a><span class="c1">#             for i in range(0, int(((n_nodes_x-1)/2)) + 2, 2):</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a><span class="c1">#                 element_conn[l, :] = np.array([ mesh_node_no[i, j], mesh_node_no[i+2, j], mesh_node_no[i+2, j+2], mesh_node_no[i, j+2], </span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a><span class="c1">#                                                 mesh_node_no[i+1, j], mesh_node_no[i+2, j+1], mesh_node_no[i+1, j+2], mesh_node_no[i, j+1], mesh_node_no[i+1, j+1] ])</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a><span class="c1">#                 l = l + 1</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a><span class="c1">#         #number the displacement degrees of freedom</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a><span class="c1">#         dof = np.vstack(( np.array(np.arange(n_nodes)),</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a><span class="c1">#                           np.array(n_nodes + np.arange(n_nodes)) )).T</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a><span class="c1">#         #total number if degrees of freedom</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a><span class="c1">#         n_dof = 2*n_nodes</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a><span class="c1">#         #node_coords, element_conn, dof, N_dof, n_elements</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a><span class="c1">#     mesh = dict()</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a><span class="c1">#     mesh[&#39;NodeCoordinates&#39;] = node_coords</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a><span class="c1">#     mesh[&#39;ElementConnectivity&#39;] = element_conn</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a><span class="c1">#     mesh[&#39;DOFIndices&#39;] = dof</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a><span class="c1">#     mesh[&#39;n_Nodes&#39;] = n_nodes</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a><span class="c1">#     mesh[&#39;n_Elements&#39;] = n_elements</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a><span class="c1">#     mesh[&#39;n_IP&#39;] = n_IP</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a><span class="c1">#     #mesh[&#39;n_Nodes&#39;]</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>    
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a><span class="c1">#     return mesh</span>
</span></pre></div>


            </section>
                <section id="LoadSettings">
                            <input id="LoadSettings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">LoadSettings</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LoadSettings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LoadSettings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LoadSettings-26"><a href="#LoadSettings-26"><span class="linenos"> 26</span></a><span class="k">def</span> <span class="nf">LoadSettings</span><span class="p">():</span>
</span><span id="LoadSettings-27"><a href="#LoadSettings-27"><span class="linenos"> 27</span></a><span class="w">    </span>
</span><span id="LoadSettings-28"><a href="#LoadSettings-28"><span class="linenos"> 28</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot; Parses the user-specified DIC settings from the &#39;Settings.ini&#39; (config) file</span>
</span><span id="LoadSettings-29"><a href="#LoadSettings-29"><span class="linenos"> 29</span></a><span class="sd">    </span>
</span><span id="LoadSettings-30"><a href="#LoadSettings-30"><span class="linenos"> 30</span></a><span class="sd">    These include, amongst others:\n</span>
</span><span id="LoadSettings-31"><a href="#LoadSettings-31"><span class="linenos"> 31</span></a><span class="sd">    i. DIC mode: planar/stereo \n</span>
</span><span id="LoadSettings-32"><a href="#LoadSettings-32"><span class="linenos"> 32</span></a><span class="sd">    ii. planar-dic solver type: local/global \n</span>
</span><span id="LoadSettings-33"><a href="#LoadSettings-33"><span class="linenos"> 33</span></a><span class="sd">    iii. reference strategy \n</span>
</span><span id="LoadSettings-34"><a href="#LoadSettings-34"><span class="linenos"> 34</span></a>
</span><span id="LoadSettings-35"><a href="#LoadSettings-35"><span class="linenos"> 35</span></a><span class="sd">    Creates a dictionary/dict() variable which stores the intial user settings, named &#39;settings&#39;.</span>
</span><span id="LoadSettings-36"><a href="#LoadSettings-36"><span class="linenos"> 36</span></a><span class="sd">    The settings dictionary is passed (by reference) as the first argument to most functions in the library.</span>
</span><span id="LoadSettings-37"><a href="#LoadSettings-37"><span class="linenos"> 37</span></a><span class="sd">    The settings dictionary &#39;floats&#39; through the program and the individual dictionary entries may be changed/updated. &quot;&quot;&quot;</span>
</span><span id="LoadSettings-38"><a href="#LoadSettings-38"><span class="linenos"> 38</span></a>    
</span><span id="LoadSettings-39"><a href="#LoadSettings-39"><span class="linenos"> 39</span></a>    <span class="c1">#load the configuration file containing the DIC settings</span>
</span><span id="LoadSettings-40"><a href="#LoadSettings-40"><span class="linenos"> 40</span></a>    <span class="n">configur</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
</span><span id="LoadSettings-41"><a href="#LoadSettings-41"><span class="linenos"> 41</span></a>    <span class="n">configur</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;Settings.ini&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-42"><a href="#LoadSettings-42"><span class="linenos"> 42</span></a>    <span class="c1">#settings dictionary</span>
</span><span id="LoadSettings-43"><a href="#LoadSettings-43"><span class="linenos"> 43</span></a>    <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="LoadSettings-44"><a href="#LoadSettings-44"><span class="linenos"> 44</span></a>    
</span><span id="LoadSettings-45"><a href="#LoadSettings-45"><span class="linenos"> 45</span></a>    <span class="c1">#measurement and discretisation type</span>
</span><span id="LoadSettings-46"><a href="#LoadSettings-46"><span class="linenos"> 46</span></a>    <span class="n">meas_type</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DICMode&#39;</span><span class="p">,</span> <span class="s1">&#39;MeasurementType&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-47"><a href="#LoadSettings-47"><span class="linenos"> 47</span></a>    <span class="n">discretisation</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DICMode&#39;</span><span class="p">,</span> <span class="s1">&#39;Discretisation&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-48"><a href="#LoadSettings-48"><span class="linenos"> 48</span></a>    <span class="c1">#</span>
</span><span id="LoadSettings-49"><a href="#LoadSettings-49"><span class="linenos"> 49</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meas_type</span>
</span><span id="LoadSettings-50"><a href="#LoadSettings-50"><span class="linenos"> 50</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Discretisation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">discretisation</span>
</span><span id="LoadSettings-51"><a href="#LoadSettings-51"><span class="linenos"> 51</span></a>    
</span><span id="LoadSettings-52"><a href="#LoadSettings-52"><span class="linenos"> 52</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Planar&#39;</span><span class="p">:</span>
</span><span id="LoadSettings-53"><a href="#LoadSettings-53"><span class="linenos"> 53</span></a>        
</span><span id="LoadSettings-54"><a href="#LoadSettings-54"><span class="linenos"> 54</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;planar_images&#39;</span>
</span><span id="LoadSettings-55"><a href="#LoadSettings-55"><span class="linenos"> 55</span></a>        <span class="c1">#single image series</span>
</span><span id="LoadSettings-56"><a href="#LoadSettings-56"><span class="linenos"> 56</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="LoadSettings-57"><a href="#LoadSettings-57"><span class="linenos"> 57</span></a>      
</span><span id="LoadSettings-58"><a href="#LoadSettings-58"><span class="linenos"> 58</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;StereoPlanar&#39;</span><span class="p">,</span> <span class="s1">&#39;StereoCurved&#39;</span><span class="p">}:</span>
</span><span id="LoadSettings-59"><a href="#LoadSettings-59"><span class="linenos"> 59</span></a>        
</span><span id="LoadSettings-60"><a href="#LoadSettings-60"><span class="linenos"> 60</span></a>        <span class="c1">#stereo camera-configuration image folders</span>
</span><span id="LoadSettings-61"><a href="#LoadSettings-61"><span class="linenos"> 61</span></a>        <span class="n">stereo_images_folder_0</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Stereo&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftCameraImageFolder&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-62"><a href="#LoadSettings-62"><span class="linenos"> 62</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stereo_images_folder_0</span>
</span><span id="LoadSettings-63"><a href="#LoadSettings-63"><span class="linenos"> 63</span></a>        <span class="n">stereo_images_folder_1</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Stereo&#39;</span><span class="p">,</span> <span class="s1">&#39;RightCameraImageFolder&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-64"><a href="#LoadSettings-64"><span class="linenos"> 64</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stereo_images_folder_1</span>
</span><span id="LoadSettings-65"><a href="#LoadSettings-65"><span class="linenos"> 65</span></a>
</span><span id="LoadSettings-66"><a href="#LoadSettings-66"><span class="linenos"> 66</span></a>        <span class="c1">#view-matching</span>
</span><span id="LoadSettings-67"><a href="#LoadSettings-67"><span class="linenos"> 67</span></a>        <span class="n">view_match</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ViewMatching&#39;</span><span class="p">,</span> <span class="s1">&#39;InitializeViewMatch&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-68"><a href="#LoadSettings-68"><span class="linenos"> 68</span></a>        <span class="n">refine_view_match</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ViewMatching&#39;</span><span class="p">,</span> <span class="s1">&#39;RefineViewMatch&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-69"><a href="#LoadSettings-69"><span class="linenos"> 69</span></a>        <span class="c1">#</span>
</span><span id="LoadSettings-70"><a href="#LoadSettings-70"><span class="linenos"> 70</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InitializeViewMatch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_match</span>
</span><span id="LoadSettings-71"><a href="#LoadSettings-71"><span class="linenos"> 71</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;RefineViewMatch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refine_view_match</span>
</span><span id="LoadSettings-72"><a href="#LoadSettings-72"><span class="linenos"> 72</span></a>        
</span><span id="LoadSettings-73"><a href="#LoadSettings-73"><span class="linenos"> 73</span></a>        <span class="c1">#first image series to analyse is the left camera/camera 0</span>
</span><span id="LoadSettings-74"><a href="#LoadSettings-74"><span class="linenos"> 74</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LoadSettings-75"><a href="#LoadSettings-75"><span class="linenos"> 75</span></a>        
</span><span id="LoadSettings-76"><a href="#LoadSettings-76"><span class="linenos"> 76</span></a>        <span class="c1">#internal and stereo calibration parameters folder</span>
</span><span id="LoadSettings-77"><a href="#LoadSettings-77"><span class="linenos"> 77</span></a>        <span class="n">cal_parameters_folder</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Stereo&#39;</span><span class="p">,</span> <span class="s1">&#39;CalibrationParametersFolder&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-78"><a href="#LoadSettings-78"><span class="linenos"> 78</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CalibrationParametersFolder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cal_parameters_folder</span>
</span><span id="LoadSettings-79"><a href="#LoadSettings-79"><span class="linenos"> 79</span></a>        
</span><span id="LoadSettings-80"><a href="#LoadSettings-80"><span class="linenos"> 80</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Discretisation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Local&#39;</span><span class="p">:</span>
</span><span id="LoadSettings-81"><a href="#LoadSettings-81"><span class="linenos"> 81</span></a>
</span><span id="LoadSettings-82"><a href="#LoadSettings-82"><span class="linenos"> 82</span></a>        <span class="n">sub_size</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span> <span class="s1">&#39;SubsetSize&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-83"><a href="#LoadSettings-83"><span class="linenos"> 83</span></a>        <span class="n">step_size</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span> <span class="s1">&#39;StepSize&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-84"><a href="#LoadSettings-84"><span class="linenos"> 84</span></a>        <span class="n">sub_shape</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span> <span class="s1">&#39;SubsetShape&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-85"><a href="#LoadSettings-85"><span class="linenos"> 85</span></a>        <span class="n">shape_function</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Local&#39;</span><span class="p">,</span> <span class="s1">&#39;DeformationModel&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-86"><a href="#LoadSettings-86"><span class="linenos"> 86</span></a>        <span class="n">import_</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Import&#39;</span><span class="p">,</span> <span class="s1">&#39;Local&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-87"><a href="#LoadSettings-87"><span class="linenos"> 87</span></a>
</span><span id="LoadSettings-88"><a href="#LoadSettings-88"><span class="linenos"> 88</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPointsName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Import&#39;</span><span class="p">,</span> <span class="s1">&#39;MeasurementPointsName&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-89"><a href="#LoadSettings-89"><span class="linenos"> 89</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_size</span>
</span><span id="LoadSettings-90"><a href="#LoadSettings-90"><span class="linenos"> 90</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shape_function</span>
</span><span id="LoadSettings-91"><a href="#LoadSettings-91"><span class="linenos"> 91</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StepSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_size</span>
</span><span id="LoadSettings-92"><a href="#LoadSettings-92"><span class="linenos"> 92</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetShape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_shape</span>
</span><span id="LoadSettings-93"><a href="#LoadSettings-93"><span class="linenos"> 93</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImportMeasurementPointsFromExternal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">import_</span> 
</span><span id="LoadSettings-94"><a href="#LoadSettings-94"><span class="linenos"> 94</span></a> 
</span><span id="LoadSettings-95"><a href="#LoadSettings-95"><span class="linenos"> 95</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Global&#39;</span><span class="p">:</span>
</span><span id="LoadSettings-96"><a href="#LoadSettings-96"><span class="linenos"> 96</span></a>        <span class="n">element_size</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;ElementSize&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-97"><a href="#LoadSettings-97"><span class="linenos"> 97</span></a>        <span class="n">element_type</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;ElementType&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-98"><a href="#LoadSettings-98"><span class="linenos"> 98</span></a>        <span class="n">FE_regularization</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;RegularizationType&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-99"><a href="#LoadSettings-99"><span class="linenos"> 99</span></a>        <span class="n">import_</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Import&#39;</span><span class="p">,</span> <span class="s1">&#39;Global&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-100"><a href="#LoadSettings-100"><span class="linenos">100</span></a>        <span class="n">quadrature_order</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Global&#39;</span><span class="p">,</span> <span class="s1">&#39;QuadratureOrder&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-101"><a href="#LoadSettings-101"><span class="linenos">101</span></a>
</span><span id="LoadSettings-102"><a href="#LoadSettings-102"><span class="linenos">102</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ElementSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element_size</span>
</span><span id="LoadSettings-103"><a href="#LoadSettings-103"><span class="linenos">103</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ElementType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element_type</span>
</span><span id="LoadSettings-104"><a href="#LoadSettings-104"><span class="linenos">104</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;RegularizationType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FE_regularization</span>
</span><span id="LoadSettings-105"><a href="#LoadSettings-105"><span class="linenos">105</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImportMeasurementPointsFromExternal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">import_</span>
</span><span id="LoadSettings-106"><a href="#LoadSettings-106"><span class="linenos">106</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;QuadratureOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quadrature_order</span>
</span><span id="LoadSettings-107"><a href="#LoadSettings-107"><span class="linenos">107</span></a>        
</span><span id="LoadSettings-108"><a href="#LoadSettings-108"><span class="linenos">108</span></a>        <span class="k">if</span> <span class="n">import_</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="LoadSettings-109"><a href="#LoadSettings-109"><span class="linenos">109</span></a>            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeshParser&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Import&#39;</span><span class="p">,</span> <span class="s1">&#39;MeshParser&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-110"><a href="#LoadSettings-110"><span class="linenos">110</span></a>    
</span><span id="LoadSettings-111"><a href="#LoadSettings-111"><span class="linenos">111</span></a>    <span class="c1">#preprocessing of image data</span>
</span><span id="LoadSettings-112"><a href="#LoadSettings-112"><span class="linenos">112</span></a>    <span class="n">GF_stddev</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;PreProcessing&#39;</span><span class="p">,</span> <span class="s1">&#39;GaussianFilterStdDev&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-113"><a href="#LoadSettings-113"><span class="linenos">113</span></a>    <span class="n">GF_filtsize</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;PreProcessing&#39;</span><span class="p">,</span> <span class="s1">&#39;GaussianFilterSize&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-114"><a href="#LoadSettings-114"><span class="linenos">114</span></a>    <span class="n">ROISelection</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PreProcessing&#39;</span><span class="p">,</span> <span class="s1">&#39;ROISelection&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-115"><a href="#LoadSettings-115"><span class="linenos">115</span></a>    <span class="c1">#</span>
</span><span id="LoadSettings-116"><a href="#LoadSettings-116"><span class="linenos">116</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterStdDev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GF_stddev</span>
</span><span id="LoadSettings-117"><a href="#LoadSettings-117"><span class="linenos">117</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GF_filtsize</span>
</span><span id="LoadSettings-118"><a href="#LoadSettings-118"><span class="linenos">118</span></a>
</span><span id="LoadSettings-119"><a href="#LoadSettings-119"><span class="linenos">119</span></a>    <span class="c1">#reference strategy</span>
</span><span id="LoadSettings-120"><a href="#LoadSettings-120"><span class="linenos">120</span></a>    <span class="n">corr_refstrat</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;CorrelationReferenceStrategy&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-121"><a href="#LoadSettings-121"><span class="linenos">121</span></a>    <span class="n">datum_image</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;DatumImage&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-122"><a href="#LoadSettings-122"><span class="linenos">122</span></a>    <span class="n">target_image</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;TargetImage&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-123"><a href="#LoadSettings-123"><span class="linenos">123</span></a>    <span class="n">increment</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;Increment&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-124"><a href="#LoadSettings-124"><span class="linenos">124</span></a>    <span class="n">reference_interpolation</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ImageReferencing&#39;</span><span class="p">,</span> <span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-125"><a href="#LoadSettings-125"><span class="linenos">125</span></a>    <span class="c1">#</span>
</span><span id="LoadSettings-126"><a href="#LoadSettings-126"><span class="linenos">126</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CorrelationReferenceStrategy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_refstrat</span>
</span><span id="LoadSettings-127"><a href="#LoadSettings-127"><span class="linenos">127</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DatumImage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datum_image</span>
</span><span id="LoadSettings-128"><a href="#LoadSettings-128"><span class="linenos">128</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;TargetImage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_image</span>
</span><span id="LoadSettings-129"><a href="#LoadSettings-129"><span class="linenos">129</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Increment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">increment</span>
</span><span id="LoadSettings-130"><a href="#LoadSettings-130"><span class="linenos">130</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_interpolation</span>
</span><span id="LoadSettings-131"><a href="#LoadSettings-131"><span class="linenos">131</span></a>
</span><span id="LoadSettings-132"><a href="#LoadSettings-132"><span class="linenos">132</span></a>    <span class="c1">#Initialization of optimisation routine</span>
</span><span id="LoadSettings-133"><a href="#LoadSettings-133"><span class="linenos">133</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Optimisation&#39;</span><span class="p">,</span> <span class="s1">&#39;GNInitialization&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-134"><a href="#LoadSettings-134"><span class="linenos">134</span></a>
</span><span id="LoadSettings-135"><a href="#LoadSettings-135"><span class="linenos">135</span></a>    <span class="c1">#strain</span>
</span><span id="LoadSettings-136"><a href="#LoadSettings-136"><span class="linenos">136</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterOrder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Strain&#39;</span><span class="p">,</span> <span class="s1">&#39;VSGFilterOrder&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-137"><a href="#LoadSettings-137"><span class="linenos">137</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configur</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;Strain&#39;</span><span class="p">,</span> <span class="s1">&#39;VSGFilterSize&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-138"><a href="#LoadSettings-138"><span class="linenos">138</span></a> 
</span><span id="LoadSettings-139"><a href="#LoadSettings-139"><span class="linenos">139</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Initial settings:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="LoadSettings-140"><a href="#LoadSettings-140"><span class="linenos">140</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="LoadSettings-141"><a href="#LoadSettings-141"><span class="linenos">141</span></a>
</span><span id="LoadSettings-142"><a href="#LoadSettings-142"><span class="linenos">142</span></a>    <span class="k">return</span> <span class="n">settings</span>
</span></pre></div>


            <div class="docstring"><p>Parses the user-specified DIC settings from the 'Settings.ini' (config) file</p>

<p>These include, amongst others:</p>

<p>i. DIC mode: planar/stereo </p>

<p>ii. planar-dic solver type: local/global </p>

<p>iii. reference strategy </p>

<p>Creates a dictionary/dict() variable which stores the intial user settings, named 'settings'.
The settings dictionary is passed (by reference) as the first argument to most functions in the library.
The settings dictionary 'floats' through the program and the individual dictionary entries may be changed/updated.</p>
</div>


                </section>
                <section id="LoadStereoImages">
                            <input id="LoadStereoImages-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">LoadStereoImages</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LoadStereoImages-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LoadStereoImages"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LoadStereoImages-144"><a href="#LoadStereoImages-144"><span class="linenos">144</span></a><span class="k">def</span> <span class="nf">LoadStereoImages</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="LoadStereoImages-145"><a href="#LoadStereoImages-145"><span class="linenos">145</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the image sets for DIC analysis captured by the respective cameras in the stereo-configuration.\n The folder directory is set in (Settings.ini, Stereo, LeftCameraImageFolder, RightCameraImageFolder)&quot;&quot;&quot;</span>
</span><span id="LoadStereoImages-146"><a href="#LoadStereoImages-146"><span class="linenos">146</span></a>    <span class="n">operating_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
</span><span id="LoadStereoImages-147"><a href="#LoadStereoImages-147"><span class="linenos">147</span></a>    <span class="n">current_working_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LoadStereoImages-148"><a href="#LoadStereoImages-148"><span class="linenos">148</span></a>
</span><span id="LoadStereoImages-149"><a href="#LoadStereoImages-149"><span class="linenos">149</span></a>    <span class="c1">#STEREO DIC</span>
</span><span id="LoadStereoImages-150"><a href="#LoadStereoImages-150"><span class="linenos">150</span></a>    <span class="c1">#load image sets</span>
</span><span id="LoadStereoImages-151"><a href="#LoadStereoImages-151"><span class="linenos">151</span></a>    <span class="k">if</span> <span class="n">operating_system</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;Linux&#39;</span><span class="p">}:</span>
</span><span id="LoadStereoImages-152"><a href="#LoadStereoImages-152"><span class="linenos">152</span></a>        <span class="n">image_folder_0</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">])</span>
</span><span id="LoadStereoImages-153"><a href="#LoadStereoImages-153"><span class="linenos">153</span></a>        <span class="n">image_folder_1</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">])</span>
</span><span id="LoadStereoImages-154"><a href="#LoadStereoImages-154"><span class="linenos">154</span></a>    <span class="c1">#Windows</span>
</span><span id="LoadStereoImages-155"><a href="#LoadStereoImages-155"><span class="linenos">155</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="LoadStereoImages-156"><a href="#LoadStereoImages-156"><span class="linenos">156</span></a>        <span class="n">image_folder_0</span> <span class="o">=</span> <span class="s1">&#39;\</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">])</span>
</span><span id="LoadStereoImages-157"><a href="#LoadStereoImages-157"><span class="linenos">157</span></a>        <span class="n">image_folder_1</span> <span class="o">=</span> <span class="s1">&#39;\</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">])</span>
</span><span id="LoadStereoImages-158"><a href="#LoadStereoImages-158"><span class="linenos">158</span></a>    <span class="c1">#two image sets for stereo-dic</span>
</span><span id="LoadStereoImages-159"><a href="#LoadStereoImages-159"><span class="linenos">159</span></a>    <span class="n">image_location_0</span> <span class="o">=</span> <span class="n">current_working_directory</span> <span class="o">+</span> <span class="n">image_folder_0</span>
</span><span id="LoadStereoImages-160"><a href="#LoadStereoImages-160"><span class="linenos">160</span></a>    <span class="n">image_location_1</span> <span class="o">=</span> <span class="n">current_working_directory</span> <span class="o">+</span> <span class="n">image_folder_1</span>
</span><span id="LoadStereoImages-161"><a href="#LoadStereoImages-161"><span class="linenos">161</span></a>    
</span><span id="LoadStereoImages-162"><a href="#LoadStereoImages-162"><span class="linenos">162</span></a>    <span class="c1">#read images in directory</span>
</span><span id="LoadStereoImages-163"><a href="#LoadStereoImages-163"><span class="linenos">163</span></a>    <span class="n">image_set_0</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LoadStereoImages-164"><a href="#LoadStereoImages-164"><span class="linenos">164</span></a>    <span class="n">image_set_1</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LoadStereoImages-165"><a href="#LoadStereoImages-165"><span class="linenos">165</span></a>    <span class="c1">#first image set</span>
</span><span id="LoadStereoImages-166"><a href="#LoadStereoImages-166"><span class="linenos">166</span></a>    <span class="k">for</span> <span class="n">filename_0</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_location_0</span><span class="p">):</span>    
</span><span id="LoadStereoImages-167"><a href="#LoadStereoImages-167"><span class="linenos">167</span></a>        <span class="n">image_set_0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename_0</span><span class="p">)</span>
</span><span id="LoadStereoImages-168"><a href="#LoadStereoImages-168"><span class="linenos">168</span></a>    <span class="c1">#second image set</span>
</span><span id="LoadStereoImages-169"><a href="#LoadStereoImages-169"><span class="linenos">169</span></a>    <span class="k">for</span> <span class="n">filename_1</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_location_1</span><span class="p">):</span>    
</span><span id="LoadStereoImages-170"><a href="#LoadStereoImages-170"><span class="linenos">170</span></a>        <span class="n">image_set_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename_1</span><span class="p">)</span>
</span><span id="LoadStereoImages-171"><a href="#LoadStereoImages-171"><span class="linenos">171</span></a>
</span><span id="LoadStereoImages-172"><a href="#LoadStereoImages-172"><span class="linenos">172</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Stereo images loaded</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="LoadStereoImages-173"><a href="#LoadStereoImages-173"><span class="linenos">173</span></a>
</span><span id="LoadStereoImages-174"><a href="#LoadStereoImages-174"><span class="linenos">174</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;image_set_0:&#39;</span><span class="p">)</span>
</span><span id="LoadStereoImages-175"><a href="#LoadStereoImages-175"><span class="linenos">175</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">image_set_0</span><span class="p">)</span>
</span><span id="LoadStereoImages-176"><a href="#LoadStereoImages-176"><span class="linenos">176</span></a>
</span><span id="LoadStereoImages-177"><a href="#LoadStereoImages-177"><span class="linenos">177</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;image_set_1:&#39;</span><span class="p">)</span>
</span><span id="LoadStereoImages-178"><a href="#LoadStereoImages-178"><span class="linenos">178</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">image_set_1</span><span class="p">)</span>
</span><span id="LoadStereoImages-179"><a href="#LoadStereoImages-179"><span class="linenos">179</span></a>
</span><span id="LoadStereoImages-180"><a href="#LoadStereoImages-180"><span class="linenos">180</span></a>    <span class="k">return</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span>
</span></pre></div>


            <div class="docstring"><p>Loads the image sets for DIC analysis captured by the respective cameras in the stereo-configuration.
The folder directory is set in (Settings.ini, Stereo, LeftCameraImageFolder, RightCameraImageFolder)</p>
</div>


                </section>
                <section id="LoadPlanarImages">
                            <input id="LoadPlanarImages-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">LoadPlanarImages</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LoadPlanarImages-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LoadPlanarImages"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LoadPlanarImages-182"><a href="#LoadPlanarImages-182"><span class="linenos">182</span></a><span class="k">def</span> <span class="nf">LoadPlanarImages</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="LoadPlanarImages-183"><a href="#LoadPlanarImages-183"><span class="linenos">183</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Loads the image set for DIC analysis captured by a single camera.\n The folder directory is set in (Settings.ini, Planar, ImageFolder)&quot;&quot;&quot;</span>
</span><span id="LoadPlanarImages-184"><a href="#LoadPlanarImages-184"><span class="linenos">184</span></a>    <span class="n">operating_system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
</span><span id="LoadPlanarImages-185"><a href="#LoadPlanarImages-185"><span class="linenos">185</span></a>    <span class="n">current_working_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="LoadPlanarImages-186"><a href="#LoadPlanarImages-186"><span class="linenos">186</span></a>    
</span><span id="LoadPlanarImages-187"><a href="#LoadPlanarImages-187"><span class="linenos">187</span></a>    <span class="c1">#Linux (need to add macOS option, same as Linux ?)</span>
</span><span id="LoadPlanarImages-188"><a href="#LoadPlanarImages-188"><span class="linenos">188</span></a>    <span class="k">if</span> <span class="n">operating_system</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;Linux&#39;</span><span class="p">}:</span>
</span><span id="LoadPlanarImages-189"><a href="#LoadPlanarImages-189"><span class="linenos">189</span></a>        <span class="n">image_folder</span> <span class="o">=</span> <span class="s1">&#39;/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">])</span>
</span><span id="LoadPlanarImages-190"><a href="#LoadPlanarImages-190"><span class="linenos">190</span></a>    <span class="c1">#Windows</span>
</span><span id="LoadPlanarImages-191"><a href="#LoadPlanarImages-191"><span class="linenos">191</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="LoadPlanarImages-192"><a href="#LoadPlanarImages-192"><span class="linenos">192</span></a>        <span class="n">image_folder</span> <span class="o">=</span> <span class="s1">&#39;\</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">])</span>
</span><span id="LoadPlanarImages-193"><a href="#LoadPlanarImages-193"><span class="linenos">193</span></a>    <span class="c1">#location of images for DIC measurement</span>
</span><span id="LoadPlanarImages-194"><a href="#LoadPlanarImages-194"><span class="linenos">194</span></a>    <span class="n">image_location</span> <span class="o">=</span> <span class="n">current_working_directory</span> <span class="o">+</span> <span class="n">image_folder</span>
</span><span id="LoadPlanarImages-195"><a href="#LoadPlanarImages-195"><span class="linenos">195</span></a>    <span class="c1">#read images in directory</span>
</span><span id="LoadPlanarImages-196"><a href="#LoadPlanarImages-196"><span class="linenos">196</span></a>    <span class="n">image_set</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="LoadPlanarImages-197"><a href="#LoadPlanarImages-197"><span class="linenos">197</span></a>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_location</span><span class="p">):</span>    
</span><span id="LoadPlanarImages-198"><a href="#LoadPlanarImages-198"><span class="linenos">198</span></a>        <span class="n">image_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="LoadPlanarImages-199"><a href="#LoadPlanarImages-199"><span class="linenos">199</span></a>
</span><span id="LoadPlanarImages-200"><a href="#LoadPlanarImages-200"><span class="linenos">200</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Planar images loaded, image set:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="LoadPlanarImages-201"><a href="#LoadPlanarImages-201"><span class="linenos">201</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">image_set</span><span class="p">)</span>
</span><span id="LoadPlanarImages-202"><a href="#LoadPlanarImages-202"><span class="linenos">202</span></a>    <span class="k">return</span> <span class="n">image_set</span>
</span></pre></div>


            <div class="docstring"><p>Loads the image set for DIC analysis captured by a single camera.
The folder directory is set in (Settings.ini, Planar, ImageFolder)</p>
</div>


                </section>
                <section id="SubsetRelativeCoordinates">
                            <input id="SubsetRelativeCoordinates-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">SubsetRelativeCoordinates</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SubsetRelativeCoordinates-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SubsetRelativeCoordinates"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SubsetRelativeCoordinates-204"><a href="#SubsetRelativeCoordinates-204"><span class="linenos">204</span></a><span class="k">def</span> <span class="nf">SubsetRelativeCoordinates</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="SubsetRelativeCoordinates-205"><a href="#SubsetRelativeCoordinates-205"><span class="linenos">205</span></a>
</span><span id="SubsetRelativeCoordinates-206"><a href="#SubsetRelativeCoordinates-206"><span class="linenos">206</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates the sampling point relative coordinates in the subset, based on the subset size, which is set in (Settings.ini, Local, SubsetSize)&quot;&quot;&quot;</span>
</span><span id="SubsetRelativeCoordinates-207"><a href="#SubsetRelativeCoordinates-207"><span class="linenos">207</span></a>
</span><span id="SubsetRelativeCoordinates-208"><a href="#SubsetRelativeCoordinates-208"><span class="linenos">208</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">])</span>
</span><span id="SubsetRelativeCoordinates-209"><a href="#SubsetRelativeCoordinates-209"><span class="linenos">209</span></a>    <span class="c1">#relative/local coordinates of pixels within subset (the same for all subsets)</span>
</span><span id="SubsetRelativeCoordinates-210"><a href="#SubsetRelativeCoordinates-210"><span class="linenos">210</span></a>    <span class="p">[</span><span class="n">eta</span><span class="p">,</span> <span class="n">xsi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">sub_size</span><span class="p">),</span>
</span><span id="SubsetRelativeCoordinates-211"><a href="#SubsetRelativeCoordinates-211"><span class="linenos">211</span></a>                              <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">sub_size</span><span class="p">),</span>
</span><span id="SubsetRelativeCoordinates-212"><a href="#SubsetRelativeCoordinates-212"><span class="linenos">212</span></a>                              <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span> <span class="p">)</span>
</span><span id="SubsetRelativeCoordinates-213"><a href="#SubsetRelativeCoordinates-213"><span class="linenos">213</span></a>
</span><span id="SubsetRelativeCoordinates-214"><a href="#SubsetRelativeCoordinates-214"><span class="linenos">214</span></a>    <span class="c1">#flatten local coordinates to vectors</span>
</span><span id="SubsetRelativeCoordinates-215"><a href="#SubsetRelativeCoordinates-215"><span class="linenos">215</span></a>    <span class="n">xsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xsi</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="SubsetRelativeCoordinates-216"><a href="#SubsetRelativeCoordinates-216"><span class="linenos">216</span></a>    <span class="n">eta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eta</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="SubsetRelativeCoordinates-217"><a href="#SubsetRelativeCoordinates-217"><span class="linenos">217</span></a>
</span><span id="SubsetRelativeCoordinates-218"><a href="#SubsetRelativeCoordinates-218"><span class="linenos">218</span></a>    <span class="k">return</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span>
</span></pre></div>


            <div class="docstring"><p>Creates the sampling point relative coordinates in the subset, based on the subset size, which is set in (Settings.ini, Local, SubsetSize)</p>
</div>


                </section>
                <section id="PlanarDICLocal">
                            <input id="PlanarDICLocal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">PlanarDICLocal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">image_set</span>, </span><span class="param"><span class="n">ROI</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PlanarDICLocal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PlanarDICLocal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PlanarDICLocal-220"><a href="#PlanarDICLocal-220"><span class="linenos">220</span></a><span class="k">def</span> <span class="nf">PlanarDICLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">):</span>
</span><span id="PlanarDICLocal-221"><a href="#PlanarDICLocal-221"><span class="linenos">221</span></a><span class="c1">#------------------------------------------------------------------------------------</span>
</span><span id="PlanarDICLocal-222"><a href="#PlanarDICLocal-222"><span class="linenos">222</span></a>
</span><span id="PlanarDICLocal-223"><a href="#PlanarDICLocal-223"><span class="linenos">223</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform planar, local-DIC on an image set captured by a single camera.</span>
</span><span id="PlanarDICLocal-224"><a href="#PlanarDICLocal-224"><span class="linenos">224</span></a><span class="sd">    Further relevant settings include whether to import the measurement point coordinates (subset centres) set in, </span>
</span><span id="PlanarDICLocal-225"><a href="#PlanarDICLocal-225"><span class="linenos">225</span></a><span class="sd">    </span>
</span><span id="PlanarDICLocal-226"><a href="#PlanarDICLocal-226"><span class="linenos">226</span></a><span class="sd">    Parameters</span>
</span><span id="PlanarDICLocal-227"><a href="#PlanarDICLocal-227"><span class="linenos">227</span></a><span class="sd">    ----------</span>
</span><span id="PlanarDICLocal-228"><a href="#PlanarDICLocal-228"><span class="linenos">228</span></a><span class="sd">        settings[&#39;ReferenceStrategy&#39;] : Reference strategy used to correlate multiple images in an image series,</span>
</span><span id="PlanarDICLocal-229"><a href="#PlanarDICLocal-229"><span class="linenos">229</span></a><span class="sd">                                        to determine relative displacements. </span>
</span><span id="PlanarDICLocal-230"><a href="#PlanarDICLocal-230"><span class="linenos">230</span></a><span class="sd">                                        Parsed from: (Settings.ini, ImageReferencing, CorrelationReferenceStrategy)</span>
</span><span id="PlanarDICLocal-231"><a href="#PlanarDICLocal-231"><span class="linenos">231</span></a><span class="sd">        settings[&#39;MeasurementPoints&#39;] : Subset centre (measurement point) coordinates</span>
</span><span id="PlanarDICLocal-232"><a href="#PlanarDICLocal-232"><span class="linenos">232</span></a><span class="sd">                                        Can be imported from an external .csv file where the coordinates are predfined</span>
</span><span id="PlanarDICLocal-233"><a href="#PlanarDICLocal-233"><span class="linenos">233</span></a><span class="sd">                                        using an external program. Can be created by populating a rectangular ROI in the</span>
</span><span id="PlanarDICLocal-234"><a href="#PlanarDICLocal-234"><span class="linenos">234</span></a><span class="sd">                                        reference image (default option).</span>
</span><span id="PlanarDICLocal-235"><a href="#PlanarDICLocal-235"><span class="linenos">235</span></a><span class="sd">                                        Parsed from: i.(Settings.ini, Import, Local);</span>
</span><span id="PlanarDICLocal-236"><a href="#PlanarDICLocal-236"><span class="linenos">236</span></a><span class="sd">                                                     ii.(Settings.ini, Import, MeasurementPointsName)</span>
</span><span id="PlanarDICLocal-237"><a href="#PlanarDICLocal-237"><span class="linenos">237</span></a><span class="sd">        </span>
</span><span id="PlanarDICLocal-238"><a href="#PlanarDICLocal-238"><span class="linenos">238</span></a>
</span><span id="PlanarDICLocal-239"><a href="#PlanarDICLocal-239"><span class="linenos">239</span></a><span class="sd">    Returns</span>
</span><span id="PlanarDICLocal-240"><a href="#PlanarDICLocal-240"><span class="linenos">240</span></a><span class="sd">    -------</span>
</span><span id="PlanarDICLocal-241"><a href="#PlanarDICLocal-241"><span class="linenos">241</span></a><span class="sd">        coefficients : Subset deformation model coefficients</span>
</span><span id="PlanarDICLocal-242"><a href="#PlanarDICLocal-242"><span class="linenos">242</span></a>
</span><span id="PlanarDICLocal-243"><a href="#PlanarDICLocal-243"><span class="linenos">243</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="PlanarDICLocal-244"><a href="#PlanarDICLocal-244"><span class="linenos">244</span></a>
</span><span id="PlanarDICLocal-245"><a href="#PlanarDICLocal-245"><span class="linenos">245</span></a>    <span class="c1">#measurement point coordinates defined in datum image</span>
</span><span id="PlanarDICLocal-246"><a href="#PlanarDICLocal-246"><span class="linenos">246</span></a>    <span class="c1">#xsi, eta: local coordinates defined within subset(s)</span>
</span><span id="PlanarDICLocal-247"><a href="#PlanarDICLocal-247"><span class="linenos">247</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">}:</span>
</span><span id="PlanarDICLocal-248"><a href="#PlanarDICLocal-248"><span class="linenos">248</span></a>
</span><span id="PlanarDICLocal-249"><a href="#PlanarDICLocal-249"><span class="linenos">249</span></a>        <span class="c1">#load measurement point from external file</span>
</span><span id="PlanarDICLocal-250"><a href="#PlanarDICLocal-250"><span class="linenos">250</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImportMeasurementPointsFromExternal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="PlanarDICLocal-251"><a href="#PlanarDICLocal-251"><span class="linenos">251</span></a>            <span class="n">measurement_points_name</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPointsName&#39;</span><span class="p">]</span>
</span><span id="PlanarDICLocal-252"><a href="#PlanarDICLocal-252"><span class="linenos">252</span></a>            <span class="n">measurement_points</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">measurement_points_name</span><span class="p">),</span>
</span><span id="PlanarDICLocal-253"><a href="#PlanarDICLocal-253"><span class="linenos">253</span></a>                                          <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="PlanarDICLocal-254"><a href="#PlanarDICLocal-254"><span class="linenos">254</span></a>           
</span><span id="PlanarDICLocal-255"><a href="#PlanarDICLocal-255"><span class="linenos">255</span></a>        <span class="c1">#define measurement points using the settings specified in the config file </span>
</span><span id="PlanarDICLocal-256"><a href="#PlanarDICLocal-256"><span class="linenos">256</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImportMeasurementPointsFromExternal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="PlanarDICLocal-257"><a href="#PlanarDICLocal-257"><span class="linenos">257</span></a>            <span class="n">measurement_points</span> <span class="o">=</span> <span class="n">LocalMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="PlanarDICLocal-258"><a href="#PlanarDICLocal-258"><span class="linenos">258</span></a>            <span class="c1">#append the measurement points to the settings file</span>
</span><span id="PlanarDICLocal-259"><a href="#PlanarDICLocal-259"><span class="linenos">259</span></a>            <span class="c1">#temporary line of code to store measurement points for later triangulation of displacement coefficients</span>
</span><span id="PlanarDICLocal-260"><a href="#PlanarDICLocal-260"><span class="linenos">260</span></a>            <span class="c1">#np.savetxt(&quot;measurement_points.csv&quot;, measurement_points, delimiter = &quot;,&quot;)</span>
</span><span id="PlanarDICLocal-261"><a href="#PlanarDICLocal-261"><span class="linenos">261</span></a>    
</span><span id="PlanarDICLocal-262"><a href="#PlanarDICLocal-262"><span class="linenos">262</span></a>        <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">SubsetRelativeCoordinates</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="PlanarDICLocal-263"><a href="#PlanarDICLocal-263"><span class="linenos">263</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xsi</span>
</span><span id="PlanarDICLocal-264"><a href="#PlanarDICLocal-264"><span class="linenos">264</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eta</span>
</span><span id="PlanarDICLocal-265"><a href="#PlanarDICLocal-265"><span class="linenos">265</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">measurement_points</span>
</span><span id="PlanarDICLocal-266"><a href="#PlanarDICLocal-266"><span class="linenos">266</span></a>        
</span><span id="PlanarDICLocal-267"><a href="#PlanarDICLocal-267"><span class="linenos">267</span></a>        
</span><span id="PlanarDICLocal-268"><a href="#PlanarDICLocal-268"><span class="linenos">268</span></a>        <span class="c1">#save measurement point coordinates in datum image of left camera as reference</span>
</span><span id="PlanarDICLocal-269"><a href="#PlanarDICLocal-269"><span class="linenos">269</span></a>        <span class="c1">#for later use in cross correlation</span>
</span><span id="PlanarDICLocal-270"><a href="#PlanarDICLocal-270"><span class="linenos">270</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;StereoCurved&#39;</span><span class="p">,</span> <span class="s1">&#39;StereoPlanar&#39;</span><span class="p">}:</span>
</span><span id="PlanarDICLocal-271"><a href="#PlanarDICLocal-271"><span class="linenos">271</span></a>            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span>
</span><span id="PlanarDICLocal-272"><a href="#PlanarDICLocal-272"><span class="linenos">272</span></a>            <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ROI_L0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROI</span>
</span><span id="PlanarDICLocal-273"><a href="#PlanarDICLocal-273"><span class="linenos">273</span></a>
</span><span id="PlanarDICLocal-274"><a href="#PlanarDICLocal-274"><span class="linenos">274</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CorrelationReferenceStrategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Incremental&#39;</span><span class="p">:</span>
</span><span id="PlanarDICLocal-275"><a href="#PlanarDICLocal-275"><span class="linenos">275</span></a>        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">IncrementalLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="PlanarDICLocal-276"><a href="#PlanarDICLocal-276"><span class="linenos">276</span></a>
</span><span id="PlanarDICLocal-277"><a href="#PlanarDICLocal-277"><span class="linenos">277</span></a>    <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CorrelationReferenceStrategy&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Absolute&#39;</span><span class="p">:</span>
</span><span id="PlanarDICLocal-278"><a href="#PlanarDICLocal-278"><span class="linenos">278</span></a>        <span class="n">coefficients</span> <span class="o">=</span> <span class="n">AbsoluteReferencing</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="PlanarDICLocal-279"><a href="#PlanarDICLocal-279"><span class="linenos">279</span></a>
</span><span id="PlanarDICLocal-280"><a href="#PlanarDICLocal-280"><span class="linenos">280</span></a>    <span class="k">return</span> <span class="n">coefficients</span>
</span></pre></div>


            <div class="docstring"><p>Perform planar, local-DIC on an image set captured by a single camera.
Further relevant settings include whether to import the measurement point coordinates (subset centres) set in, </p>

<h2 id="parameters">Parameters</h2>

<pre><code>settings['ReferenceStrategy'] : Reference strategy used to correlate multiple images in an image series,
                                to determine relative displacements. 
                                Parsed from: (Settings.ini, ImageReferencing, CorrelationReferenceStrategy)
settings['MeasurementPoints'] : Subset centre (measurement point) coordinates
                                Can be imported from an external .csv file where the coordinates are predfined
                                using an external program. Can be created by populating a rectangular ROI in the
                                reference image (default option).
                                Parsed from: i.(Settings.ini, Import, Local);
                                             ii.(Settings.ini, Import, MeasurementPointsName)
</code></pre>

<h2 id="returns">Returns</h2>

<pre><code>coefficients : Subset deformation model coefficients
</code></pre>
</div>


                </section>
                <section id="StereoDICPlanar">
                            <input id="StereoDICPlanar-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">StereoDICPlanar</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">image_set_0</span>, </span><span class="param"><span class="n">image_set_1</span>, </span><span class="param"><span class="n">ROI_0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StereoDICPlanar-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StereoDICPlanar"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StereoDICPlanar-282"><a href="#StereoDICPlanar-282"><span class="linenos">282</span></a><span class="k">def</span> <span class="nf">StereoDICPlanar</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="n">ROI_0</span><span class="p">):</span>
</span><span id="StereoDICPlanar-283"><a href="#StereoDICPlanar-283"><span class="linenos">283</span></a>
</span><span id="StereoDICPlanar-284"><a href="#StereoDICPlanar-284"><span class="linenos">284</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Discretisation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Local&#39;</span><span class="p">:</span>
</span><span id="StereoDICPlanar-285"><a href="#StereoDICPlanar-285"><span class="linenos">285</span></a>        <span class="c1">#perform 2D-DIC on left camera image series</span>
</span><span id="StereoDICPlanar-286"><a href="#StereoDICPlanar-286"><span class="linenos">286</span></a>        <span class="n">coefficients_0</span> <span class="o">=</span> <span class="n">PlanarDICLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">ROI_0</span><span class="p">)</span>
</span><span id="StereoDICPlanar-287"><a href="#StereoDICPlanar-287"><span class="linenos">287</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">left camera image series correlation complete&#39;</span><span class="p">)</span>
</span><span id="StereoDICPlanar-288"><a href="#StereoDICPlanar-288"><span class="linenos">288</span></a>        <span class="c1">#right camera/ camera 1</span>
</span><span id="StereoDICPlanar-289"><a href="#StereoDICPlanar-289"><span class="linenos">289</span></a>        <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="StereoDICPlanar-290"><a href="#StereoDICPlanar-290"><span class="linenos">290</span></a>        <span class="n">ROI_1</span> <span class="o">=</span> <span class="n">MatchStereoViews</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">)</span>
</span><span id="StereoDICPlanar-291"><a href="#StereoDICPlanar-291"><span class="linenos">291</span></a>        <span class="n">coefficients_1</span> <span class="o">=</span> <span class="n">PlanarDICLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="n">ROI_1</span><span class="p">)</span>
</span><span id="StereoDICPlanar-292"><a href="#StereoDICPlanar-292"><span class="linenos">292</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">right camera image series correlation complete&#39;</span><span class="p">)</span>
</span><span id="StereoDICPlanar-293"><a href="#StereoDICPlanar-293"><span class="linenos">293</span></a>        <span class="c1">#displacements = TriangulateDisplacements(settings, coefficients_0, coefficients_1)</span>
</span><span id="StereoDICPlanar-294"><a href="#StereoDICPlanar-294"><span class="linenos">294</span></a>         
</span><span id="StereoDICPlanar-295"><a href="#StereoDICPlanar-295"><span class="linenos">295</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="StereoDICPlanar-296"><a href="#StereoDICPlanar-296"><span class="linenos">296</span></a>        <span class="c1">#global</span>
</span><span id="StereoDICPlanar-297"><a href="#StereoDICPlanar-297"><span class="linenos">297</span></a>        <span class="k">pass</span>
</span><span id="StereoDICPlanar-298"><a href="#StereoDICPlanar-298"><span class="linenos">298</span></a>
</span><span id="StereoDICPlanar-299"><a href="#StereoDICPlanar-299"><span class="linenos">299</span></a>    <span class="c1">#store output data in a dictionary</span>
</span><span id="StereoDICPlanar-300"><a href="#StereoDICPlanar-300"><span class="linenos">300</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span><span id="StereoDICPlanar-301"><a href="#StereoDICPlanar-301"><span class="linenos">301</span></a>
</span><span id="StereoDICPlanar-302"><a href="#StereoDICPlanar-302"><span class="linenos">302</span></a>    <span class="c1">#store DIC displacement measurements to data dictionary</span>
</span><span id="StereoDICPlanar-303"><a href="#StereoDICPlanar-303"><span class="linenos">303</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="StereoDICPlanar-304"><a href="#StereoDICPlanar-304"><span class="linenos">304</span></a>
</span><span id="StereoDICPlanar-305"><a href="#StereoDICPlanar-305"><span class="linenos">305</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
</span><span id="StereoDICPlanar-306"><a href="#StereoDICPlanar-306"><span class="linenos">306</span></a>                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_0</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="StereoDICPlanar-307"><a href="#StereoDICPlanar-307"><span class="linenos">307</span></a>        
</span><span id="StereoDICPlanar-308"><a href="#StereoDICPlanar-308"><span class="linenos">308</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_R&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
</span><span id="StereoDICPlanar-309"><a href="#StereoDICPlanar-309"><span class="linenos">309</span></a>                                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_1</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="StereoDICPlanar-310"><a href="#StereoDICPlanar-310"><span class="linenos">310</span></a>    
</span><span id="StereoDICPlanar-311"><a href="#StereoDICPlanar-311"><span class="linenos">311</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="StereoDICPlanar-312"><a href="#StereoDICPlanar-312"><span class="linenos">312</span></a>
</span><span id="StereoDICPlanar-313"><a href="#StereoDICPlanar-313"><span class="linenos">313</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
</span><span id="StereoDICPlanar-314"><a href="#StereoDICPlanar-314"><span class="linenos">314</span></a>                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_0</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="StereoDICPlanar-315"><a href="#StereoDICPlanar-315"><span class="linenos">315</span></a>        
</span><span id="StereoDICPlanar-316"><a href="#StereoDICPlanar-316"><span class="linenos">316</span></a>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_R&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]),</span>
</span><span id="StereoDICPlanar-317"><a href="#StereoDICPlanar-317"><span class="linenos">317</span></a>                                 <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">coefficients_1</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]])))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="StereoDICPlanar-318"><a href="#StereoDICPlanar-318"><span class="linenos">318</span></a>
</span><span id="StereoDICPlanar-319"><a href="#StereoDICPlanar-319"><span class="linenos">319</span></a>    <span class="k">return</span> <span class="n">coefficients_0</span><span class="p">,</span> <span class="n">coefficients_1</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data</span>
</span></pre></div>


    

                </section>
                <section id="StereoDICCurved">
                            <input id="StereoDICCurved-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">StereoDICCurved</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StereoDICCurved-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StereoDICCurved"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StereoDICCurved-321"><a href="#StereoDICCurved-321"><span class="linenos">321</span></a><span class="k">def</span> <span class="nf">StereoDICCurved</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="StereoDICCurved-322"><a href="#StereoDICCurved-322"><span class="linenos">322</span></a>
</span><span id="StereoDICCurved-323"><a href="#StereoDICCurved-323"><span class="linenos">323</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="SIFTquick">
                            <input id="SIFTquick-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">SIFTquick</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">F_ROI_padded</span>, </span><span class="param"><span class="n">G</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SIFTquick-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SIFTquick"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SIFTquick-325"><a href="#SIFTquick-325"><span class="linenos">325</span></a><span class="k">def</span> <span class="nf">SIFTquick</span><span class="p">(</span><span class="n">F_ROI_padded</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
</span><span id="SIFTquick-326"><a href="#SIFTquick-326"><span class="linenos">326</span></a>
</span><span id="SIFTquick-327"><a href="#SIFTquick-327"><span class="linenos">327</span></a>    <span class="c1">#keypoint matching/feature detection between reference images of from both cameras</span>
</span><span id="SIFTquick-328"><a href="#SIFTquick-328"><span class="linenos">328</span></a>    <span class="c1">#create SIFT feature detector object</span>
</span><span id="SIFTquick-329"><a href="#SIFTquick-329"><span class="linenos">329</span></a>    <span class="n">sift</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">xfeatures2d</span><span class="o">.</span><span class="n">SIFT_create</span><span class="p">()</span>
</span><span id="SIFTquick-330"><a href="#SIFTquick-330"><span class="linenos">330</span></a>    <span class="c1">#find keypoints and descriptors in both images</span>
</span><span id="SIFTquick-331"><a href="#SIFTquick-331"><span class="linenos">331</span></a>    <span class="n">kp1</span><span class="p">,</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">F_ROI_padded</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="SIFTquick-332"><a href="#SIFTquick-332"><span class="linenos">332</span></a>    <span class="n">kp2</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">sift</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="SIFTquick-333"><a href="#SIFTquick-333"><span class="linenos">333</span></a>
</span><span id="SIFTquick-334"><a href="#SIFTquick-334"><span class="linenos">334</span></a>    <span class="c1">#cast keypoints to numpy arrays for ease of use</span>
</span><span id="SIFTquick-335"><a href="#SIFTquick-335"><span class="linenos">335</span></a>    <span class="c1">#F keypoints x and y coordinates</span>
</span><span id="SIFTquick-336"><a href="#SIFTquick-336"><span class="linenos">336</span></a>    <span class="n">N_xk1</span> <span class="o">=</span> <span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SIFTquick-337"><a href="#SIFTquick-337"><span class="linenos">337</span></a>    <span class="n">xk1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_xk1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="SIFTquick-338"><a href="#SIFTquick-338"><span class="linenos">338</span></a>    <span class="n">yk1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_xk1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="SIFTquick-339"><a href="#SIFTquick-339"><span class="linenos">339</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_xk1</span><span class="p">):</span>
</span><span id="SIFTquick-340"><a href="#SIFTquick-340"><span class="linenos">340</span></a>        <span class="n">xk1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">kp1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SIFTquick-341"><a href="#SIFTquick-341"><span class="linenos">341</span></a>        <span class="n">yk1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">kp1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SIFTquick-342"><a href="#SIFTquick-342"><span class="linenos">342</span></a>    <span class="n">Xk1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xk1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">yk1</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="SIFTquick-343"><a href="#SIFTquick-343"><span class="linenos">343</span></a>
</span><span id="SIFTquick-344"><a href="#SIFTquick-344"><span class="linenos">344</span></a>    <span class="c1">#F1 keypoints x and y coordinates</span>
</span><span id="SIFTquick-345"><a href="#SIFTquick-345"><span class="linenos">345</span></a>    <span class="n">N_xk2</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SIFTquick-346"><a href="#SIFTquick-346"><span class="linenos">346</span></a>    <span class="n">xk2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_xk2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="SIFTquick-347"><a href="#SIFTquick-347"><span class="linenos">347</span></a>    <span class="n">yk2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N_xk2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="SIFTquick-348"><a href="#SIFTquick-348"><span class="linenos">348</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_xk2</span><span class="p">):</span>
</span><span id="SIFTquick-349"><a href="#SIFTquick-349"><span class="linenos">349</span></a>        <span class="n">xk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">kp2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SIFTquick-350"><a href="#SIFTquick-350"><span class="linenos">350</span></a>        <span class="n">yk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="n">kp2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="SIFTquick-351"><a href="#SIFTquick-351"><span class="linenos">351</span></a>    <span class="n">Xk2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xk2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">yk2</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="SIFTquick-352"><a href="#SIFTquick-352"><span class="linenos">352</span></a>
</span><span id="SIFTquick-353"><a href="#SIFTquick-353"><span class="linenos">353</span></a>    <span class="k">return</span> <span class="p">[</span><span class="n">Xk1</span><span class="p">,</span> <span class="n">Xk2</span><span class="p">],</span> <span class="p">[</span><span class="n">kp1</span><span class="p">,</span> <span class="n">kp2</span><span class="p">],</span> <span class="p">[</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="KeypointMatchRobust">
                            <input id="KeypointMatchRobust-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">KeypointMatchRobust</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Xk</span>, </span><span class="param"><span class="n">d</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="KeypointMatchRobust-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#KeypointMatchRobust"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="KeypointMatchRobust-355"><a href="#KeypointMatchRobust-355"><span class="linenos">355</span></a><span class="k">def</span> <span class="nf">KeypointMatchRobust</span><span class="p">(</span><span class="n">Xk</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="KeypointMatchRobust-356"><a href="#KeypointMatchRobust-356"><span class="linenos">356</span></a>
</span><span id="KeypointMatchRobust-357"><a href="#KeypointMatchRobust-357"><span class="linenos">357</span></a>    <span class="c1">#find matches between two images with knnmatch and identify good matches</span>
</span><span id="KeypointMatchRobust-358"><a href="#KeypointMatchRobust-358"><span class="linenos">358</span></a>    <span class="n">bf</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span>
</span><span id="KeypointMatchRobust-359"><a href="#KeypointMatchRobust-359"><span class="linenos">359</span></a>    <span class="c1">#store the indices of the matches in F and G</span>
</span><span id="KeypointMatchRobust-360"><a href="#KeypointMatchRobust-360"><span class="linenos">360</span></a>    <span class="n">matches</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="KeypointMatchRobust-361"><a href="#KeypointMatchRobust-361"><span class="linenos">361</span></a>    <span class="c1">#only keep good matches using condition inisde for loop</span>
</span><span id="KeypointMatchRobust-362"><a href="#KeypointMatchRobust-362"><span class="linenos">362</span></a>    <span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="KeypointMatchRobust-363"><a href="#KeypointMatchRobust-363"><span class="linenos">363</span></a>    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
</span><span id="KeypointMatchRobust-364"><a href="#KeypointMatchRobust-364"><span class="linenos">364</span></a>        <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">:</span>
</span><span id="KeypointMatchRobust-365"><a href="#KeypointMatchRobust-365"><span class="linenos">365</span></a>            <span class="n">good_matches</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m</span><span class="p">])</span>
</span><span id="KeypointMatchRobust-366"><a href="#KeypointMatchRobust-366"><span class="linenos">366</span></a>
</span><span id="KeypointMatchRobust-367"><a href="#KeypointMatchRobust-367"><span class="linenos">367</span></a>    <span class="c1">#cast good match indices to numpy array</span>
</span><span id="KeypointMatchRobust-368"><a href="#KeypointMatchRobust-368"><span class="linenos">368</span></a>    <span class="n">n_matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">good_matches</span><span class="p">)</span>
</span><span id="KeypointMatchRobust-369"><a href="#KeypointMatchRobust-369"><span class="linenos">369</span></a>    <span class="n">goood_matches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_matches</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
</span><span id="KeypointMatchRobust-370"><a href="#KeypointMatchRobust-370"><span class="linenos">370</span></a>    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_matches</span><span class="p">):</span>
</span><span id="KeypointMatchRobust-371"><a href="#KeypointMatchRobust-371"><span class="linenos">371</span></a>        <span class="c1">#F descriptors</span>
</span><span id="KeypointMatchRobust-372"><a href="#KeypointMatchRobust-372"><span class="linenos">372</span></a>        <span class="n">goood_matches</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_matches</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">queryIdx</span>
</span><span id="KeypointMatchRobust-373"><a href="#KeypointMatchRobust-373"><span class="linenos">373</span></a>        <span class="c1">#G descriptors</span>
</span><span id="KeypointMatchRobust-374"><a href="#KeypointMatchRobust-374"><span class="linenos">374</span></a>        <span class="n">goood_matches</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_matches</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trainIdx</span>
</span><span id="KeypointMatchRobust-375"><a href="#KeypointMatchRobust-375"><span class="linenos">375</span></a>
</span><span id="KeypointMatchRobust-376"><a href="#KeypointMatchRobust-376"><span class="linenos">376</span></a>    <span class="c1">#remove bad matches from feature detection results</span>
</span><span id="KeypointMatchRobust-377"><a href="#KeypointMatchRobust-377"><span class="linenos">377</span></a>    <span class="n">Xk1</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">goood_matches</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
</span><span id="KeypointMatchRobust-378"><a href="#KeypointMatchRobust-378"><span class="linenos">378</span></a>    <span class="n">Xk2</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">goood_matches</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
</span><span id="KeypointMatchRobust-379"><a href="#KeypointMatchRobust-379"><span class="linenos">379</span></a>
</span><span id="KeypointMatchRobust-380"><a href="#KeypointMatchRobust-380"><span class="linenos">380</span></a>    <span class="k">return</span> <span class="p">[</span><span class="n">Xk1</span><span class="p">,</span> <span class="n">Xk2</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="kNNSubCentres">
                            <input id="kNNSubCentres-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">kNNSubCentres</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">n_subsets</span>, </span><span class="param"><span class="n">Xk</span>, </span><span class="param"><span class="n">k</span><span class="o">=</span><span class="mi">8</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="kNNSubCentres-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#kNNSubCentres"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="kNNSubCentres-382"><a href="#kNNSubCentres-382"><span class="linenos">382</span></a><span class="k">def</span> <span class="nf">kNNSubCentres</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">8</span><span class="p">):</span>
</span><span id="kNNSubCentres-383"><a href="#kNNSubCentres-383"><span class="linenos">383</span></a>
</span><span id="kNNSubCentres-384"><a href="#kNNSubCentres-384"><span class="linenos">384</span></a>    <span class="c1">#measurement point coordinates of reference image</span>
</span><span id="kNNSubCentres-385"><a href="#kNNSubCentres-385"><span class="linenos">385</span></a>    <span class="c1">#image series from single camera (affine fit)</span>
</span><span id="kNNSubCentres-386"><a href="#kNNSubCentres-386"><span class="linenos">386</span></a>    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
</span><span id="kNNSubCentres-387"><a href="#kNNSubCentres-387"><span class="linenos">387</span></a>        <span class="n">Xo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span>
</span><span id="kNNSubCentres-388"><a href="#kNNSubCentres-388"><span class="linenos">388</span></a>
</span><span id="kNNSubCentres-389"><a href="#kNNSubCentres-389"><span class="linenos">389</span></a>    <span class="c1">#cross correlation of left and right cameras (projective transformation fit)</span>
</span><span id="kNNSubCentres-390"><a href="#kNNSubCentres-390"><span class="linenos">390</span></a>    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
</span><span id="kNNSubCentres-391"><a href="#kNNSubCentres-391"><span class="linenos">391</span></a>        <span class="n">Xo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">]</span>
</span><span id="kNNSubCentres-392"><a href="#kNNSubCentres-392"><span class="linenos">392</span></a>
</span><span id="kNNSubCentres-393"><a href="#kNNSubCentres-393"><span class="linenos">393</span></a>    <span class="c1">#identify K nearest keypoints(neighbours) to each subset centre, respectively</span>
</span><span id="kNNSubCentres-394"><a href="#kNNSubCentres-394"><span class="linenos">394</span></a>    <span class="n">kNN_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_subsets</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
</span><span id="kNNSubCentres-395"><a href="#kNNSubCentres-395"><span class="linenos">395</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="kNNSubCentres-396"><a href="#kNNSubCentres-396"><span class="linenos">396</span></a>        <span class="c1">#SSD between subset centre i and all keypoints</span>
</span><span id="kNNSubCentres-397"><a href="#kNNSubCentres-397"><span class="linenos">397</span></a>        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Xo1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Xo1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="kNNSubCentres-398"><a href="#kNNSubCentres-398"><span class="linenos">398</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="kNNSubCentres-399"><a href="#kNNSubCentres-399"><span class="linenos">399</span></a>        <span class="c1">#k minimum SSD between subset centre i and all keypoints</span>
</span><span id="kNNSubCentres-400"><a href="#kNNSubCentres-400"><span class="linenos">400</span></a>        <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">k</span><span class="p">]</span>
</span><span id="kNNSubCentres-401"><a href="#kNNSubCentres-401"><span class="linenos">401</span></a>
</span><span id="kNNSubCentres-402"><a href="#kNNSubCentres-402"><span class="linenos">402</span></a>    <span class="k">return</span> <span class="n">kNN_indices</span>
</span></pre></div>


    

                </section>
                <section id="AffineFitKeypointsRANSAC">
                            <input id="AffineFitKeypointsRANSAC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">AffineFitKeypointsRANSAC</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">n_subsets</span>, </span><span class="param"><span class="n">Xk</span>, </span><span class="param"><span class="n">kNN_indices</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AffineFitKeypointsRANSAC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AffineFitKeypointsRANSAC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AffineFitKeypointsRANSAC-404"><a href="#AffineFitKeypointsRANSAC-404"><span class="linenos">404</span></a><span class="k">def</span> <span class="nf">AffineFitKeypointsRANSAC</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">kNN_indices</span><span class="p">):</span>
</span><span id="AffineFitKeypointsRANSAC-405"><a href="#AffineFitKeypointsRANSAC-405"><span class="linenos">405</span></a>
</span><span id="AffineFitKeypointsRANSAC-406"><a href="#AffineFitKeypointsRANSAC-406"><span class="linenos">406</span></a>    <span class="c1">#storage array for relative displacement between matched</span>
</span><span id="AffineFitKeypointsRANSAC-407"><a href="#AffineFitKeypointsRANSAC-407"><span class="linenos">407</span></a>    <span class="c1">#measurement points in reference and deformed image</span>
</span><span id="AffineFitKeypointsRANSAC-408"><a href="#AffineFitKeypointsRANSAC-408"><span class="linenos">408</span></a>    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">])</span>
</span><span id="AffineFitKeypointsRANSAC-409"><a href="#AffineFitKeypointsRANSAC-409"><span class="linenos">409</span></a>
</span><span id="AffineFitKeypointsRANSAC-410"><a href="#AffineFitKeypointsRANSAC-410"><span class="linenos">410</span></a>    <span class="k">for</span> <span class="n">i_subset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="AffineFitKeypointsRANSAC-411"><a href="#AffineFitKeypointsRANSAC-411"><span class="linenos">411</span></a>        <span class="c1">#measurement point coordinates in reference image</span>
</span><span id="AffineFitKeypointsRANSAC-412"><a href="#AffineFitKeypointsRANSAC-412"><span class="linenos">412</span></a>        <span class="n">xo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="AffineFitKeypointsRANSAC-413"><a href="#AffineFitKeypointsRANSAC-413"><span class="linenos">413</span></a>        <span class="n">yo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="AffineFitKeypointsRANSAC-414"><a href="#AffineFitKeypointsRANSAC-414"><span class="linenos">414</span></a>
</span><span id="AffineFitKeypointsRANSAC-415"><a href="#AffineFitKeypointsRANSAC-415"><span class="linenos">415</span></a>        <span class="c1">#find kNN keypoint coordinates for current subset</span>
</span><span id="AffineFitKeypointsRANSAC-416"><a href="#AffineFitKeypointsRANSAC-416"><span class="linenos">416</span></a>        <span class="n">xkp1</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i_subset</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>
</span><span id="AffineFitKeypointsRANSAC-417"><a href="#AffineFitKeypointsRANSAC-417"><span class="linenos">417</span></a>        <span class="n">xkp2</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i_subset</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>
</span><span id="AffineFitKeypointsRANSAC-418"><a href="#AffineFitKeypointsRANSAC-418"><span class="linenos">418</span></a>        <span class="n">model_robust</span><span class="p">,</span> <span class="n">inliers</span> <span class="o">=</span> <span class="n">ransac</span><span class="p">((</span><span class="n">xkp1</span><span class="p">,</span> <span class="n">xkp2</span><span class="p">),</span> <span class="n">AffineTransform</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span><span id="AffineFitKeypointsRANSAC-419"><a href="#AffineFitKeypointsRANSAC-419"><span class="linenos">419</span></a>                                        <span class="n">residual_threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="AffineFitKeypointsRANSAC-420"><a href="#AffineFitKeypointsRANSAC-420"><span class="linenos">420</span></a>        
</span><span id="AffineFitKeypointsRANSAC-421"><a href="#AffineFitKeypointsRANSAC-421"><span class="linenos">421</span></a>        <span class="c1">#affine transformation homography coefficients</span>
</span><span id="AffineFitKeypointsRANSAC-422"><a href="#AffineFitKeypointsRANSAC-422"><span class="linenos">422</span></a>        <span class="n">h11</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
</span><span id="AffineFitKeypointsRANSAC-423"><a href="#AffineFitKeypointsRANSAC-423"><span class="linenos">423</span></a>        <span class="n">h12</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AffineFitKeypointsRANSAC-424"><a href="#AffineFitKeypointsRANSAC-424"><span class="linenos">424</span></a>        <span class="n">h13</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="AffineFitKeypointsRANSAC-425"><a href="#AffineFitKeypointsRANSAC-425"><span class="linenos">425</span></a>        <span class="n">h21</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AffineFitKeypointsRANSAC-426"><a href="#AffineFitKeypointsRANSAC-426"><span class="linenos">426</span></a>        <span class="n">h22</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AffineFitKeypointsRANSAC-427"><a href="#AffineFitKeypointsRANSAC-427"><span class="linenos">427</span></a>        <span class="n">h23</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="AffineFitKeypointsRANSAC-428"><a href="#AffineFitKeypointsRANSAC-428"><span class="linenos">428</span></a>        
</span><span id="AffineFitKeypointsRANSAC-429"><a href="#AffineFitKeypointsRANSAC-429"><span class="linenos">429</span></a>        <span class="c1">#coordinates of measurement points in the deformed image</span>
</span><span id="AffineFitKeypointsRANSAC-430"><a href="#AffineFitKeypointsRANSAC-430"><span class="linenos">430</span></a>        <span class="n">xo2</span> <span class="o">=</span> <span class="n">h11</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h12</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h13</span>
</span><span id="AffineFitKeypointsRANSAC-431"><a href="#AffineFitKeypointsRANSAC-431"><span class="linenos">431</span></a>        <span class="n">yo2</span> <span class="o">=</span> <span class="n">h21</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h22</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h23</span>
</span><span id="AffineFitKeypointsRANSAC-432"><a href="#AffineFitKeypointsRANSAC-432"><span class="linenos">432</span></a>
</span><span id="AffineFitKeypointsRANSAC-433"><a href="#AffineFitKeypointsRANSAC-433"><span class="linenos">433</span></a>        <span class="c1">#relative displacement between measurement points in reference and</span>
</span><span id="AffineFitKeypointsRANSAC-434"><a href="#AffineFitKeypointsRANSAC-434"><span class="linenos">434</span></a>        <span class="c1">#deformed image</span>
</span><span id="AffineFitKeypointsRANSAC-435"><a href="#AffineFitKeypointsRANSAC-435"><span class="linenos">435</span></a>        <span class="c1">#(note that the coordinate systems of the reference and deformed images</span>
</span><span id="AffineFitKeypointsRANSAC-436"><a href="#AffineFitKeypointsRANSAC-436"><span class="linenos">436</span></a>        <span class="c1">#are identical - this implies that we can find relative displacements</span>
</span><span id="AffineFitKeypointsRANSAC-437"><a href="#AffineFitKeypointsRANSAC-437"><span class="linenos">437</span></a>        <span class="c1">#of the measurement points between two images using a single coordinate frame)</span>
</span><span id="AffineFitKeypointsRANSAC-438"><a href="#AffineFitKeypointsRANSAC-438"><span class="linenos">438</span></a>
</span><span id="AffineFitKeypointsRANSAC-439"><a href="#AffineFitKeypointsRANSAC-439"><span class="linenos">439</span></a>        <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xo2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">xo1</span><span class="p">,</span>
</span><span id="AffineFitKeypointsRANSAC-440"><a href="#AffineFitKeypointsRANSAC-440"><span class="linenos">440</span></a>                                            <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yo2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">yo1</span> <span class="p">]</span>
</span><span id="AffineFitKeypointsRANSAC-441"><a href="#AffineFitKeypointsRANSAC-441"><span class="linenos">441</span></a>        
</span><span id="AffineFitKeypointsRANSAC-442"><a href="#AffineFitKeypointsRANSAC-442"><span class="linenos">442</span></a>    <span class="k">return</span> <span class="n">U</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">U</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span></pre></div>


    

                </section>
                <section id="KPMatchMeasurementPoints">
                            <input id="KPMatchMeasurementPoints-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">KPMatchMeasurementPoints</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">n_subsets</span>, </span><span class="param"><span class="n">F_ROI_padded</span>, </span><span class="param"><span class="n">G</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="KPMatchMeasurementPoints-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#KPMatchMeasurementPoints"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="KPMatchMeasurementPoints-444"><a href="#KPMatchMeasurementPoints-444"><span class="linenos">444</span></a><span class="k">def</span> <span class="nf">KPMatchMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">F_ROI_padded</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
</span><span id="KPMatchMeasurementPoints-445"><a href="#KPMatchMeasurementPoints-445"><span class="linenos">445</span></a>    
</span><span id="KPMatchMeasurementPoints-446"><a href="#KPMatchMeasurementPoints-446"><span class="linenos">446</span></a>    <span class="c1">#keypoint coordinates, keypoint objects, descriptors</span>
</span><span id="KPMatchMeasurementPoints-447"><a href="#KPMatchMeasurementPoints-447"><span class="linenos">447</span></a>    <span class="n">Xk</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">SIFTquick</span><span class="p">(</span><span class="n">F_ROI_padded</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
</span><span id="KPMatchMeasurementPoints-448"><a href="#KPMatchMeasurementPoints-448"><span class="linenos">448</span></a>    <span class="c1">#robust matching of keypoints between images</span>
</span><span id="KPMatchMeasurementPoints-449"><a href="#KPMatchMeasurementPoints-449"><span class="linenos">449</span></a>    <span class="n">Xk</span> <span class="o">=</span> <span class="n">KeypointMatchRobust</span><span class="p">(</span><span class="n">Xk</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="KPMatchMeasurementPoints-450"><a href="#KPMatchMeasurementPoints-450"><span class="linenos">450</span></a>    <span class="c1">#find k nearest keypoints (neighbours) to each subset centre</span>
</span><span id="KPMatchMeasurementPoints-451"><a href="#KPMatchMeasurementPoints-451"><span class="linenos">451</span></a>    <span class="n">kNN_indices</span> <span class="o">=</span> <span class="n">kNNSubCentres</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">)</span>
</span><span id="KPMatchMeasurementPoints-452"><a href="#KPMatchMeasurementPoints-452"><span class="linenos">452</span></a>    <span class="c1">#find measurementpoints defined in reference image in the</span>
</span><span id="KPMatchMeasurementPoints-453"><a href="#KPMatchMeasurementPoints-453"><span class="linenos">453</span></a>    <span class="c1">#deformed image and estimate deformation as displacements</span>
</span><span id="KPMatchMeasurementPoints-454"><a href="#KPMatchMeasurementPoints-454"><span class="linenos">454</span></a>    <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">AffineFitKeypointsRANSAC</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">kNN_indices</span><span class="p">)</span>
</span><span id="KPMatchMeasurementPoints-455"><a href="#KPMatchMeasurementPoints-455"><span class="linenos">455</span></a>
</span><span id="KPMatchMeasurementPoints-456"><a href="#KPMatchMeasurementPoints-456"><span class="linenos">456</span></a>    <span class="k">return</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span>
</span></pre></div>


    

                </section>
                <section id="ProjectiveFitKeypointsRANSAC">
                            <input id="ProjectiveFitKeypointsRANSAC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ProjectiveFitKeypointsRANSAC</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">n_subsets</span>, </span><span class="param"><span class="n">Xk</span>, </span><span class="param"><span class="n">kNN_indices</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ProjectiveFitKeypointsRANSAC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProjectiveFitKeypointsRANSAC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProjectiveFitKeypointsRANSAC-458"><a href="#ProjectiveFitKeypointsRANSAC-458"><span class="linenos">458</span></a><span class="k">def</span> <span class="nf">ProjectiveFitKeypointsRANSAC</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">kNN_indices</span><span class="p">):</span>
</span><span id="ProjectiveFitKeypointsRANSAC-459"><a href="#ProjectiveFitKeypointsRANSAC-459"><span class="linenos">459</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-460"><a href="#ProjectiveFitKeypointsRANSAC-460"><span class="linenos">460</span></a>    <span class="c1">#storage array for relative displacement between matched</span>
</span><span id="ProjectiveFitKeypointsRANSAC-461"><a href="#ProjectiveFitKeypointsRANSAC-461"><span class="linenos">461</span></a>    <span class="c1">#measurement points in reference and deformed image</span>
</span><span id="ProjectiveFitKeypointsRANSAC-462"><a href="#ProjectiveFitKeypointsRANSAC-462"><span class="linenos">462</span></a>    <span class="n">Xo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">])</span>
</span><span id="ProjectiveFitKeypointsRANSAC-463"><a href="#ProjectiveFitKeypointsRANSAC-463"><span class="linenos">463</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-464"><a href="#ProjectiveFitKeypointsRANSAC-464"><span class="linenos">464</span></a>    <span class="k">for</span> <span class="n">i_subset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="ProjectiveFitKeypointsRANSAC-465"><a href="#ProjectiveFitKeypointsRANSAC-465"><span class="linenos">465</span></a>        <span class="c1">#measurement point coordinates in reference image</span>
</span><span id="ProjectiveFitKeypointsRANSAC-466"><a href="#ProjectiveFitKeypointsRANSAC-466"><span class="linenos">466</span></a>        <span class="n">xo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-467"><a href="#ProjectiveFitKeypointsRANSAC-467"><span class="linenos">467</span></a>        <span class="n">yo1</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-468"><a href="#ProjectiveFitKeypointsRANSAC-468"><span class="linenos">468</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-469"><a href="#ProjectiveFitKeypointsRANSAC-469"><span class="linenos">469</span></a>        <span class="c1">#find kNN keypoint coordinates for current subset</span>
</span><span id="ProjectiveFitKeypointsRANSAC-470"><a href="#ProjectiveFitKeypointsRANSAC-470"><span class="linenos">470</span></a>        <span class="n">xkp1</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i_subset</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>
</span><span id="ProjectiveFitKeypointsRANSAC-471"><a href="#ProjectiveFitKeypointsRANSAC-471"><span class="linenos">471</span></a>        <span class="n">xkp2</span> <span class="o">=</span> <span class="n">Xk</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="n">kNN_indices</span><span class="p">[</span><span class="n">i_subset</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span>
</span><span id="ProjectiveFitKeypointsRANSAC-472"><a href="#ProjectiveFitKeypointsRANSAC-472"><span class="linenos">472</span></a>        <span class="n">model_robust</span><span class="p">,</span> <span class="n">inliers</span> <span class="o">=</span> <span class="n">ransac</span><span class="p">((</span><span class="n">xkp1</span><span class="p">,</span> <span class="n">xkp2</span><span class="p">),</span> <span class="n">ProjectiveTransform</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
</span><span id="ProjectiveFitKeypointsRANSAC-473"><a href="#ProjectiveFitKeypointsRANSAC-473"><span class="linenos">473</span></a>                                        <span class="n">residual_threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span><span id="ProjectiveFitKeypointsRANSAC-474"><a href="#ProjectiveFitKeypointsRANSAC-474"><span class="linenos">474</span></a>        
</span><span id="ProjectiveFitKeypointsRANSAC-475"><a href="#ProjectiveFitKeypointsRANSAC-475"><span class="linenos">475</span></a>        <span class="c1">#projective transformation homography coefficients</span>
</span><span id="ProjectiveFitKeypointsRANSAC-476"><a href="#ProjectiveFitKeypointsRANSAC-476"><span class="linenos">476</span></a>        <span class="n">h11</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
</span><span id="ProjectiveFitKeypointsRANSAC-477"><a href="#ProjectiveFitKeypointsRANSAC-477"><span class="linenos">477</span></a>        <span class="n">h12</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-478"><a href="#ProjectiveFitKeypointsRANSAC-478"><span class="linenos">478</span></a>        <span class="n">h13</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-479"><a href="#ProjectiveFitKeypointsRANSAC-479"><span class="linenos">479</span></a>        <span class="n">h21</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-480"><a href="#ProjectiveFitKeypointsRANSAC-480"><span class="linenos">480</span></a>        <span class="n">h22</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-481"><a href="#ProjectiveFitKeypointsRANSAC-481"><span class="linenos">481</span></a>        <span class="n">h23</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-482"><a href="#ProjectiveFitKeypointsRANSAC-482"><span class="linenos">482</span></a>        <span class="n">h31</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-483"><a href="#ProjectiveFitKeypointsRANSAC-483"><span class="linenos">483</span></a>        <span class="n">h32</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-484"><a href="#ProjectiveFitKeypointsRANSAC-484"><span class="linenos">484</span></a>        <span class="n">h33</span> <span class="o">=</span> <span class="n">model_robust</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-485"><a href="#ProjectiveFitKeypointsRANSAC-485"><span class="linenos">485</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-486"><a href="#ProjectiveFitKeypointsRANSAC-486"><span class="linenos">486</span></a>        <span class="c1">#coordinates of measurement points in deformed image</span>
</span><span id="ProjectiveFitKeypointsRANSAC-487"><a href="#ProjectiveFitKeypointsRANSAC-487"><span class="linenos">487</span></a>        <span class="n">xo2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h11</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h12</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h13</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">h31</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h32</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h33</span><span class="p">)</span>
</span><span id="ProjectiveFitKeypointsRANSAC-488"><a href="#ProjectiveFitKeypointsRANSAC-488"><span class="linenos">488</span></a>        <span class="n">yo2</span> <span class="o">=</span> <span class="p">(</span><span class="n">h21</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h22</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h23</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">h31</span><span class="o">*</span><span class="n">xo1</span> <span class="o">+</span> <span class="n">h32</span><span class="o">*</span><span class="n">yo1</span> <span class="o">+</span> <span class="n">h33</span><span class="p">)</span>
</span><span id="ProjectiveFitKeypointsRANSAC-489"><a href="#ProjectiveFitKeypointsRANSAC-489"><span class="linenos">489</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-490"><a href="#ProjectiveFitKeypointsRANSAC-490"><span class="linenos">490</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="ProjectiveFitKeypointsRANSAC-491"><a href="#ProjectiveFitKeypointsRANSAC-491"><span class="linenos">491</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-492"><a href="#ProjectiveFitKeypointsRANSAC-492"><span class="linenos">492</span></a>            <span class="n">xo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xo2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="ProjectiveFitKeypointsRANSAC-493"><a href="#ProjectiveFitKeypointsRANSAC-493"><span class="linenos">493</span></a>            <span class="n">yo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yo2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="ProjectiveFitKeypointsRANSAC-494"><a href="#ProjectiveFitKeypointsRANSAC-494"><span class="linenos">494</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-495"><a href="#ProjectiveFitKeypointsRANSAC-495"><span class="linenos">495</span></a>        <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">xo2</span><span class="p">,</span>
</span><span id="ProjectiveFitKeypointsRANSAC-496"><a href="#ProjectiveFitKeypointsRANSAC-496"><span class="linenos">496</span></a>                                               <span class="n">yo2</span> <span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-497"><a href="#ProjectiveFitKeypointsRANSAC-497"><span class="linenos">497</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-498"><a href="#ProjectiveFitKeypointsRANSAC-498"><span class="linenos">498</span></a>    <span class="c1">#store measurement points for planar DIC on the right camera image series</span>
</span><span id="ProjectiveFitKeypointsRANSAC-499"><a href="#ProjectiveFitKeypointsRANSAC-499"><span class="linenos">499</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo2</span>
</span><span id="ProjectiveFitKeypointsRANSAC-500"><a href="#ProjectiveFitKeypointsRANSAC-500"><span class="linenos">500</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo2</span>
</span><span id="ProjectiveFitKeypointsRANSAC-501"><a href="#ProjectiveFitKeypointsRANSAC-501"><span class="linenos">501</span></a>    <span class="c1">#temporary line of code to store measurement points for later triangulation of displacement coefficients</span>
</span><span id="ProjectiveFitKeypointsRANSAC-502"><a href="#ProjectiveFitKeypointsRANSAC-502"><span class="linenos">502</span></a>    <span class="c1">#np.savetxt(&quot;R_measurement_points.csv&quot;, Xo2, delimiter = &quot;,&quot;)</span>
</span><span id="ProjectiveFitKeypointsRANSAC-503"><a href="#ProjectiveFitKeypointsRANSAC-503"><span class="linenos">503</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-504"><a href="#ProjectiveFitKeypointsRANSAC-504"><span class="linenos">504</span></a>    <span class="c1">#xy bounds for ROI of datum image of right camera image series</span>
</span><span id="ProjectiveFitKeypointsRANSAC-505"><a href="#ProjectiveFitKeypointsRANSAC-505"><span class="linenos">505</span></a>    <span class="n">rx_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-506"><a href="#ProjectiveFitKeypointsRANSAC-506"><span class="linenos">506</span></a>    <span class="n">rx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-507"><a href="#ProjectiveFitKeypointsRANSAC-507"><span class="linenos">507</span></a>    <span class="n">ry_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-508"><a href="#ProjectiveFitKeypointsRANSAC-508"><span class="linenos">508</span></a>    <span class="n">ry_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="ProjectiveFitKeypointsRANSAC-509"><a href="#ProjectiveFitKeypointsRANSAC-509"><span class="linenos">509</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-510"><a href="#ProjectiveFitKeypointsRANSAC-510"><span class="linenos">510</span></a>    <span class="c1">#ROI in right camera image series</span>
</span><span id="ProjectiveFitKeypointsRANSAC-511"><a href="#ProjectiveFitKeypointsRANSAC-511"><span class="linenos">511</span></a>    <span class="n">ROI_1</span> <span class="o">=</span>  <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rx_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="ProjectiveFitKeypointsRANSAC-512"><a href="#ProjectiveFitKeypointsRANSAC-512"><span class="linenos">512</span></a>              <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ry_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="ProjectiveFitKeypointsRANSAC-513"><a href="#ProjectiveFitKeypointsRANSAC-513"><span class="linenos">513</span></a>              <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">rx_max</span> <span class="o">-</span> <span class="n">rx_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="ProjectiveFitKeypointsRANSAC-514"><a href="#ProjectiveFitKeypointsRANSAC-514"><span class="linenos">514</span></a>              <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">ry_max</span> <span class="o">-</span> <span class="n">ry_min</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">))</span>
</span><span id="ProjectiveFitKeypointsRANSAC-515"><a href="#ProjectiveFitKeypointsRANSAC-515"><span class="linenos">515</span></a>
</span><span id="ProjectiveFitKeypointsRANSAC-516"><a href="#ProjectiveFitKeypointsRANSAC-516"><span class="linenos">516</span></a>    <span class="k">return</span> <span class="n">ROI_1</span>
</span></pre></div>


    

                </section>
                <section id="MatchStereoViews">
                            <input id="MatchStereoViews-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">MatchStereoViews</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">image_set_0</span>, </span><span class="param"><span class="n">image_set_1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MatchStereoViews-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MatchStereoViews"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MatchStereoViews-518"><a href="#MatchStereoViews-518"><span class="linenos">518</span></a><span class="k">def</span> <span class="nf">MatchStereoViews</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">):</span>
</span><span id="MatchStereoViews-519"><a href="#MatchStereoViews-519"><span class="linenos">519</span></a>
</span><span id="MatchStereoViews-520"><a href="#MatchStereoViews-520"><span class="linenos">520</span></a>    <span class="c1">#left camera datum image ROI</span>
</span><span id="MatchStereoViews-521"><a href="#MatchStereoViews-521"><span class="linenos">521</span></a>    <span class="n">ROI_L0</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ROI_L0&#39;</span><span class="p">]</span>
</span><span id="MatchStereoViews-522"><a href="#MatchStereoViews-522"><span class="linenos">522</span></a>    
</span><span id="MatchStereoViews-523"><a href="#MatchStereoViews-523"><span class="linenos">523</span></a>    <span class="c1">#left and right camera datum images</span>
</span><span id="MatchStereoViews-524"><a href="#MatchStereoViews-524"><span class="linenos">524</span></a>    <span class="n">L0_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set_0</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DatumImage&#39;</span><span class="p">]]</span>
</span><span id="MatchStereoViews-525"><a href="#MatchStereoViews-525"><span class="linenos">525</span></a>    <span class="n">R0_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set_1</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DatumImage&#39;</span><span class="p">]]</span> 
</span><span id="MatchStereoViews-526"><a href="#MatchStereoViews-526"><span class="linenos">526</span></a>   
</span><span id="MatchStereoViews-527"><a href="#MatchStereoViews-527"><span class="linenos">527</span></a>    <span class="n">L0_8bit</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">L0_8bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="MatchStereoViews-528"><a href="#MatchStereoViews-528"><span class="linenos">528</span></a>    <span class="n">R0_8bit</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">R0_8bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="MatchStereoViews-529"><a href="#MatchStereoViews-529"><span class="linenos">529</span></a>
</span><span id="MatchStereoViews-530"><a href="#MatchStereoViews-530"><span class="linenos">530</span></a>    <span class="c1">#change storage to data dictionary</span>
</span><span id="MatchStereoViews-531"><a href="#MatchStereoViews-531"><span class="linenos">531</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;L0_8bit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L0_8bit</span>
</span><span id="MatchStereoViews-532"><a href="#MatchStereoViews-532"><span class="linenos">532</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;R0_8bit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R0_8bit</span>
</span><span id="MatchStereoViews-533"><a href="#MatchStereoViews-533"><span class="linenos">533</span></a>    
</span><span id="MatchStereoViews-534"><a href="#MatchStereoViews-534"><span class="linenos">534</span></a>    <span class="n">L0_ROI_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">L0_8bit</span><span class="p">)</span>
</span><span id="MatchStereoViews-535"><a href="#MatchStereoViews-535"><span class="linenos">535</span></a>
</span><span id="MatchStereoViews-536"><a href="#MatchStereoViews-536"><span class="linenos">536</span></a>    <span class="c1">#pad the left camera reference image ROI with zeros</span>
</span><span id="MatchStereoViews-537"><a href="#MatchStereoViews-537"><span class="linenos">537</span></a>    <span class="n">L0_ROI_padded</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="MatchStereoViews-538"><a href="#MatchStereoViews-538"><span class="linenos">538</span></a>                  <span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span> \
</span><span id="MatchStereoViews-539"><a href="#MatchStereoViews-539"><span class="linenos">539</span></a>    <span class="o">=</span> <span class="n">L0_8bit</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="MatchStereoViews-540"><a href="#MatchStereoViews-540"><span class="linenos">540</span></a>              <span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ROI_L0</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
</span><span id="MatchStereoViews-541"><a href="#MatchStereoViews-541"><span class="linenos">541</span></a>
</span><span id="MatchStereoViews-542"><a href="#MatchStereoViews-542"><span class="linenos">542</span></a>    <span class="c1">#perform keypoint matching between L0 and R0, find the corresponding measurement</span>
</span><span id="MatchStereoViews-543"><a href="#MatchStereoViews-543"><span class="linenos">543</span></a>    <span class="c1">#points in R0 that are defined in L0 by fitting a projective transformation model</span>
</span><span id="MatchStereoViews-544"><a href="#MatchStereoViews-544"><span class="linenos">544</span></a>    <span class="c1">#between corresponding keypoints in the images around the measurement points in L0</span>
</span><span id="MatchStereoViews-545"><a href="#MatchStereoViews-545"><span class="linenos">545</span></a>    
</span><span id="MatchStereoViews-546"><a href="#MatchStereoViews-546"><span class="linenos">546</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MatchStereoViews-547"><a href="#MatchStereoViews-547"><span class="linenos">547</span></a>    <span class="c1">#keypoint coordinates, keypoint objects, descriptors</span>
</span><span id="MatchStereoViews-548"><a href="#MatchStereoViews-548"><span class="linenos">548</span></a>    <span class="c1">#settings, F_ROI_padded, F, G</span>
</span><span id="MatchStereoViews-549"><a href="#MatchStereoViews-549"><span class="linenos">549</span></a>    <span class="n">Xk</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">SIFTquick</span><span class="p">(</span><span class="n">L0_ROI_padded</span><span class="p">,</span> <span class="n">R0_8bit</span><span class="p">)</span>
</span><span id="MatchStereoViews-550"><a href="#MatchStereoViews-550"><span class="linenos">550</span></a>    
</span><span id="MatchStereoViews-551"><a href="#MatchStereoViews-551"><span class="linenos">551</span></a>    <span class="c1">#robust matching of keypoints between images</span>
</span><span id="MatchStereoViews-552"><a href="#MatchStereoViews-552"><span class="linenos">552</span></a>    <span class="n">Xk</span> <span class="o">=</span> <span class="n">KeypointMatchRobust</span><span class="p">(</span><span class="n">Xk</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="MatchStereoViews-553"><a href="#MatchStereoViews-553"><span class="linenos">553</span></a>    <span class="c1">#find k nearest keypoints (neighbours) to each subset centre</span>
</span><span id="MatchStereoViews-554"><a href="#MatchStereoViews-554"><span class="linenos">554</span></a>    <span class="n">kNN_indices</span> <span class="o">=</span> <span class="n">kNNSubCentres</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span><span id="MatchStereoViews-555"><a href="#MatchStereoViews-555"><span class="linenos">555</span></a>    <span class="c1">#find measurement points defined in reference image in the</span>
</span><span id="MatchStereoViews-556"><a href="#MatchStereoViews-556"><span class="linenos">556</span></a>    <span class="c1">#deformed image and estimate deformation as displacements</span>
</span><span id="MatchStereoViews-557"><a href="#MatchStereoViews-557"><span class="linenos">557</span></a>    <span class="n">ROI_1</span> <span class="o">=</span> <span class="n">ProjectiveFitKeypointsRANSAC</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">Xk</span><span class="p">,</span> <span class="n">kNN_indices</span><span class="p">)</span>
</span><span id="MatchStereoViews-558"><a href="#MatchStereoViews-558"><span class="linenos">558</span></a>
</span><span id="MatchStereoViews-559"><a href="#MatchStereoViews-559"><span class="linenos">559</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;RefineViewMatch&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="MatchStereoViews-560"><a href="#MatchStereoViews-560"><span class="linenos">560</span></a>        <span class="n">CrossCorrelateViews</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">)</span>
</span><span id="MatchStereoViews-561"><a href="#MatchStereoViews-561"><span class="linenos">561</span></a>
</span><span id="MatchStereoViews-562"><a href="#MatchStereoViews-562"><span class="linenos">562</span></a>    <span class="k">return</span> <span class="n">ROI_1</span>
</span></pre></div>


    

                </section>
                <section id="ReferenceImage">
                            <input id="ReferenceImage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ReferenceImage</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">image_set</span>, </span><span class="param"><span class="n">i_image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReferenceImage-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReferenceImage"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReferenceImage-564"><a href="#ReferenceImage-564"><span class="linenos">564</span></a><span class="k">def</span> <span class="nf">ReferenceImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">):</span>
</span><span id="ReferenceImage-565"><a href="#ReferenceImage-565"><span class="linenos">565</span></a>
</span><span id="ReferenceImage-566"><a href="#ReferenceImage-566"><span class="linenos">566</span></a>    <span class="c1">#pre-blur filter parameters</span>
</span><span id="ReferenceImage-567"><a href="#ReferenceImage-567"><span class="linenos">567</span></a>    <span class="n">GF_filt_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterSize&#39;</span><span class="p">]</span>
</span><span id="ReferenceImage-568"><a href="#ReferenceImage-568"><span class="linenos">568</span></a>    <span class="n">GF_std_dev</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterStdDev&#39;</span><span class="p">]</span>
</span><span id="ReferenceImage-569"><a href="#ReferenceImage-569"><span class="linenos">569</span></a>
</span><span id="ReferenceImage-570"><a href="#ReferenceImage-570"><span class="linenos">570</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;StereoPlanar&#39;</span><span class="p">,</span> <span class="s1">&#39;StereoCurved&#39;</span><span class="p">}:</span>
</span><span id="ReferenceImage-571"><a href="#ReferenceImage-571"><span class="linenos">571</span></a>        <span class="c1">#left camera</span>
</span><span id="ReferenceImage-572"><a href="#ReferenceImage-572"><span class="linenos">572</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ReferenceImage-573"><a href="#ReferenceImage-573"><span class="linenos">573</span></a>            <span class="n">F_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span><span class="p">]</span>
</span><span id="ReferenceImage-574"><a href="#ReferenceImage-574"><span class="linenos">574</span></a>        <span class="c1">#right camera</span>
</span><span id="ReferenceImage-575"><a href="#ReferenceImage-575"><span class="linenos">575</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ReferenceImage-576"><a href="#ReferenceImage-576"><span class="linenos">576</span></a>            <span class="n">F_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span><span class="p">]</span>  
</span><span id="ReferenceImage-577"><a href="#ReferenceImage-577"><span class="linenos">577</span></a>    
</span><span id="ReferenceImage-578"><a href="#ReferenceImage-578"><span class="linenos">578</span></a>    <span class="c1">#2D dic</span>
</span><span id="ReferenceImage-579"><a href="#ReferenceImage-579"><span class="linenos">579</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="ReferenceImage-580"><a href="#ReferenceImage-580"><span class="linenos">580</span></a>        <span class="n">F_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span><span class="p">]</span>
</span><span id="ReferenceImage-581"><a href="#ReferenceImage-581"><span class="linenos">581</span></a>
</span><span id="ReferenceImage-582"><a href="#ReferenceImage-582"><span class="linenos">582</span></a>    <span class="nb">print</span><span class="p">(</span><span class="n">F_8bit</span><span class="p">)</span>
</span><span id="ReferenceImage-583"><a href="#ReferenceImage-583"><span class="linenos">583</span></a>
</span><span id="ReferenceImage-584"><a href="#ReferenceImage-584"><span class="linenos">584</span></a>    <span class="n">F_8bit</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">F_8bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="ReferenceImage-585"><a href="#ReferenceImage-585"><span class="linenos">585</span></a>    
</span><span id="ReferenceImage-586"><a href="#ReferenceImage-586"><span class="linenos">586</span></a>    <span class="c1">#normalise 8 bit image, (0,255) -&gt; (0,1)</span>
</span><span id="ReferenceImage-587"><a href="#ReferenceImage-587"><span class="linenos">587</span></a>    <span class="n">F</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">F_8bit</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
</span><span id="ReferenceImage-588"><a href="#ReferenceImage-588"><span class="linenos">588</span></a>    <span class="c1">#blur image with gaussian filter</span>
</span><span id="ReferenceImage-589"><a href="#ReferenceImage-589"><span class="linenos">589</span></a>    <span class="k">if</span> <span class="n">GF_filt_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">GF_std_dev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ReferenceImage-590"><a href="#ReferenceImage-590"><span class="linenos">590</span></a>        <span class="n">F</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">F</span><span class="p">,</span>
</span><span id="ReferenceImage-591"><a href="#ReferenceImage-591"><span class="linenos">591</span></a>                            <span class="p">(</span><span class="n">GF_filt_size</span><span class="p">,</span> <span class="n">GF_filt_size</span><span class="p">),</span>
</span><span id="ReferenceImage-592"><a href="#ReferenceImage-592"><span class="linenos">592</span></a>                            <span class="n">GF_std_dev</span><span class="p">)</span>
</span><span id="ReferenceImage-593"><a href="#ReferenceImage-593"><span class="linenos">593</span></a>                             
</span><span id="ReferenceImage-594"><a href="#ReferenceImage-594"><span class="linenos">594</span></a>    <span class="c1">#gradient of F (reference image) in xy directions</span>
</span><span id="ReferenceImage-595"><a href="#ReferenceImage-595"><span class="linenos">595</span></a>    <span class="n">delF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
</span><span id="ReferenceImage-596"><a href="#ReferenceImage-596"><span class="linenos">596</span></a>    <span class="n">F_interpolated</span> <span class="o">=</span> <span class="n">FastInterpolation</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
</span><span id="ReferenceImage-597"><a href="#ReferenceImage-597"><span class="linenos">597</span></a>    <span class="n">delF_interpolated</span> <span class="o">=</span> <span class="p">[</span><span class="n">FastInterpolation</span><span class="p">(</span><span class="n">delF</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">FastInterpolation</span><span class="p">(</span><span class="n">delF</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
</span><span id="ReferenceImage-598"><a href="#ReferenceImage-598"><span class="linenos">598</span></a>
</span><span id="ReferenceImage-599"><a href="#ReferenceImage-599"><span class="linenos">599</span></a>    <span class="k">return</span> <span class="n">F</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">delF_interpolated</span>    
</span></pre></div>


    

                </section>
                <section id="DeformedImage">
                            <input id="DeformedImage-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">DeformedImage</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">image_set</span>, </span><span class="param"><span class="n">i_image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DeformedImage-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DeformedImage"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DeformedImage-601"><a href="#DeformedImage-601"><span class="linenos">601</span></a><span class="k">def</span> <span class="nf">DeformedImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">):</span>
</span><span id="DeformedImage-602"><a href="#DeformedImage-602"><span class="linenos">602</span></a>
</span><span id="DeformedImage-603"><a href="#DeformedImage-603"><span class="linenos">603</span></a>    <span class="c1">#gaussian filter settings</span>
</span><span id="DeformedImage-604"><a href="#DeformedImage-604"><span class="linenos">604</span></a>    <span class="n">GF_filt_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterSize&#39;</span><span class="p">]</span>
</span><span id="DeformedImage-605"><a href="#DeformedImage-605"><span class="linenos">605</span></a>    <span class="n">GF_std_dev</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GaussianFilterStdDev&#39;</span><span class="p">]</span>
</span><span id="DeformedImage-606"><a href="#DeformedImage-606"><span class="linenos">606</span></a>
</span><span id="DeformedImage-607"><a href="#DeformedImage-607"><span class="linenos">607</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;StereoPlanar&#39;</span><span class="p">,</span> <span class="s1">&#39;StereoCurved&#39;</span><span class="p">}:</span>
</span><span id="DeformedImage-608"><a href="#DeformedImage-608"><span class="linenos">608</span></a>        <span class="c1">#left or right camera</span>
</span><span id="DeformedImage-609"><a href="#DeformedImage-609"><span class="linenos">609</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="DeformedImage-610"><a href="#DeformedImage-610"><span class="linenos">610</span></a>            <span class="n">G_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Increment&#39;</span><span class="p">]]</span>
</span><span id="DeformedImage-611"><a href="#DeformedImage-611"><span class="linenos">611</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="DeformedImage-612"><a href="#DeformedImage-612"><span class="linenos">612</span></a>            <span class="n">G_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StereoImagesFolder1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Increment&#39;</span><span class="p">]]</span>
</span><span id="DeformedImage-613"><a href="#DeformedImage-613"><span class="linenos">613</span></a>    
</span><span id="DeformedImage-614"><a href="#DeformedImage-614"><span class="linenos">614</span></a>    <span class="c1">#2D dic</span>
</span><span id="DeformedImage-615"><a href="#DeformedImage-615"><span class="linenos">615</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="DeformedImage-616"><a href="#DeformedImage-616"><span class="linenos">616</span></a>        <span class="n">G_8bit</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;PlanarImagesFolder&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">image_set</span><span class="p">[</span><span class="n">i_image</span><span class="p">]</span>
</span><span id="DeformedImage-617"><a href="#DeformedImage-617"><span class="linenos">617</span></a>    <span class="n">G_8bit</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">G_8bit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="DeformedImage-618"><a href="#DeformedImage-618"><span class="linenos">618</span></a>    
</span><span id="DeformedImage-619"><a href="#DeformedImage-619"><span class="linenos">619</span></a>    <span class="c1">#normalise 8 bit image, (0,255) -&gt; (0,1)</span>
</span><span id="DeformedImage-620"><a href="#DeformedImage-620"><span class="linenos">620</span></a>    <span class="n">G</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">G_8bit</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">NORM_MINMAX</span><span class="p">)</span>
</span><span id="DeformedImage-621"><a href="#DeformedImage-621"><span class="linenos">621</span></a>    <span class="c1">#blur image with gaussian filter</span>
</span><span id="DeformedImage-622"><a href="#DeformedImage-622"><span class="linenos">622</span></a>    <span class="k">if</span> <span class="n">GF_filt_size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">GF_std_dev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="DeformedImage-623"><a href="#DeformedImage-623"><span class="linenos">623</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">G</span><span class="p">,</span>
</span><span id="DeformedImage-624"><a href="#DeformedImage-624"><span class="linenos">624</span></a>                            <span class="p">(</span><span class="n">GF_filt_size</span><span class="p">,</span> <span class="n">GF_filt_size</span><span class="p">),</span>
</span><span id="DeformedImage-625"><a href="#DeformedImage-625"><span class="linenos">625</span></a>                            <span class="n">GF_std_dev</span><span class="p">)</span>
</span><span id="DeformedImage-626"><a href="#DeformedImage-626"><span class="linenos">626</span></a>
</span><span id="DeformedImage-627"><a href="#DeformedImage-627"><span class="linenos">627</span></a>    <span class="n">G_interpolated</span> <span class="o">=</span> <span class="n">FastInterpolation</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
</span><span id="DeformedImage-628"><a href="#DeformedImage-628"><span class="linenos">628</span></a>    
</span><span id="DeformedImage-629"><a href="#DeformedImage-629"><span class="linenos">629</span></a>    <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">G_interpolated</span>
</span></pre></div>


    

                </section>
                <section id="ConvergenceParametersGlobal">
                            <input id="ConvergenceParametersGlobal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ConvergenceParametersGlobal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ConvergenceParametersGlobal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ConvergenceParametersGlobal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ConvergenceParametersGlobal-631"><a href="#ConvergenceParametersGlobal-631"><span class="linenos">631</span></a><span class="k">def</span> <span class="nf">ConvergenceParametersGlobal</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="ConvergenceParametersGlobal-632"><a href="#ConvergenceParametersGlobal-632"><span class="linenos">632</span></a>
</span><span id="ConvergenceParametersGlobal-633"><a href="#ConvergenceParametersGlobal-633"><span class="linenos">633</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="HessianLocal">
                            <input id="HessianLocal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">HessianLocal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">delf</span>, </span><span class="param"><span class="n">xsi</span>, </span><span class="param"><span class="n">eta</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="HessianLocal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#HessianLocal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="HessianLocal-635"><a href="#HessianLocal-635"><span class="linenos">635</span></a><span class="k">def</span> <span class="nf">HessianLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delf</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="HessianLocal-636"><a href="#HessianLocal-636"><span class="linenos">636</span></a>
</span><span id="HessianLocal-637"><a href="#HessianLocal-637"><span class="linenos">637</span></a>    <span class="c1">#flatten subset intensity gradients to vectors</span>
</span><span id="HessianLocal-638"><a href="#HessianLocal-638"><span class="linenos">638</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="HessianLocal-639"><a href="#HessianLocal-639"><span class="linenos">639</span></a>        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">delf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="HessianLocal-640"><a href="#HessianLocal-640"><span class="linenos">640</span></a>        <span class="n">dfdy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">delf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="HessianLocal-641"><a href="#HessianLocal-641"><span class="linenos">641</span></a>
</span><span id="HessianLocal-642"><a href="#HessianLocal-642"><span class="linenos">642</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="HessianLocal-643"><a href="#HessianLocal-643"><span class="linenos">643</span></a>        
</span><span id="HessianLocal-644"><a href="#HessianLocal-644"><span class="linenos">644</span></a>        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">delf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="HessianLocal-645"><a href="#HessianLocal-645"><span class="linenos">645</span></a>        <span class="n">dfdy</span> <span class="o">=</span> <span class="n">delf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="HessianLocal-646"><a href="#HessianLocal-646"><span class="linenos">646</span></a>
</span><span id="HessianLocal-647"><a href="#HessianLocal-647"><span class="linenos">647</span></a>    <span class="c1">#Affine transformation</span>
</span><span id="HessianLocal-648"><a href="#HessianLocal-648"><span class="linenos">648</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span> 
</span><span id="HessianLocal-649"><a href="#HessianLocal-649"><span class="linenos">649</span></a>        
</span><span id="HessianLocal-650"><a href="#HessianLocal-650"><span class="linenos">650</span></a>        <span class="n">Jacobian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>
</span><span id="HessianLocal-651"><a href="#HessianLocal-651"><span class="linenos">651</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-652"><a href="#HessianLocal-652"><span class="linenos">652</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-653"><a href="#HessianLocal-653"><span class="linenos">653</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>
</span><span id="HessianLocal-654"><a href="#HessianLocal-654"><span class="linenos">654</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-655"><a href="#HessianLocal-655"><span class="linenos">655</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="p">])</span><span class="o">.</span><span class="n">T</span>                            
</span><span id="HessianLocal-656"><a href="#HessianLocal-656"><span class="linenos">656</span></a>    
</span><span id="HessianLocal-657"><a href="#HessianLocal-657"><span class="linenos">657</span></a>    <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="HessianLocal-658"><a href="#HessianLocal-658"><span class="linenos">658</span></a>        
</span><span id="HessianLocal-659"><a href="#HessianLocal-659"><span class="linenos">659</span></a>        <span class="n">Jacobian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>
</span><span id="HessianLocal-660"><a href="#HessianLocal-660"><span class="linenos">660</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-661"><a href="#HessianLocal-661"><span class="linenos">661</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-662"><a href="#HessianLocal-662"><span class="linenos">662</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
</span><span id="HessianLocal-663"><a href="#HessianLocal-663"><span class="linenos">663</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-664"><a href="#HessianLocal-664"><span class="linenos">664</span></a>                              <span class="n">dfdx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
</span><span id="HessianLocal-665"><a href="#HessianLocal-665"><span class="linenos">665</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span>
</span><span id="HessianLocal-666"><a href="#HessianLocal-666"><span class="linenos">666</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-667"><a href="#HessianLocal-667"><span class="linenos">667</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-668"><a href="#HessianLocal-668"><span class="linenos">668</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
</span><span id="HessianLocal-669"><a href="#HessianLocal-669"><span class="linenos">669</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span>
</span><span id="HessianLocal-670"><a href="#HessianLocal-670"><span class="linenos">670</span></a>                              <span class="n">dfdy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">eta</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="HessianLocal-671"><a href="#HessianLocal-671"><span class="linenos">671</span></a>                                
</span><span id="HessianLocal-672"><a href="#HessianLocal-672"><span class="linenos">672</span></a>    <span class="n">Hessian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Jacobian</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Jacobian</span><span class="p">)</span> 
</span><span id="HessianLocal-673"><a href="#HessianLocal-673"><span class="linenos">673</span></a>
</span><span id="HessianLocal-674"><a href="#HessianLocal-674"><span class="linenos">674</span></a>    <span class="k">return</span> <span class="n">Hessian</span><span class="p">,</span> <span class="n">Jacobian</span>
</span></pre></div>


    

                </section>
                <section id="InitialiseConvergenceParamtersLocal">
                            <input id="InitialiseConvergenceParamtersLocal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">InitialiseConvergenceParamtersLocal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="InitialiseConvergenceParamtersLocal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InitialiseConvergenceParamtersLocal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InitialiseConvergenceParamtersLocal-676"><a href="#InitialiseConvergenceParamtersLocal-676"><span class="linenos">676</span></a><span class="k">def</span> <span class="nf">InitialiseConvergenceParamtersLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="InitialiseConvergenceParamtersLocal-677"><a href="#InitialiseConvergenceParamtersLocal-677"><span class="linenos">677</span></a>
</span><span id="InitialiseConvergenceParamtersLocal-678"><a href="#InitialiseConvergenceParamtersLocal-678"><span class="linenos">678</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="InitialiseConvergenceParamtersLocal-679"><a href="#InitialiseConvergenceParamtersLocal-679"><span class="linenos">679</span></a>    <span class="n">correlation_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="InitialiseConvergenceParamtersLocal-680"><a href="#InitialiseConvergenceParamtersLocal-680"><span class="linenos">680</span></a>    <span class="n">exit_crits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="InitialiseConvergenceParamtersLocal-681"><a href="#InitialiseConvergenceParamtersLocal-681"><span class="linenos">681</span></a>    <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="InitialiseConvergenceParamtersLocal-682"><a href="#InitialiseConvergenceParamtersLocal-682"><span class="linenos">682</span></a>
</span><span id="InitialiseConvergenceParamtersLocal-683"><a href="#InitialiseConvergenceParamtersLocal-683"><span class="linenos">683</span></a>    <span class="k">return</span> <span class="n">correlation_coefficients</span><span class="p">,</span> <span class="n">exit_crits</span><span class="p">,</span> <span class="n">n_iterations</span>
</span></pre></div>


    

                </section>
                <section id="InitialiseDeformationModelSubsets">
                            <input id="InitialiseDeformationModelSubsets-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">InitialiseDeformationModelSubsets</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">n_subsets</span>, </span><span class="param"><span class="n">F_8bit</span>, </span><span class="param"><span class="n">G_8bit</span>, </span><span class="param"><span class="n">ROI</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="InitialiseDeformationModelSubsets-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InitialiseDeformationModelSubsets"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InitialiseDeformationModelSubsets-685"><a href="#InitialiseDeformationModelSubsets-685"><span class="linenos">685</span></a><span class="k">def</span> <span class="nf">InitialiseDeformationModelSubsets</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">ROI</span><span class="p">):</span>
</span><span id="InitialiseDeformationModelSubsets-686"><a href="#InitialiseDeformationModelSubsets-686"><span class="linenos">686</span></a>    
</span><span id="InitialiseDeformationModelSubsets-687"><a href="#InitialiseDeformationModelSubsets-687"><span class="linenos">687</span></a>    <span class="c1">#initial estimate of the deformation model</span>
</span><span id="InitialiseDeformationModelSubsets-688"><a href="#InitialiseDeformationModelSubsets-688"><span class="linenos">688</span></a>    <span class="c1">#the initial model estimate contains only displacements: u0, v0</span>
</span><span id="InitialiseDeformationModelSubsets-689"><a href="#InitialiseDeformationModelSubsets-689"><span class="linenos">689</span></a>    <span class="c1">#performed here for all the subsets in the ROI</span>
</span><span id="InitialiseDeformationModelSubsets-690"><a href="#InitialiseDeformationModelSubsets-690"><span class="linenos">690</span></a>
</span><span id="InitialiseDeformationModelSubsets-691"><a href="#InitialiseDeformationModelSubsets-691"><span class="linenos">691</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PhaseCorrelation&#39;</span><span class="p">:</span>
</span><span id="InitialiseDeformationModelSubsets-692"><a href="#InitialiseDeformationModelSubsets-692"><span class="linenos">692</span></a>
</span><span id="InitialiseDeformationModelSubsets-693"><a href="#InitialiseDeformationModelSubsets-693"><span class="linenos">693</span></a>        <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">EstimateDisplacementsFourier</span>
</span><span id="InitialiseDeformationModelSubsets-694"><a href="#InitialiseDeformationModelSubsets-694"><span class="linenos">694</span></a>
</span><span id="InitialiseDeformationModelSubsets-695"><a href="#InitialiseDeformationModelSubsets-695"><span class="linenos">695</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TinyDisplacements&#39;</span><span class="p">:</span>
</span><span id="InitialiseDeformationModelSubsets-696"><a href="#InitialiseDeformationModelSubsets-696"><span class="linenos">696</span></a>
</span><span id="InitialiseDeformationModelSubsets-697"><a href="#InitialiseDeformationModelSubsets-697"><span class="linenos">697</span></a>        <span class="n">u0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="InitialiseDeformationModelSubsets-698"><a href="#InitialiseDeformationModelSubsets-698"><span class="linenos">698</span></a>        <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="InitialiseDeformationModelSubsets-699"><a href="#InitialiseDeformationModelSubsets-699"><span class="linenos">699</span></a>
</span><span id="InitialiseDeformationModelSubsets-700"><a href="#InitialiseDeformationModelSubsets-700"><span class="linenos">700</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;KeypointDetection&#39;</span><span class="p">:</span>
</span><span id="InitialiseDeformationModelSubsets-701"><a href="#InitialiseDeformationModelSubsets-701"><span class="linenos">701</span></a>        <span class="c1">#pad the ROI intensity values with zeros</span>
</span><span id="InitialiseDeformationModelSubsets-702"><a href="#InitialiseDeformationModelSubsets-702"><span class="linenos">702</span></a>        <span class="n">F_ROI_padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">F_8bit</span><span class="p">)</span>
</span><span id="InitialiseDeformationModelSubsets-703"><a href="#InitialiseDeformationModelSubsets-703"><span class="linenos">703</span></a>        <span class="n">F_ROI_padded</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ROI</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="InitialiseDeformationModelSubsets-704"><a href="#InitialiseDeformationModelSubsets-704"><span class="linenos">704</span></a>                     <span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ROI</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span> <span class="o">=</span> <span class="n">F_8bit</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">ROI</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
</span><span id="InitialiseDeformationModelSubsets-705"><a href="#InitialiseDeformationModelSubsets-705"><span class="linenos">705</span></a>                                                              <span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span><span class="nb">int</span><span class="p">(</span><span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">ROI</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
</span><span id="InitialiseDeformationModelSubsets-706"><a href="#InitialiseDeformationModelSubsets-706"><span class="linenos">706</span></a>        <span class="n">F_ROI_padded</span> <span class="o">=</span> <span class="n">F_ROI_padded</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="InitialiseDeformationModelSubsets-707"><a href="#InitialiseDeformationModelSubsets-707"><span class="linenos">707</span></a>
</span><span id="InitialiseDeformationModelSubsets-708"><a href="#InitialiseDeformationModelSubsets-708"><span class="linenos">708</span></a>        <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="n">KPMatchMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span>
</span><span id="InitialiseDeformationModelSubsets-709"><a href="#InitialiseDeformationModelSubsets-709"><span class="linenos">709</span></a>                                          <span class="n">F_ROI_padded</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">)</span>
</span><span id="InitialiseDeformationModelSubsets-710"><a href="#InitialiseDeformationModelSubsets-710"><span class="linenos">710</span></a>
</span><span id="InitialiseDeformationModelSubsets-711"><a href="#InitialiseDeformationModelSubsets-711"><span class="linenos">711</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;HornSchunck&#39;</span><span class="p">:</span>
</span><span id="InitialiseDeformationModelSubsets-712"><a href="#InitialiseDeformationModelSubsets-712"><span class="linenos">712</span></a>
</span><span id="InitialiseDeformationModelSubsets-713"><a href="#InitialiseDeformationModelSubsets-713"><span class="linenos">713</span></a>        <span class="k">pass</span>
</span><span id="InitialiseDeformationModelSubsets-714"><a href="#InitialiseDeformationModelSubsets-714"><span class="linenos">714</span></a>    
</span><span id="InitialiseDeformationModelSubsets-715"><a href="#InitialiseDeformationModelSubsets-715"><span class="linenos">715</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;GNInitialization&#39;</span><span class="p">]</span>  <span class="o">==</span> <span class="s1">&#39;LucasKanade&#39;</span><span class="p">:</span>
</span><span id="InitialiseDeformationModelSubsets-716"><a href="#InitialiseDeformationModelSubsets-716"><span class="linenos">716</span></a>        
</span><span id="InitialiseDeformationModelSubsets-717"><a href="#InitialiseDeformationModelSubsets-717"><span class="linenos">717</span></a>        <span class="k">pass</span>
</span><span id="InitialiseDeformationModelSubsets-718"><a href="#InitialiseDeformationModelSubsets-718"><span class="linenos">718</span></a>
</span><span id="InitialiseDeformationModelSubsets-719"><a href="#InitialiseDeformationModelSubsets-719"><span class="linenos">719</span></a>    <span class="c1">#the estimated displacements correspond to the &#39;zeroth&#39; coefficients of</span>
</span><span id="InitialiseDeformationModelSubsets-720"><a href="#InitialiseDeformationModelSubsets-720"><span class="linenos">720</span></a>    <span class="c1">#the deformation model</span>
</span><span id="InitialiseDeformationModelSubsets-721"><a href="#InitialiseDeformationModelSubsets-721"><span class="linenos">721</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="InitialiseDeformationModelSubsets-722"><a href="#InitialiseDeformationModelSubsets-722"><span class="linenos">722</span></a>
</span><span id="InitialiseDeformationModelSubsets-723"><a href="#InitialiseDeformationModelSubsets-723"><span class="linenos">723</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="InitialiseDeformationModelSubsets-724"><a href="#InitialiseDeformationModelSubsets-724"><span class="linenos">724</span></a>        <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span>
</span><span id="InitialiseDeformationModelSubsets-725"><a href="#InitialiseDeformationModelSubsets-725"><span class="linenos">725</span></a>    <span class="c1">#</span>
</span><span id="InitialiseDeformationModelSubsets-726"><a href="#InitialiseDeformationModelSubsets-726"><span class="linenos">726</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="InitialiseDeformationModelSubsets-727"><a href="#InitialiseDeformationModelSubsets-727"><span class="linenos">727</span></a>
</span><span id="InitialiseDeformationModelSubsets-728"><a href="#InitialiseDeformationModelSubsets-728"><span class="linenos">728</span></a>        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="InitialiseDeformationModelSubsets-729"><a href="#InitialiseDeformationModelSubsets-729"><span class="linenos">729</span></a>        <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">6</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span>
</span><span id="InitialiseDeformationModelSubsets-730"><a href="#InitialiseDeformationModelSubsets-730"><span class="linenos">730</span></a>
</span><span id="InitialiseDeformationModelSubsets-731"><a href="#InitialiseDeformationModelSubsets-731"><span class="linenos">731</span></a>    <span class="k">return</span> <span class="n">coeffs</span>
</span></pre></div>


    

                </section>
                <section id="InitialiseCoefficientUpdate">
                            <input id="InitialiseCoefficientUpdate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">InitialiseCoefficientUpdate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="InitialiseCoefficientUpdate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InitialiseCoefficientUpdate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InitialiseCoefficientUpdate-733"><a href="#InitialiseCoefficientUpdate-733"><span class="linenos">733</span></a><span class="k">def</span> <span class="nf">InitialiseCoefficientUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="InitialiseCoefficientUpdate-734"><a href="#InitialiseCoefficientUpdate-734"><span class="linenos">734</span></a>
</span><span id="InitialiseCoefficientUpdate-735"><a href="#InitialiseCoefficientUpdate-735"><span class="linenos">735</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="InitialiseCoefficientUpdate-736"><a href="#InitialiseCoefficientUpdate-736"><span class="linenos">736</span></a>
</span><span id="InitialiseCoefficientUpdate-737"><a href="#InitialiseCoefficientUpdate-737"><span class="linenos">737</span></a>        <span class="n">deltaP</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="InitialiseCoefficientUpdate-738"><a href="#InitialiseCoefficientUpdate-738"><span class="linenos">738</span></a>
</span><span id="InitialiseCoefficientUpdate-739"><a href="#InitialiseCoefficientUpdate-739"><span class="linenos">739</span></a>    <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="InitialiseCoefficientUpdate-740"><a href="#InitialiseCoefficientUpdate-740"><span class="linenos">740</span></a>        
</span><span id="InitialiseCoefficientUpdate-741"><a href="#InitialiseCoefficientUpdate-741"><span class="linenos">741</span></a>        <span class="n">deltaP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="InitialiseCoefficientUpdate-742"><a href="#InitialiseCoefficientUpdate-742"><span class="linenos">742</span></a>
</span><span id="InitialiseCoefficientUpdate-743"><a href="#InitialiseCoefficientUpdate-743"><span class="linenos">743</span></a>    <span class="k">return</span> <span class="n">deltaP</span>
</span></pre></div>


    

                </section>
                <section id="GaussNewtonLocal">
                            <input id="GaussNewtonLocal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">GaussNewtonLocal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">ROI</span>, </span><span class="param"><span class="n">image_set</span>, </span><span class="param"><span class="n">i_image</span>, </span><span class="param"><span class="n">image_pair</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GaussNewtonLocal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GaussNewtonLocal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GaussNewtonLocal-745"><a href="#GaussNewtonLocal-745"><span class="linenos">745</span></a><span class="k">def</span> <span class="nf">GaussNewtonLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">,</span> <span class="n">image_pair</span><span class="p">):</span>
</span><span id="GaussNewtonLocal-746"><a href="#GaussNewtonLocal-746"><span class="linenos">746</span></a>
</span><span id="GaussNewtonLocal-747"><a href="#GaussNewtonLocal-747"><span class="linenos">747</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="GaussNewtonLocal-748"><a href="#GaussNewtonLocal-748"><span class="linenos">748</span></a>    <span class="c1">#number of intensity values in the subset/template</span>
</span><span id="GaussNewtonLocal-749"><a href="#GaussNewtonLocal-749"><span class="linenos">749</span></a>    
</span><span id="GaussNewtonLocal-750"><a href="#GaussNewtonLocal-750"><span class="linenos">750</span></a>    <span class="c1">#reference subset local/relative coordinates (same for all subsets)</span>
</span><span id="GaussNewtonLocal-751"><a href="#GaussNewtonLocal-751"><span class="linenos">751</span></a>    <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="GaussNewtonLocal-752"><a href="#GaussNewtonLocal-752"><span class="linenos">752</span></a>    <span class="n">CC</span><span class="p">,</span> <span class="n">exit_crits</span><span class="p">,</span> <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">InitialiseConvergenceParamtersLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-753"><a href="#GaussNewtonLocal-753"><span class="linenos">753</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GaussNewtonLocal-754"><a href="#GaussNewtonLocal-754"><span class="linenos">754</span></a>
</span><span id="GaussNewtonLocal-755"><a href="#GaussNewtonLocal-755"><span class="linenos">755</span></a>    <span class="c1">#define reference and target images for current image pair</span>
</span><span id="GaussNewtonLocal-756"><a href="#GaussNewtonLocal-756"><span class="linenos">756</span></a>    <span class="c1">#delF: dFdy = delF[0], dFdx = delF[1]</span>
</span><span id="GaussNewtonLocal-757"><a href="#GaussNewtonLocal-757"><span class="linenos">757</span></a>    <span class="n">F</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">delF_interpolated</span> <span class="o">=</span> <span class="n">ReferenceImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span>
</span><span id="GaussNewtonLocal-758"><a href="#GaussNewtonLocal-758"><span class="linenos">758</span></a>                                                     <span class="n">i_image</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-759"><a href="#GaussNewtonLocal-759"><span class="linenos">759</span></a>    <span class="n">G</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">G_interpolated</span> <span class="o">=</span> <span class="n">DeformedImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-760"><a href="#GaussNewtonLocal-760"><span class="linenos">760</span></a>    
</span><span id="GaussNewtonLocal-761"><a href="#GaussNewtonLocal-761"><span class="linenos">761</span></a>    <span class="c1">#deformation model coefficients initialisation (all subsets)</span>
</span><span id="GaussNewtonLocal-762"><a href="#GaussNewtonLocal-762"><span class="linenos">762</span></a>    <span class="c1">#p is the vector of coefficients of the subset deformaton model</span>
</span><span id="GaussNewtonLocal-763"><a href="#GaussNewtonLocal-763"><span class="linenos">763</span></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">InitialiseDeformationModelSubsets</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-764"><a href="#GaussNewtonLocal-764"><span class="linenos">764</span></a>    
</span><span id="GaussNewtonLocal-765"><a href="#GaussNewtonLocal-765"><span class="linenos">765</span></a>    <span class="c1">#loop through all subsets/measurement points, determine the model coefficients for</span>
</span><span id="GaussNewtonLocal-766"><a href="#GaussNewtonLocal-766"><span class="linenos">766</span></a>    <span class="c1">#each subset independently</span>
</span><span id="GaussNewtonLocal-767"><a href="#GaussNewtonLocal-767"><span class="linenos">767</span></a>    <span class="k">for</span> <span class="n">i_subset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="GaussNewtonLocal-768"><a href="#GaussNewtonLocal-768"><span class="linenos">768</span></a>        
</span><span id="GaussNewtonLocal-769"><a href="#GaussNewtonLocal-769"><span class="linenos">769</span></a>        <span class="c1">#measurement point/subset centre coordinates for i&#39;th/current subset</span>
</span><span id="GaussNewtonLocal-770"><a href="#GaussNewtonLocal-770"><span class="linenos">770</span></a>        <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span> <span class="o">=</span> <span class="p">[</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_subset</span><span class="p">],</span>
</span><span id="GaussNewtonLocal-771"><a href="#GaussNewtonLocal-771"><span class="linenos">771</span></a>                   <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i_subset</span><span class="p">]</span> <span class="p">]</span>
</span><span id="GaussNewtonLocal-772"><a href="#GaussNewtonLocal-772"><span class="linenos">772</span></a>
</span><span id="GaussNewtonLocal-773"><a href="#GaussNewtonLocal-773"><span class="linenos">773</span></a>        <span class="c1">#intensity data for reference subset</span>
</span><span id="GaussNewtonLocal-774"><a href="#GaussNewtonLocal-774"><span class="linenos">774</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="GaussNewtonLocal-775"><a href="#GaussNewtonLocal-775"><span class="linenos">775</span></a>            <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="n">delf</span> <span class="o">=</span> <span class="n">ReferenceSubset</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-776"><a href="#GaussNewtonLocal-776"><span class="linenos">776</span></a>
</span><span id="GaussNewtonLocal-777"><a href="#GaussNewtonLocal-777"><span class="linenos">777</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="GaussNewtonLocal-778"><a href="#GaussNewtonLocal-778"><span class="linenos">778</span></a>            <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="n">delf</span> <span class="o">=</span> <span class="n">ReferenceSubset</span><span class="p">(</span><span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF_interpolated</span><span class="p">,</span>
</span><span id="GaussNewtonLocal-779"><a href="#GaussNewtonLocal-779"><span class="linenos">779</span></a>                                                       <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-780"><a href="#GaussNewtonLocal-780"><span class="linenos">780</span></a>
</span><span id="GaussNewtonLocal-781"><a href="#GaussNewtonLocal-781"><span class="linenos">781</span></a>        <span class="c1">#Hessian and Jacobian operators for GN optimization routine, derived from</span>
</span><span id="GaussNewtonLocal-782"><a href="#GaussNewtonLocal-782"><span class="linenos">782</span></a>        <span class="c1">#reference subset intensity gradient data</span>
</span><span id="GaussNewtonLocal-783"><a href="#GaussNewtonLocal-783"><span class="linenos">783</span></a>        <span class="n">H</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">HessianLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delf</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-784"><a href="#GaussNewtonLocal-784"><span class="linenos">784</span></a>
</span><span id="GaussNewtonLocal-785"><a href="#GaussNewtonLocal-785"><span class="linenos">785</span></a>        <span class="c1">#initial estimate for the incremental update of the model coefficients</span>
</span><span id="GaussNewtonLocal-786"><a href="#GaussNewtonLocal-786"><span class="linenos">786</span></a>        <span class="n">delta_p_i</span> <span class="o">=</span> <span class="n">InitialiseCoefficientUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-787"><a href="#GaussNewtonLocal-787"><span class="linenos">787</span></a>        <span class="c1">#model coefficients</span>
</span><span id="GaussNewtonLocal-788"><a href="#GaussNewtonLocal-788"><span class="linenos">788</span></a>        <span class="n">p_i</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="GaussNewtonLocal-789"><a href="#GaussNewtonLocal-789"><span class="linenos">789</span></a>
</span><span id="GaussNewtonLocal-790"><a href="#GaussNewtonLocal-790"><span class="linenos">790</span></a>        <span class="c1">#check the dimensions</span>
</span><span id="GaussNewtonLocal-791"><a href="#GaussNewtonLocal-791"><span class="linenos">791</span></a>
</span><span id="GaussNewtonLocal-792"><a href="#GaussNewtonLocal-792"><span class="linenos">792</span></a>        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GaussNewtonLocal-793"><a href="#GaussNewtonLocal-793"><span class="linenos">793</span></a>        <span class="c1">#perform GN optimisation routine</span>
</span><span id="GaussNewtonLocal-794"><a href="#GaussNewtonLocal-794"><span class="linenos">794</span></a>        <span class="k">while</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="GaussNewtonLocal-795"><a href="#GaussNewtonLocal-795"><span class="linenos">795</span></a>            
</span><span id="GaussNewtonLocal-796"><a href="#GaussNewtonLocal-796"><span class="linenos">796</span></a>            <span class="c1">#relative coordinates of intensity values within subset</span>
</span><span id="GaussNewtonLocal-797"><a href="#GaussNewtonLocal-797"><span class="linenos">797</span></a>            <span class="c1">#of deformed image, based on current iteration of deformation model</span>
</span><span id="GaussNewtonLocal-798"><a href="#GaussNewtonLocal-798"><span class="linenos">798</span></a>            <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span> <span class="o">=</span> <span class="n">DeformationModelSubset</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-799"><a href="#GaussNewtonLocal-799"><span class="linenos">799</span></a>            <span class="c1">#intensity data of deformed subset</span>
</span><span id="GaussNewtonLocal-800"><a href="#GaussNewtonLocal-800"><span class="linenos">800</span></a>            <span class="n">g</span><span class="p">,</span> <span class="n">g_mean</span><span class="p">,</span> <span class="n">g_tilde</span> <span class="o">=</span> <span class="n">DeformedSubset</span><span class="p">(</span><span class="n">G_interpolated</span><span class="p">,</span> <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-801"><a href="#GaussNewtonLocal-801"><span class="linenos">801</span></a>            <span class="c1">#</span>
</span><span id="GaussNewtonLocal-802"><a href="#GaussNewtonLocal-802"><span class="linenos">802</span></a>            <span class="n">exit_criteria</span> <span class="o">=</span> <span class="n">ExitCriteriaLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delta_p_i</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="GaussNewtonLocal-803"><a href="#GaussNewtonLocal-803"><span class="linenos">803</span></a>            <span class="k">if</span> <span class="n">exit_criteria</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
</span><span id="GaussNewtonLocal-804"><a href="#GaussNewtonLocal-804"><span class="linenos">804</span></a>                <span class="k">break</span> 
</span><span id="GaussNewtonLocal-805"><a href="#GaussNewtonLocal-805"><span class="linenos">805</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GaussNewtonLocal-806"><a href="#GaussNewtonLocal-806"><span class="linenos">806</span></a>                <span class="n">residual</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="o">-</span><span class="n">f_tilde</span><span class="o">/</span><span class="n">g_tilde</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-807"><a href="#GaussNewtonLocal-807"><span class="linenos">807</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-808"><a href="#GaussNewtonLocal-808"><span class="linenos">808</span></a>                <span class="c1">#Gauss-Newton update of deformation model coefficients (for current subset)</span>
</span><span id="GaussNewtonLocal-809"><a href="#GaussNewtonLocal-809"><span class="linenos">809</span></a>                <span class="c1">#i.e solve the linear system H*dp = b for i&#39;th subset</span>
</span><span id="GaussNewtonLocal-810"><a href="#GaussNewtonLocal-810"><span class="linenos">810</span></a>                <span class="n">delta_p_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</span><span id="GaussNewtonLocal-811"><a href="#GaussNewtonLocal-811"><span class="linenos">811</span></a>                <span class="n">p_i</span> <span class="o">=</span> <span class="n">CompositionalUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">delta_p_i</span><span class="p">)</span>
</span><span id="GaussNewtonLocal-812"><a href="#GaussNewtonLocal-812"><span class="linenos">812</span></a>
</span><span id="GaussNewtonLocal-813"><a href="#GaussNewtonLocal-813"><span class="linenos">813</span></a>            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="GaussNewtonLocal-814"><a href="#GaussNewtonLocal-814"><span class="linenos">814</span></a>        <span class="c1">#store convergence information for current subset</span>
</span><span id="GaussNewtonLocal-815"><a href="#GaussNewtonLocal-815"><span class="linenos">815</span></a>        <span class="c1">#coefficients of deformation model, correlation criterion,</span>
</span><span id="GaussNewtonLocal-816"><a href="#GaussNewtonLocal-816"><span class="linenos">816</span></a>        <span class="c1">#exit criterion, number of iterations</span>
</span><span id="GaussNewtonLocal-817"><a href="#GaussNewtonLocal-817"><span class="linenos">817</span></a>        <span class="n">CC</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(((</span><span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="p">)</span><span class="o">/</span><span class="n">f_tilde</span><span class="o">-</span><span class="p">(</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span><span class="o">/</span><span class="n">g_tilde</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="GaussNewtonLocal-818"><a href="#GaussNewtonLocal-818"><span class="linenos">818</span></a>        <span class="n">exit_crits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">exit_criteria</span>
</span><span id="GaussNewtonLocal-819"><a href="#GaussNewtonLocal-819"><span class="linenos">819</span></a>        <span class="n">n_iterations</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>  <span class="o">=</span> <span class="n">iteration</span>
</span><span id="GaussNewtonLocal-820"><a href="#GaussNewtonLocal-820"><span class="linenos">820</span></a>        <span class="n">p</span><span class="p">[:,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_i</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="GaussNewtonLocal-821"><a href="#GaussNewtonLocal-821"><span class="linenos">821</span></a>
</span><span id="GaussNewtonLocal-822"><a href="#GaussNewtonLocal-822"><span class="linenos">822</span></a>    <span class="k">return</span> <span class="n">p</span> 
</span></pre></div>


    

                </section>
                <section id="CrossCorrelateViews">
                            <input id="CrossCorrelateViews-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">CrossCorrelateViews</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">image_set_0</span>, </span><span class="param"><span class="n">image_set_1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CrossCorrelateViews-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CrossCorrelateViews"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CrossCorrelateViews-824"><a href="#CrossCorrelateViews-824"><span class="linenos">824</span></a><span class="k">def</span> <span class="nf">CrossCorrelateViews</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">):</span>
</span><span id="CrossCorrelateViews-825"><a href="#CrossCorrelateViews-825"><span class="linenos">825</span></a>
</span><span id="CrossCorrelateViews-826"><a href="#CrossCorrelateViews-826"><span class="linenos">826</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="CrossCorrelateViews-827"><a href="#CrossCorrelateViews-827"><span class="linenos">827</span></a>    <span class="c1">#number of intensity values in the subset/template</span>
</span><span id="CrossCorrelateViews-828"><a href="#CrossCorrelateViews-828"><span class="linenos">828</span></a>    
</span><span id="CrossCorrelateViews-829"><a href="#CrossCorrelateViews-829"><span class="linenos">829</span></a>    <span class="c1">#reference subset local/relative coordinates (same for all subsets)</span>
</span><span id="CrossCorrelateViews-830"><a href="#CrossCorrelateViews-830"><span class="linenos">830</span></a>    <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="CrossCorrelateViews-831"><a href="#CrossCorrelateViews-831"><span class="linenos">831</span></a>    <span class="n">CC</span><span class="p">,</span> <span class="n">exit_crits</span><span class="p">,</span> <span class="n">n_iterations</span> <span class="o">=</span> <span class="n">InitialiseConvergenceParamtersLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-832"><a href="#CrossCorrelateViews-832"><span class="linenos">832</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CrossCorrelateViews-833"><a href="#CrossCorrelateViews-833"><span class="linenos">833</span></a>
</span><span id="CrossCorrelateViews-834"><a href="#CrossCorrelateViews-834"><span class="linenos">834</span></a>    <span class="c1">#define reference and target images for current image pair</span>
</span><span id="CrossCorrelateViews-835"><a href="#CrossCorrelateViews-835"><span class="linenos">835</span></a>    <span class="c1">#delF: dFdy = delF[0], dFdx = delF[1]</span>
</span><span id="CrossCorrelateViews-836"><a href="#CrossCorrelateViews-836"><span class="linenos">836</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CrossCorrelateViews-837"><a href="#CrossCorrelateViews-837"><span class="linenos">837</span></a>    <span class="n">F</span><span class="p">,</span> <span class="n">F_8bit</span><span class="p">,</span> <span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">delF_interpolated</span> <span class="o">=</span> <span class="n">ReferenceImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-838"><a href="#CrossCorrelateViews-838"><span class="linenos">838</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="CrossCorrelateViews-839"><a href="#CrossCorrelateViews-839"><span class="linenos">839</span></a>    <span class="n">G</span><span class="p">,</span> <span class="n">G_8bit</span><span class="p">,</span> <span class="n">G_interpolated</span> <span class="o">=</span> <span class="n">DeformedImage</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-840"><a href="#CrossCorrelateViews-840"><span class="linenos">840</span></a>    
</span><span id="CrossCorrelateViews-841"><a href="#CrossCorrelateViews-841"><span class="linenos">841</span></a>    <span class="c1">#deformation model coefficients initialisation (all subsets)</span>
</span><span id="CrossCorrelateViews-842"><a href="#CrossCorrelateViews-842"><span class="linenos">842</span></a>    <span class="c1">#p is the vector of coefficients of the subset deformaton model</span>
</span><span id="CrossCorrelateViews-843"><a href="#CrossCorrelateViews-843"><span class="linenos">843</span></a>    <span class="c1">#initial estimate for the incremental update of the model coefficients</span>
</span><span id="CrossCorrelateViews-844"><a href="#CrossCorrelateViews-844"><span class="linenos">844</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-845"><a href="#CrossCorrelateViews-845"><span class="linenos">845</span></a>
</span><span id="CrossCorrelateViews-846"><a href="#CrossCorrelateViews-846"><span class="linenos">846</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="CrossCorrelateViews-847"><a href="#CrossCorrelateViews-847"><span class="linenos">847</span></a>        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="CrossCorrelateViews-848"><a href="#CrossCorrelateViews-848"><span class="linenos">848</span></a>        <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="CrossCorrelateViews-849"><a href="#CrossCorrelateViews-849"><span class="linenos">849</span></a>    
</span><span id="CrossCorrelateViews-850"><a href="#CrossCorrelateViews-850"><span class="linenos">850</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-851"><a href="#CrossCorrelateViews-851"><span class="linenos">851</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">12</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">])</span>
</span><span id="CrossCorrelateViews-852"><a href="#CrossCorrelateViews-852"><span class="linenos">852</span></a>        <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="CrossCorrelateViews-853"><a href="#CrossCorrelateViews-853"><span class="linenos">853</span></a>        <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="CrossCorrelateViews-854"><a href="#CrossCorrelateViews-854"><span class="linenos">854</span></a>
</span><span id="CrossCorrelateViews-855"><a href="#CrossCorrelateViews-855"><span class="linenos">855</span></a>    <span class="n">Xo2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">])</span>
</span><span id="CrossCorrelateViews-856"><a href="#CrossCorrelateViews-856"><span class="linenos">856</span></a>    <span class="k">for</span> <span class="n">i_subset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_subsets</span><span class="p">):</span>
</span><span id="CrossCorrelateViews-857"><a href="#CrossCorrelateViews-857"><span class="linenos">857</span></a>        
</span><span id="CrossCorrelateViews-858"><a href="#CrossCorrelateViews-858"><span class="linenos">858</span></a>        <span class="c1">#measurement point/subset centre coordinates for i&#39;th/current subset</span>
</span><span id="CrossCorrelateViews-859"><a href="#CrossCorrelateViews-859"><span class="linenos">859</span></a>        <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span> <span class="o">=</span> <span class="p">[</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i_subset</span><span class="p">],</span>
</span><span id="CrossCorrelateViews-860"><a href="#CrossCorrelateViews-860"><span class="linenos">860</span></a>                   <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i_subset</span><span class="p">]</span> <span class="p">]</span>
</span><span id="CrossCorrelateViews-861"><a href="#CrossCorrelateViews-861"><span class="linenos">861</span></a>
</span><span id="CrossCorrelateViews-862"><a href="#CrossCorrelateViews-862"><span class="linenos">862</span></a>        <span class="c1">#intensity data for reference subset</span>
</span><span id="CrossCorrelateViews-863"><a href="#CrossCorrelateViews-863"><span class="linenos">863</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-864"><a href="#CrossCorrelateViews-864"><span class="linenos">864</span></a>            <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="n">delf</span> <span class="o">=</span> <span class="n">ReferenceSubset</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-865"><a href="#CrossCorrelateViews-865"><span class="linenos">865</span></a>
</span><span id="CrossCorrelateViews-866"><a href="#CrossCorrelateViews-866"><span class="linenos">866</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-867"><a href="#CrossCorrelateViews-867"><span class="linenos">867</span></a>            <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="n">delf</span> <span class="o">=</span> <span class="n">ReferenceSubset</span><span class="p">(</span><span class="n">F_interpolated</span><span class="p">,</span> <span class="n">delF_interpolated</span><span class="p">,</span>
</span><span id="CrossCorrelateViews-868"><a href="#CrossCorrelateViews-868"><span class="linenos">868</span></a>                                                       <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-869"><a href="#CrossCorrelateViews-869"><span class="linenos">869</span></a>
</span><span id="CrossCorrelateViews-870"><a href="#CrossCorrelateViews-870"><span class="linenos">870</span></a>        <span class="c1">#Hessian and Jacobian operators for GN optimization routine, derived from</span>
</span><span id="CrossCorrelateViews-871"><a href="#CrossCorrelateViews-871"><span class="linenos">871</span></a>        <span class="c1">#reference subset intensity gradient data</span>
</span><span id="CrossCorrelateViews-872"><a href="#CrossCorrelateViews-872"><span class="linenos">872</span></a>        <span class="n">H</span><span class="p">,</span> <span class="n">J</span> <span class="o">=</span> <span class="n">HessianLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delf</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-873"><a href="#CrossCorrelateViews-873"><span class="linenos">873</span></a>
</span><span id="CrossCorrelateViews-874"><a href="#CrossCorrelateViews-874"><span class="linenos">874</span></a>        <span class="c1">#initial estimate for the incremental update of the model coefficients</span>
</span><span id="CrossCorrelateViews-875"><a href="#CrossCorrelateViews-875"><span class="linenos">875</span></a>        <span class="n">delta_p_i</span> <span class="o">=</span> <span class="n">InitialiseCoefficientUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-876"><a href="#CrossCorrelateViews-876"><span class="linenos">876</span></a>
</span><span id="CrossCorrelateViews-877"><a href="#CrossCorrelateViews-877"><span class="linenos">877</span></a>        <span class="c1">#model coefficients</span>
</span><span id="CrossCorrelateViews-878"><a href="#CrossCorrelateViews-878"><span class="linenos">878</span></a>        <span class="n">p_i</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="n">i_subset</span><span class="p">]</span>
</span><span id="CrossCorrelateViews-879"><a href="#CrossCorrelateViews-879"><span class="linenos">879</span></a>
</span><span id="CrossCorrelateViews-880"><a href="#CrossCorrelateViews-880"><span class="linenos">880</span></a>        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="CrossCorrelateViews-881"><a href="#CrossCorrelateViews-881"><span class="linenos">881</span></a>        <span class="c1">#perform GN optimisation routine</span>
</span><span id="CrossCorrelateViews-882"><a href="#CrossCorrelateViews-882"><span class="linenos">882</span></a>        <span class="k">while</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-883"><a href="#CrossCorrelateViews-883"><span class="linenos">883</span></a>            
</span><span id="CrossCorrelateViews-884"><a href="#CrossCorrelateViews-884"><span class="linenos">884</span></a>            <span class="c1">#relative coordinates of intensity values within subset</span>
</span><span id="CrossCorrelateViews-885"><a href="#CrossCorrelateViews-885"><span class="linenos">885</span></a>            <span class="c1">#of deformed image, based on current iteration of deformation model</span>
</span><span id="CrossCorrelateViews-886"><a href="#CrossCorrelateViews-886"><span class="linenos">886</span></a>            <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span> <span class="o">=</span> <span class="n">DeformationModelSubset</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-887"><a href="#CrossCorrelateViews-887"><span class="linenos">887</span></a>            <span class="c1">#intensity data of deformed subset</span>
</span><span id="CrossCorrelateViews-888"><a href="#CrossCorrelateViews-888"><span class="linenos">888</span></a>            <span class="n">g</span><span class="p">,</span> <span class="n">g_mean</span><span class="p">,</span> <span class="n">g_tilde</span> <span class="o">=</span> <span class="n">DeformedSubset</span><span class="p">(</span><span class="n">G_interpolated</span><span class="p">,</span> <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-889"><a href="#CrossCorrelateViews-889"><span class="linenos">889</span></a>            <span class="c1">#</span>
</span><span id="CrossCorrelateViews-890"><a href="#CrossCorrelateViews-890"><span class="linenos">890</span></a>            <span class="n">exit_criteria</span> <span class="o">=</span> <span class="n">ExitCriteriaLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delta_p_i</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="CrossCorrelateViews-891"><a href="#CrossCorrelateViews-891"><span class="linenos">891</span></a>            <span class="k">if</span> <span class="n">exit_criteria</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-892"><a href="#CrossCorrelateViews-892"><span class="linenos">892</span></a>                <span class="k">break</span> 
</span><span id="CrossCorrelateViews-893"><a href="#CrossCorrelateViews-893"><span class="linenos">893</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-894"><a href="#CrossCorrelateViews-894"><span class="linenos">894</span></a>                <span class="n">residual</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="o">-</span><span class="n">f_tilde</span><span class="o">/</span><span class="n">g_tilde</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-895"><a href="#CrossCorrelateViews-895"><span class="linenos">895</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-896"><a href="#CrossCorrelateViews-896"><span class="linenos">896</span></a>                <span class="c1">#Gauss-Newton update of deformation model coefficients (for current subset)</span>
</span><span id="CrossCorrelateViews-897"><a href="#CrossCorrelateViews-897"><span class="linenos">897</span></a>                <span class="c1">#i.e solve the linear system H*dp = b for i&#39;th subset</span>
</span><span id="CrossCorrelateViews-898"><a href="#CrossCorrelateViews-898"><span class="linenos">898</span></a>                <span class="n">delta_p_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> 
</span><span id="CrossCorrelateViews-899"><a href="#CrossCorrelateViews-899"><span class="linenos">899</span></a>                <span class="n">p_i</span> <span class="o">=</span> <span class="n">CompositionalUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">delta_p_i</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-900"><a href="#CrossCorrelateViews-900"><span class="linenos">900</span></a>
</span><span id="CrossCorrelateViews-901"><a href="#CrossCorrelateViews-901"><span class="linenos">901</span></a>            <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="CrossCorrelateViews-902"><a href="#CrossCorrelateViews-902"><span class="linenos">902</span></a>        <span class="c1">#store convergence information for current subset</span>
</span><span id="CrossCorrelateViews-903"><a href="#CrossCorrelateViews-903"><span class="linenos">903</span></a>        <span class="c1">#coefficients of deformation model, correlation criterion,</span>
</span><span id="CrossCorrelateViews-904"><a href="#CrossCorrelateViews-904"><span class="linenos">904</span></a>        <span class="c1">#exit criterion, number of iterations</span>
</span><span id="CrossCorrelateViews-905"><a href="#CrossCorrelateViews-905"><span class="linenos">905</span></a>        <span class="n">CC</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(((</span><span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="p">)</span><span class="o">/</span><span class="n">f_tilde</span><span class="o">-</span><span class="p">(</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span><span class="o">/</span><span class="n">g_tilde</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
</span><span id="CrossCorrelateViews-906"><a href="#CrossCorrelateViews-906"><span class="linenos">906</span></a>        <span class="n">exit_crits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">exit_criteria</span>
</span><span id="CrossCorrelateViews-907"><a href="#CrossCorrelateViews-907"><span class="linenos">907</span></a>        <span class="n">n_iterations</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span>  <span class="o">=</span> <span class="n">iteration</span>
</span><span id="CrossCorrelateViews-908"><a href="#CrossCorrelateViews-908"><span class="linenos">908</span></a>        <span class="n">p</span><span class="p">[:,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_i</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
</span><span id="CrossCorrelateViews-909"><a href="#CrossCorrelateViews-909"><span class="linenos">909</span></a>
</span><span id="CrossCorrelateViews-910"><a href="#CrossCorrelateViews-910"><span class="linenos">910</span></a>        <span class="c1">#check interpolation of the reference image</span>
</span><span id="CrossCorrelateViews-911"><a href="#CrossCorrelateViews-911"><span class="linenos">911</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-912"><a href="#CrossCorrelateViews-912"><span class="linenos">912</span></a>            
</span><span id="CrossCorrelateViews-913"><a href="#CrossCorrelateViews-913"><span class="linenos">913</span></a>            <span class="c1">#check the deformation model order</span>
</span><span id="CrossCorrelateViews-914"><a href="#CrossCorrelateViews-914"><span class="linenos">914</span></a>            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-915"><a href="#CrossCorrelateViews-915"><span class="linenos">915</span></a>
</span><span id="CrossCorrelateViews-916"><a href="#CrossCorrelateViews-916"><span class="linenos">916</span></a>                <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="CrossCorrelateViews-917"><a href="#CrossCorrelateViews-917"><span class="linenos">917</span></a>                                                        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="p">]</span>   
</span><span id="CrossCorrelateViews-918"><a href="#CrossCorrelateViews-918"><span class="linenos">918</span></a>            <span class="k">else</span><span class="p">:</span> 
</span><span id="CrossCorrelateViews-919"><a href="#CrossCorrelateViews-919"><span class="linenos">919</span></a>                
</span><span id="CrossCorrelateViews-920"><a href="#CrossCorrelateViews-920"><span class="linenos">920</span></a>                <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span>
</span><span id="CrossCorrelateViews-921"><a href="#CrossCorrelateViews-921"><span class="linenos">921</span></a>                                                        <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">yo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="p">]</span>
</span><span id="CrossCorrelateViews-922"><a href="#CrossCorrelateViews-922"><span class="linenos">922</span></a>
</span><span id="CrossCorrelateViews-923"><a href="#CrossCorrelateViews-923"><span class="linenos">923</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-924"><a href="#CrossCorrelateViews-924"><span class="linenos">924</span></a>
</span><span id="CrossCorrelateViews-925"><a href="#CrossCorrelateViews-925"><span class="linenos">925</span></a>            <span class="c1">#check the deformation model order</span>
</span><span id="CrossCorrelateViews-926"><a href="#CrossCorrelateViews-926"><span class="linenos">926</span></a>            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-927"><a href="#CrossCorrelateViews-927"><span class="linenos">927</span></a>            
</span><span id="CrossCorrelateViews-928"><a href="#CrossCorrelateViews-928"><span class="linenos">928</span></a>                <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">xo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span>
</span><span id="CrossCorrelateViews-929"><a href="#CrossCorrelateViews-929"><span class="linenos">929</span></a>                                                        <span class="n">yo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="p">]</span>
</span><span id="CrossCorrelateViews-930"><a href="#CrossCorrelateViews-930"><span class="linenos">930</span></a>                
</span><span id="CrossCorrelateViews-931"><a href="#CrossCorrelateViews-931"><span class="linenos">931</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="CrossCorrelateViews-932"><a href="#CrossCorrelateViews-932"><span class="linenos">932</span></a>
</span><span id="CrossCorrelateViews-933"><a href="#CrossCorrelateViews-933"><span class="linenos">933</span></a>                <span class="n">Xo2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span> <span class="n">Xo2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">xo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">],</span>
</span><span id="CrossCorrelateViews-934"><a href="#CrossCorrelateViews-934"><span class="linenos">934</span></a>                                                        <span class="n">yo</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="n">i_subset</span><span class="p">]</span> <span class="p">]</span>   
</span><span id="CrossCorrelateViews-935"><a href="#CrossCorrelateViews-935"><span class="linenos">935</span></a>
</span><span id="CrossCorrelateViews-936"><a href="#CrossCorrelateViews-936"><span class="linenos">936</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s2">&quot;R_measurement_points_CC.csv&quot;</span><span class="p">,</span> <span class="n">CC</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-937"><a href="#CrossCorrelateViews-937"><span class="linenos">937</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo2</span>
</span><span id="CrossCorrelateViews-938"><a href="#CrossCorrelateViews-938"><span class="linenos">938</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo2</span>
</span><span id="CrossCorrelateViews-939"><a href="#CrossCorrelateViews-939"><span class="linenos">939</span></a>    <span class="c1">##np.savetxt(&quot;R_measurement_points.csv&quot;, Xo2, delimiter = &quot;,&quot;)</span>
</span><span id="CrossCorrelateViews-940"><a href="#CrossCorrelateViews-940"><span class="linenos">940</span></a>
</span><span id="CrossCorrelateViews-941"><a href="#CrossCorrelateViews-941"><span class="linenos">941</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Cross Correlation complete&#39;</span><span class="p">)</span>
</span><span id="CrossCorrelateViews-942"><a href="#CrossCorrelateViews-942"><span class="linenos">942</span></a>
</span><span id="CrossCorrelateViews-943"><a href="#CrossCorrelateViews-943"><span class="linenos">943</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="CompositionalUpdate">
                            <input id="CompositionalUpdate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">CompositionalUpdate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">p</span>, </span><span class="param"><span class="n">dp</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="CompositionalUpdate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CompositionalUpdate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CompositionalUpdate-945"><a href="#CompositionalUpdate-945"><span class="linenos"> 945</span></a><span class="k">def</span> <span class="nf">CompositionalUpdate</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dp</span><span class="p">):</span>
</span><span id="CompositionalUpdate-946"><a href="#CompositionalUpdate-946"><span class="linenos"> 946</span></a>
</span><span id="CompositionalUpdate-947"><a href="#CompositionalUpdate-947"><span class="linenos"> 947</span></a>    <span class="c1">#</span>
</span><span id="CompositionalUpdate-948"><a href="#CompositionalUpdate-948"><span class="linenos"> 948</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="CompositionalUpdate-949"><a href="#CompositionalUpdate-949"><span class="linenos"> 949</span></a>        <span class="c1">#w of current estimate of SFPs</span>
</span><span id="CompositionalUpdate-950"><a href="#CompositionalUpdate-950"><span class="linenos"> 950</span></a>        <span class="c1">#order of SFP&#39;s P[1]: 0,  1,  2,  3,  4,  5</span>
</span><span id="CompositionalUpdate-951"><a href="#CompositionalUpdate-951"><span class="linenos"> 951</span></a>        <span class="c1">#                     u   ux  uy  v   vx  vy</span>
</span><span id="CompositionalUpdate-952"><a href="#CompositionalUpdate-952"><span class="linenos"> 952</span></a>        <span class="n">w_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>    <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>    <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-953"><a href="#CompositionalUpdate-953"><span class="linenos"> 953</span></a>                         <span class="p">[</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>    <span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>   <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-954"><a href="#CompositionalUpdate-954"><span class="linenos"> 954</span></a>                         <span class="p">[</span>  <span class="mi">0</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span>        <span class="mi">1</span> <span class="p">]</span> <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="CompositionalUpdate-955"><a href="#CompositionalUpdate-955"><span class="linenos"> 955</span></a>
</span><span id="CompositionalUpdate-956"><a href="#CompositionalUpdate-956"><span class="linenos"> 956</span></a>        <span class="c1">#w of current delta_p               </span>
</span><span id="CompositionalUpdate-957"><a href="#CompositionalUpdate-957"><span class="linenos"> 957</span></a>        <span class="n">w_dP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>     <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>    <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-958"><a href="#CompositionalUpdate-958"><span class="linenos"> 958</span></a>                          <span class="p">[</span> <span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>     <span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>   <span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-959"><a href="#CompositionalUpdate-959"><span class="linenos"> 959</span></a>                          <span class="p">[</span>   <span class="mi">0</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>        <span class="mi">1</span>  <span class="p">]</span> <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="CompositionalUpdate-960"><a href="#CompositionalUpdate-960"><span class="linenos"> 960</span></a>
</span><span id="CompositionalUpdate-961"><a href="#CompositionalUpdate-961"><span class="linenos"> 961</span></a>        <span class="c1">#p coefficients compositional update matrix                </span>
</span><span id="CompositionalUpdate-962"><a href="#CompositionalUpdate-962"><span class="linenos"> 962</span></a>        <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">w_dP</span><span class="p">,</span><span class="n">w_P</span><span class="p">)</span>
</span><span id="CompositionalUpdate-963"><a href="#CompositionalUpdate-963"><span class="linenos"> 963</span></a>
</span><span id="CompositionalUpdate-964"><a href="#CompositionalUpdate-964"><span class="linenos"> 964</span></a>        <span class="c1">#extract updated coefficients from p update/up matrix</span>
</span><span id="CompositionalUpdate-965"><a href="#CompositionalUpdate-965"><span class="linenos"> 965</span></a>        <span class="n">subset_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-966"><a href="#CompositionalUpdate-966"><span class="linenos"> 966</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="CompositionalUpdate-967"><a href="#CompositionalUpdate-967"><span class="linenos"> 967</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-968"><a href="#CompositionalUpdate-968"><span class="linenos"> 968</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-969"><a href="#CompositionalUpdate-969"><span class="linenos"> 969</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-970"><a href="#CompositionalUpdate-970"><span class="linenos"> 970</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">])</span>
</span><span id="CompositionalUpdate-971"><a href="#CompositionalUpdate-971"><span class="linenos"> 971</span></a>
</span><span id="CompositionalUpdate-972"><a href="#CompositionalUpdate-972"><span class="linenos"> 972</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="CompositionalUpdate-973"><a href="#CompositionalUpdate-973"><span class="linenos"> 973</span></a>        <span class="c1">#order of SFP&#39;s P[j]: 0,  1,  2,   3,   4,   5,  6,  7,  8,   9,   10,    11</span>
</span><span id="CompositionalUpdate-974"><a href="#CompositionalUpdate-974"><span class="linenos"> 974</span></a>        <span class="c1">#                     u   ux  uy  uxx  uxy  uyy  v   vx  vy  vxx   vxy   vyy</span>
</span><span id="CompositionalUpdate-975"><a href="#CompositionalUpdate-975"><span class="linenos"> 975</span></a>        <span class="n">A1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
</span><span id="CompositionalUpdate-976"><a href="#CompositionalUpdate-976"><span class="linenos"> 976</span></a>        <span class="n">A2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="CompositionalUpdate-977"><a href="#CompositionalUpdate-977"><span class="linenos"> 977</span></a>        <span class="n">A3</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="CompositionalUpdate-978"><a href="#CompositionalUpdate-978"><span class="linenos"> 978</span></a>        <span class="n">A4</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CompositionalUpdate-979"><a href="#CompositionalUpdate-979"><span class="linenos"> 979</span></a>        <span class="n">A5</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="CompositionalUpdate-980"><a href="#CompositionalUpdate-980"><span class="linenos"> 980</span></a>        <span class="n">A6</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CompositionalUpdate-981"><a href="#CompositionalUpdate-981"><span class="linenos"> 981</span></a>        <span class="n">A7</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> 
</span><span id="CompositionalUpdate-982"><a href="#CompositionalUpdate-982"><span class="linenos"> 982</span></a>        <span class="n">A8</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CompositionalUpdate-983"><a href="#CompositionalUpdate-983"><span class="linenos"> 983</span></a>        <span class="n">A9</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
</span><span id="CompositionalUpdate-984"><a href="#CompositionalUpdate-984"><span class="linenos"> 984</span></a>        <span class="n">A10</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
</span><span id="CompositionalUpdate-985"><a href="#CompositionalUpdate-985"><span class="linenos"> 985</span></a>        <span class="n">A11</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
</span><span id="CompositionalUpdate-986"><a href="#CompositionalUpdate-986"><span class="linenos"> 986</span></a>        <span class="n">A12</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span><span id="CompositionalUpdate-987"><a href="#CompositionalUpdate-987"><span class="linenos"> 987</span></a>        <span class="n">A13</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
</span><span id="CompositionalUpdate-988"><a href="#CompositionalUpdate-988"><span class="linenos"> 988</span></a>        <span class="n">A14</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="CompositionalUpdate-989"><a href="#CompositionalUpdate-989"><span class="linenos"> 989</span></a>        <span class="n">A15</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
</span><span id="CompositionalUpdate-990"><a href="#CompositionalUpdate-990"><span class="linenos"> 990</span></a>        <span class="n">A16</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> 
</span><span id="CompositionalUpdate-991"><a href="#CompositionalUpdate-991"><span class="linenos"> 991</span></a>        <span class="n">A17</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="CompositionalUpdate-992"><a href="#CompositionalUpdate-992"><span class="linenos"> 992</span></a>        <span class="n">A18</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CompositionalUpdate-993"><a href="#CompositionalUpdate-993"><span class="linenos"> 993</span></a>
</span><span id="CompositionalUpdate-994"><a href="#CompositionalUpdate-994"><span class="linenos"> 994</span></a>        <span class="c1">#entries of w for update</span>
</span><span id="CompositionalUpdate-995"><a href="#CompositionalUpdate-995"><span class="linenos"> 995</span></a>        <span class="n">dA1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
</span><span id="CompositionalUpdate-996"><a href="#CompositionalUpdate-996"><span class="linenos"> 996</span></a>        <span class="n">dA2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="CompositionalUpdate-997"><a href="#CompositionalUpdate-997"><span class="linenos"> 997</span></a>        <span class="n">dA3</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span id="CompositionalUpdate-998"><a href="#CompositionalUpdate-998"><span class="linenos"> 998</span></a>        <span class="n">dA4</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="CompositionalUpdate-999"><a href="#CompositionalUpdate-999"><span class="linenos"> 999</span></a>        <span class="n">dA5</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="CompositionalUpdate-1000"><a href="#CompositionalUpdate-1000"><span class="linenos">1000</span></a>        <span class="n">dA6</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CompositionalUpdate-1001"><a href="#CompositionalUpdate-1001"><span class="linenos">1001</span></a>        <span class="n">dA7</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> 
</span><span id="CompositionalUpdate-1002"><a href="#CompositionalUpdate-1002"><span class="linenos">1002</span></a>        <span class="n">dA8</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="CompositionalUpdate-1003"><a href="#CompositionalUpdate-1003"><span class="linenos">1003</span></a>        <span class="n">dA9</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
</span><span id="CompositionalUpdate-1004"><a href="#CompositionalUpdate-1004"><span class="linenos">1004</span></a>        <span class="n">dA10</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
</span><span id="CompositionalUpdate-1005"><a href="#CompositionalUpdate-1005"><span class="linenos">1005</span></a>        <span class="n">dA11</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
</span><span id="CompositionalUpdate-1006"><a href="#CompositionalUpdate-1006"><span class="linenos">1006</span></a>        <span class="n">dA12</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span><span id="CompositionalUpdate-1007"><a href="#CompositionalUpdate-1007"><span class="linenos">1007</span></a>        <span class="n">dA13</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
</span><span id="CompositionalUpdate-1008"><a href="#CompositionalUpdate-1008"><span class="linenos">1008</span></a>        <span class="n">dA14</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="CompositionalUpdate-1009"><a href="#CompositionalUpdate-1009"><span class="linenos">1009</span></a>        <span class="n">dA15</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>  <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
</span><span id="CompositionalUpdate-1010"><a href="#CompositionalUpdate-1010"><span class="linenos">1010</span></a>        <span class="n">dA16</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> 
</span><span id="CompositionalUpdate-1011"><a href="#CompositionalUpdate-1011"><span class="linenos">1011</span></a>        <span class="n">dA17</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
</span><span id="CompositionalUpdate-1012"><a href="#CompositionalUpdate-1012"><span class="linenos">1012</span></a>        <span class="n">dA18</span> <span class="o">=</span> <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
</span><span id="CompositionalUpdate-1013"><a href="#CompositionalUpdate-1013"><span class="linenos">1013</span></a>
</span><span id="CompositionalUpdate-1014"><a href="#CompositionalUpdate-1014"><span class="linenos">1014</span></a>        <span class="c1">#order of SFP&#39;s P[j]: 0,  1,  2,   3,   4,   5,  6,  7,  8,   9,   10,    11</span>
</span><span id="CompositionalUpdate-1015"><a href="#CompositionalUpdate-1015"><span class="linenos">1015</span></a>        <span class="c1">#                     u   ux  uy  uxx  uxy  uyy  v   vx  vy  vxx   vxy   vyy</span>
</span><span id="CompositionalUpdate-1016"><a href="#CompositionalUpdate-1016"><span class="linenos">1016</span></a>        <span class="c1">#w of current estimate of SFP&#39;s</span>
</span><span id="CompositionalUpdate-1017"><a href="#CompositionalUpdate-1017"><span class="linenos">1017</span></a>        <span class="n">w_P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">A1</span><span class="p">,</span>       <span class="n">A2</span><span class="p">,</span>       <span class="n">A3</span><span class="p">,</span>       <span class="n">A4</span><span class="p">,</span>     <span class="n">A5</span><span class="p">,</span>      <span class="n">A6</span><span class="p">],</span>
</span><span id="CompositionalUpdate-1018"><a href="#CompositionalUpdate-1018"><span class="linenos">1018</span></a>                         <span class="p">[</span> <span class="n">A7</span><span class="p">,</span>       <span class="mi">1</span><span class="o">+</span><span class="n">A8</span><span class="p">,</span>      <span class="n">A9</span><span class="p">,</span>      <span class="n">A10</span><span class="p">,</span>    <span class="n">A11</span><span class="p">,</span>     <span class="n">A12</span><span class="p">],</span>
</span><span id="CompositionalUpdate-1019"><a href="#CompositionalUpdate-1019"><span class="linenos">1019</span></a>                         <span class="p">[</span><span class="n">A13</span><span class="p">,</span>       <span class="n">A14</span><span class="p">,</span>     <span class="mi">1</span><span class="o">+</span> <span class="n">A15</span><span class="p">,</span>    <span class="n">A16</span><span class="p">,</span>    <span class="n">A17</span><span class="p">,</span>     <span class="n">A18</span><span class="p">],</span>
</span><span id="CompositionalUpdate-1020"><a href="#CompositionalUpdate-1020"><span class="linenos">1020</span></a>                         <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>   <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>   <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1021"><a href="#CompositionalUpdate-1021"><span class="linenos">1021</span></a>                         <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>  <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>  <span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>  <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1022"><a href="#CompositionalUpdate-1022"><span class="linenos">1022</span></a>                         <span class="p">[</span><span class="mi">0</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span><span class="p">,</span>        <span class="mi">1</span><span class="p">]</span> 
</span><span id="CompositionalUpdate-1023"><a href="#CompositionalUpdate-1023"><span class="linenos">1023</span></a>
</span><span id="CompositionalUpdate-1024"><a href="#CompositionalUpdate-1024"><span class="linenos">1024</span></a>                       <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="CompositionalUpdate-1025"><a href="#CompositionalUpdate-1025"><span class="linenos">1025</span></a>                        
</span><span id="CompositionalUpdate-1026"><a href="#CompositionalUpdate-1026"><span class="linenos">1026</span></a>        <span class="c1">#w of current deltaP</span>
</span><span id="CompositionalUpdate-1027"><a href="#CompositionalUpdate-1027"><span class="linenos">1027</span></a>        <span class="n">w_dP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">dA1</span><span class="p">,</span>       <span class="n">dA2</span><span class="p">,</span>       <span class="n">dA3</span><span class="p">,</span>       <span class="n">dA4</span><span class="p">,</span>     <span class="n">dA5</span><span class="p">,</span>      <span class="n">dA6</span><span class="p">],</span>
</span><span id="CompositionalUpdate-1028"><a href="#CompositionalUpdate-1028"><span class="linenos">1028</span></a>                          <span class="p">[</span> <span class="n">dA7</span><span class="p">,</span>       <span class="mi">1</span><span class="o">+</span><span class="n">dA8</span><span class="p">,</span>      <span class="n">dA9</span><span class="p">,</span>      <span class="n">dA10</span><span class="p">,</span>    <span class="n">dA11</span><span class="p">,</span>     <span class="n">dA12</span><span class="p">],</span>
</span><span id="CompositionalUpdate-1029"><a href="#CompositionalUpdate-1029"><span class="linenos">1029</span></a>                          <span class="p">[</span><span class="n">dA13</span><span class="p">,</span>       <span class="n">dA14</span><span class="p">,</span>     <span class="mi">1</span><span class="o">+</span> <span class="n">dA15</span><span class="p">,</span>    <span class="n">dA16</span><span class="p">,</span>    <span class="n">dA17</span><span class="p">,</span>     <span class="n">dA18</span><span class="p">],</span>
</span><span id="CompositionalUpdate-1030"><a href="#CompositionalUpdate-1030"><span class="linenos">1030</span></a>                          <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>   <span class="mf">0.5</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>   <span class="n">dp</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1031"><a href="#CompositionalUpdate-1031"><span class="linenos">1031</span></a>                          <span class="p">[</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>  <span class="mf">0.5</span><span class="o">*</span><span class="n">dp</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>  <span class="mi">1</span><span class="o">+</span><span class="n">dp</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>  <span class="n">dp</span><span class="p">[</span><span class="mi">6</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1032"><a href="#CompositionalUpdate-1032"><span class="linenos">1032</span></a>                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>       <span class="mi">0</span><span class="p">,</span>         <span class="mi">1</span><span class="p">]</span>
</span><span id="CompositionalUpdate-1033"><a href="#CompositionalUpdate-1033"><span class="linenos">1033</span></a>
</span><span id="CompositionalUpdate-1034"><a href="#CompositionalUpdate-1034"><span class="linenos">1034</span></a>                        <span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span>
</span><span id="CompositionalUpdate-1035"><a href="#CompositionalUpdate-1035"><span class="linenos">1035</span></a>                        
</span><span id="CompositionalUpdate-1036"><a href="#CompositionalUpdate-1036"><span class="linenos">1036</span></a>        <span class="c1">#P update matrix                </span>
</span><span id="CompositionalUpdate-1037"><a href="#CompositionalUpdate-1037"><span class="linenos">1037</span></a>        <span class="n">up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">w_dP</span><span class="p">,</span><span class="n">w_P</span><span class="p">)</span>
</span><span id="CompositionalUpdate-1038"><a href="#CompositionalUpdate-1038"><span class="linenos">1038</span></a>        <span class="n">subset_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1039"><a href="#CompositionalUpdate-1039"><span class="linenos">1039</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="CompositionalUpdate-1040"><a href="#CompositionalUpdate-1040"><span class="linenos">1040</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1041"><a href="#CompositionalUpdate-1041"><span class="linenos">1041</span></a>                                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1042"><a href="#CompositionalUpdate-1042"><span class="linenos">1042</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1043"><a href="#CompositionalUpdate-1043"><span class="linenos">1043</span></a>                                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">up</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1044"><a href="#CompositionalUpdate-1044"><span class="linenos">1044</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1045"><a href="#CompositionalUpdate-1045"><span class="linenos">1045</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1046"><a href="#CompositionalUpdate-1046"><span class="linenos">1046</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="CompositionalUpdate-1047"><a href="#CompositionalUpdate-1047"><span class="linenos">1047</span></a>                                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1048"><a href="#CompositionalUpdate-1048"><span class="linenos">1048</span></a>                                         <span class="p">[</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span>
</span><span id="CompositionalUpdate-1049"><a href="#CompositionalUpdate-1049"><span class="linenos">1049</span></a>                                         <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">up</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="p">])</span>
</span><span id="CompositionalUpdate-1050"><a href="#CompositionalUpdate-1050"><span class="linenos">1050</span></a>
</span><span id="CompositionalUpdate-1051"><a href="#CompositionalUpdate-1051"><span class="linenos">1051</span></a>    <span class="k">return</span> <span class="n">subset_coefficients</span>
</span></pre></div>


    

                </section>
                <section id="DeformationModelSubset">
                            <input id="DeformationModelSubset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">DeformationModelSubset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">p</span>, </span><span class="param"><span class="n">xsi</span>, </span><span class="param"><span class="n">eta</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DeformationModelSubset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DeformationModelSubset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DeformationModelSubset-1053"><a href="#DeformationModelSubset-1053"><span class="linenos">1053</span></a><span class="k">def</span> <span class="nf">DeformationModelSubset</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">xsi</span><span class="p">,</span> <span class="n">eta</span><span class="p">):</span>
</span><span id="DeformationModelSubset-1054"><a href="#DeformationModelSubset-1054"><span class="linenos">1054</span></a>    <span class="c1">#p are the subset warp coefficients, abbreviated here as p for readability</span>
</span><span id="DeformationModelSubset-1055"><a href="#DeformationModelSubset-1055"><span class="linenos">1055</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="DeformationModelSubset-1056"><a href="#DeformationModelSubset-1056"><span class="linenos">1056</span></a>        <span class="c1">#displace, stretch and shear subset in xy-coordinates (Affine):</span>
</span><span id="DeformationModelSubset-1057"><a href="#DeformationModelSubset-1057"><span class="linenos">1057</span></a>        <span class="c1">#order of SFP&#39;s p[j]: 0,  1,  2,  3,  4,  5</span>
</span><span id="DeformationModelSubset-1058"><a href="#DeformationModelSubset-1058"><span class="linenos">1058</span></a>        <span class="c1">#                     u   ux  uy  v   vx  vy</span>
</span><span id="DeformationModelSubset-1059"><a href="#DeformationModelSubset-1059"><span class="linenos">1059</span></a>        <span class="n">xsi_d</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">xsi</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DeformationModelSubset-1060"><a href="#DeformationModelSubset-1060"><span class="linenos">1060</span></a>        <span class="n">eta_d</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="DeformationModelSubset-1061"><a href="#DeformationModelSubset-1061"><span class="linenos">1061</span></a>
</span><span id="DeformationModelSubset-1062"><a href="#DeformationModelSubset-1062"><span class="linenos">1062</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="DeformationModelSubset-1063"><a href="#DeformationModelSubset-1063"><span class="linenos">1063</span></a>        <span class="c1">#order of SFP&#39;s p[j]: 0,  1,  2,   3,   4,   5,  6,  7,  8,   9,   10,    11</span>
</span><span id="DeformationModelSubset-1064"><a href="#DeformationModelSubset-1064"><span class="linenos">1064</span></a>        <span class="c1">#                     u   ux  uy  uxx  uxy  uyy  v   vx  vy  vxx   vxy   vyy</span>
</span><span id="DeformationModelSubset-1065"><a href="#DeformationModelSubset-1065"><span class="linenos">1065</span></a>        <span class="n">xsi_d</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">xsi</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DeformationModelSubset-1066"><a href="#DeformationModelSubset-1066"><span class="linenos">1066</span></a>        <span class="n">eta_d</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">*</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">xsi</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">*</span><span class="n">eta</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> 
</span><span id="DeformationModelSubset-1067"><a href="#DeformationModelSubset-1067"><span class="linenos">1067</span></a>    
</span><span id="DeformationModelSubset-1068"><a href="#DeformationModelSubset-1068"><span class="linenos">1068</span></a>    <span class="c1">#xsi_eta_deformed = np.hstack([xsi_d, eta_d])</span>
</span><span id="DeformationModelSubset-1069"><a href="#DeformationModelSubset-1069"><span class="linenos">1069</span></a>    <span class="k">return</span> <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span>
</span></pre></div>


    

                </section>
                <section id="ReferenceSubset">
                            <input id="ReferenceSubset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ReferenceSubset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">F</span>, </span><span class="param"><span class="n">delF</span>, </span><span class="param"><span class="n">sub_size</span>, </span><span class="param"><span class="n">xo</span>, </span><span class="param"><span class="n">yo</span>, </span><span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReferenceSubset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReferenceSubset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReferenceSubset-1071"><a href="#ReferenceSubset-1071"><span class="linenos">1071</span></a><span class="k">def</span> <span class="nf">ReferenceSubset</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">delF</span><span class="p">,</span> <span class="n">sub_size</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
</span><span id="ReferenceSubset-1072"><a href="#ReferenceSubset-1072"><span class="linenos">1072</span></a>
</span><span id="ReferenceSubset-1073"><a href="#ReferenceSubset-1073"><span class="linenos">1073</span></a>    <span class="c1">#extract  refrence subset intensity values, f, from mother image, F,</span>
</span><span id="ReferenceSubset-1074"><a href="#ReferenceSubset-1074"><span class="linenos">1074</span></a>    <span class="c1">#based on subset center coordinates</span>
</span><span id="ReferenceSubset-1075"><a href="#ReferenceSubset-1075"><span class="linenos">1075</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Yes&#39;</span><span class="p">:</span>
</span><span id="ReferenceSubset-1076"><a href="#ReferenceSubset-1076"><span class="linenos">1076</span></a>
</span><span id="ReferenceSubset-1077"><a href="#ReferenceSubset-1077"><span class="linenos">1077</span></a>        <span class="n">yi</span> <span class="o">=</span> <span class="n">yo</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;xsi&#39;</span><span class="p">]</span>
</span><span id="ReferenceSubset-1078"><a href="#ReferenceSubset-1078"><span class="linenos">1078</span></a>        <span class="n">xi</span> <span class="o">=</span> <span class="n">xo</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span>
</span><span id="ReferenceSubset-1079"><a href="#ReferenceSubset-1079"><span class="linenos">1079</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="ReferenceSubset-1080"><a href="#ReferenceSubset-1080"><span class="linenos">1080</span></a>        <span class="n">dfdy</span> <span class="o">=</span> <span class="n">delF</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="ReferenceSubset-1081"><a href="#ReferenceSubset-1081"><span class="linenos">1081</span></a>        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">delF</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="n">yi</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
</span><span id="ReferenceSubset-1082"><a href="#ReferenceSubset-1082"><span class="linenos">1082</span></a>
</span><span id="ReferenceSubset-1083"><a href="#ReferenceSubset-1083"><span class="linenos">1083</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="ReferenceSubset-1084"><a href="#ReferenceSubset-1084"><span class="linenos">1084</span></a>
</span><span id="ReferenceSubset-1085"><a href="#ReferenceSubset-1085"><span class="linenos">1085</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span> <span class="n">yo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">yo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="ReferenceSubset-1086"><a href="#ReferenceSubset-1086"><span class="linenos">1086</span></a>            <span class="n">xo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">xo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span>
</span><span id="ReferenceSubset-1087"><a href="#ReferenceSubset-1087"><span class="linenos">1087</span></a>        <span class="c1"># subset gradients</span>
</span><span id="ReferenceSubset-1088"><a href="#ReferenceSubset-1088"><span class="linenos">1088</span></a>        <span class="c1"># Fy = delF[0], Fx = delF[1]</span>
</span><span id="ReferenceSubset-1089"><a href="#ReferenceSubset-1089"><span class="linenos">1089</span></a>        <span class="n">dfdy</span> <span class="o">=</span> <span class="n">delF</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span> <span class="n">yo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">yo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="ReferenceSubset-1090"><a href="#ReferenceSubset-1090"><span class="linenos">1090</span></a>                        <span class="n">xo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">xo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span>
</span><span id="ReferenceSubset-1091"><a href="#ReferenceSubset-1091"><span class="linenos">1091</span></a>        
</span><span id="ReferenceSubset-1092"><a href="#ReferenceSubset-1092"><span class="linenos">1092</span></a>        <span class="n">dfdx</span> <span class="o">=</span> <span class="n">delF</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span> <span class="n">yo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">yo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="ReferenceSubset-1093"><a href="#ReferenceSubset-1093"><span class="linenos">1093</span></a>                        <span class="n">xo</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span> <span class="n">xo</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">]</span>
</span><span id="ReferenceSubset-1094"><a href="#ReferenceSubset-1094"><span class="linenos">1094</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="ReferenceSubset-1095"><a href="#ReferenceSubset-1095"><span class="linenos">1095</span></a>
</span><span id="ReferenceSubset-1096"><a href="#ReferenceSubset-1096"><span class="linenos">1096</span></a>    <span class="c1">#average subset intensity, and normalsied sum of squared differences</span>
</span><span id="ReferenceSubset-1097"><a href="#ReferenceSubset-1097"><span class="linenos">1097</span></a>    <span class="n">f_mean</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="ReferenceSubset-1098"><a href="#ReferenceSubset-1098"><span class="linenos">1098</span></a>    <span class="n">f_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">f</span><span class="p">[:]</span><span class="o">-</span><span class="n">f_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="ReferenceSubset-1099"><a href="#ReferenceSubset-1099"><span class="linenos">1099</span></a>    
</span><span id="ReferenceSubset-1100"><a href="#ReferenceSubset-1100"><span class="linenos">1100</span></a>    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">f_mean</span><span class="p">,</span> <span class="n">f_tilde</span><span class="p">,</span> <span class="p">[</span><span class="n">dfdy</span><span class="p">,</span> <span class="n">dfdx</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="DeformedSubset">
                            <input id="DeformedSubset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">DeformedSubset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">G_interpolated</span>, </span><span class="param"><span class="n">xsi_d</span>, </span><span class="param"><span class="n">eta_d</span>, </span><span class="param"><span class="n">xo</span>, </span><span class="param"><span class="n">yo</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DeformedSubset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DeformedSubset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DeformedSubset-1102"><a href="#DeformedSubset-1102"><span class="linenos">1102</span></a><span class="k">def</span> <span class="nf">DeformedSubset</span><span class="p">(</span><span class="n">G_interpolated</span><span class="p">,</span> <span class="n">xsi_d</span><span class="p">,</span> <span class="n">eta_d</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">):</span>
</span><span id="DeformedSubset-1103"><a href="#DeformedSubset-1103"><span class="linenos">1103</span></a>
</span><span id="DeformedSubset-1104"><a href="#DeformedSubset-1104"><span class="linenos">1104</span></a>    <span class="c1">#coordintes of intensity values of deformed subset/template</span>
</span><span id="DeformedSubset-1105"><a href="#DeformedSubset-1105"><span class="linenos">1105</span></a>    <span class="c1">#(all intesity values in the subset)</span>
</span><span id="DeformedSubset-1106"><a href="#DeformedSubset-1106"><span class="linenos">1106</span></a>    <span class="n">yd</span> <span class="o">=</span> <span class="n">yo</span> <span class="o">+</span> <span class="n">eta_d</span>
</span><span id="DeformedSubset-1107"><a href="#DeformedSubset-1107"><span class="linenos">1107</span></a>    <span class="n">xd</span> <span class="o">=</span> <span class="n">xo</span> <span class="o">+</span> <span class="n">xsi_d</span>
</span><span id="DeformedSubset-1108"><a href="#DeformedSubset-1108"><span class="linenos">1108</span></a>
</span><span id="DeformedSubset-1109"><a href="#DeformedSubset-1109"><span class="linenos">1109</span></a>    <span class="c1">#extract  deformed subset intensity values, g, from mother image at sub-pixel coordinates</span>
</span><span id="DeformedSubset-1110"><a href="#DeformedSubset-1110"><span class="linenos">1110</span></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G_interpolated</span><span class="p">(</span><span class="n">yd</span><span class="p">,</span> <span class="n">xd</span><span class="p">))</span>
</span><span id="DeformedSubset-1111"><a href="#DeformedSubset-1111"><span class="linenos">1111</span></a>
</span><span id="DeformedSubset-1112"><a href="#DeformedSubset-1112"><span class="linenos">1112</span></a>    <span class="c1">#determine average intensity value of subset g,</span>
</span><span id="DeformedSubset-1113"><a href="#DeformedSubset-1113"><span class="linenos">1113</span></a>    <span class="c1"># and normalised sum of squared differences of subset, g_tilde</span>
</span><span id="DeformedSubset-1114"><a href="#DeformedSubset-1114"><span class="linenos">1114</span></a>    <span class="n">g_mean</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span><span id="DeformedSubset-1115"><a href="#DeformedSubset-1115"><span class="linenos">1115</span></a>    <span class="n">g_tilde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">g</span><span class="p">[:]</span><span class="o">-</span><span class="n">g_mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="DeformedSubset-1116"><a href="#DeformedSubset-1116"><span class="linenos">1116</span></a>
</span><span id="DeformedSubset-1117"><a href="#DeformedSubset-1117"><span class="linenos">1117</span></a>    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">g_mean</span><span class="p">,</span> <span class="n">g_tilde</span>
</span></pre></div>


    

                </section>
                <section id="UpdateMeasurementPoints">
                            <input id="UpdateMeasurementPoints-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">UpdateMeasurementPoints</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">i_coeffs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="UpdateMeasurementPoints-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UpdateMeasurementPoints"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UpdateMeasurementPoints-1119"><a href="#UpdateMeasurementPoints-1119"><span class="linenos">1119</span></a><span class="k">def</span> <span class="nf">UpdateMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">i_coeffs</span><span class="p">):</span>
</span><span id="UpdateMeasurementPoints-1120"><a href="#UpdateMeasurementPoints-1120"><span class="linenos">1120</span></a>    
</span><span id="UpdateMeasurementPoints-1121"><a href="#UpdateMeasurementPoints-1121"><span class="linenos">1121</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="UpdateMeasurementPoints-1122"><a href="#UpdateMeasurementPoints-1122"><span class="linenos">1122</span></a>        
</span><span id="UpdateMeasurementPoints-1123"><a href="#UpdateMeasurementPoints-1123"><span class="linenos">1123</span></a>        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">i_coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_coeffs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="UpdateMeasurementPoints-1124"><a href="#UpdateMeasurementPoints-1124"><span class="linenos">1124</span></a>
</span><span id="UpdateMeasurementPoints-1125"><a href="#UpdateMeasurementPoints-1125"><span class="linenos">1125</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="UpdateMeasurementPoints-1126"><a href="#UpdateMeasurementPoints-1126"><span class="linenos">1126</span></a>        
</span><span id="UpdateMeasurementPoints-1127"><a href="#UpdateMeasurementPoints-1127"><span class="linenos">1127</span></a>        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">i_coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">i_coeffs</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="UpdateMeasurementPoints-1128"><a href="#UpdateMeasurementPoints-1128"><span class="linenos">1128</span></a>            
</span><span id="UpdateMeasurementPoints-1129"><a href="#UpdateMeasurementPoints-1129"><span class="linenos">1129</span></a>    <span class="c1">#(introduce round-off error)</span>
</span><span id="UpdateMeasurementPoints-1130"><a href="#UpdateMeasurementPoints-1130"><span class="linenos">1130</span></a>    <span class="c1">#(if Yes introduce interpolation error)</span>
</span><span id="UpdateMeasurementPoints-1131"><a href="#UpdateMeasurementPoints-1131"><span class="linenos">1131</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;InterpolateReferenceImage&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span>
</span><span id="UpdateMeasurementPoints-1132"><a href="#UpdateMeasurementPoints-1132"><span class="linenos">1132</span></a>        
</span><span id="UpdateMeasurementPoints-1133"><a href="#UpdateMeasurementPoints-1133"><span class="linenos">1133</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
</span><span id="UpdateMeasurementPoints-1134"><a href="#UpdateMeasurementPoints-1134"><span class="linenos">1134</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>                
</span><span id="UpdateMeasurementPoints-1135"><a href="#UpdateMeasurementPoints-1135"><span class="linenos">1135</span></a>
</span><span id="UpdateMeasurementPoints-1136"><a href="#UpdateMeasurementPoints-1136"><span class="linenos">1136</span></a>    <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span>
</span><span id="UpdateMeasurementPoints-1137"><a href="#UpdateMeasurementPoints-1137"><span class="linenos">1137</span></a>                                                                                <span class="n">u</span><span class="p">,</span>
</span><span id="UpdateMeasurementPoints-1138"><a href="#UpdateMeasurementPoints-1138"><span class="linenos">1138</span></a>                                                                                <span class="n">v</span> 
</span><span id="UpdateMeasurementPoints-1139"><a href="#UpdateMeasurementPoints-1139"><span class="linenos">1139</span></a>                                                                              <span class="p">))</span> 
</span><span id="UpdateMeasurementPoints-1140"><a href="#UpdateMeasurementPoints-1140"><span class="linenos">1140</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="UpdateROI">
                            <input id="UpdateROI-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">UpdateROI</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="UpdateROI-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UpdateROI"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UpdateROI-1142"><a href="#UpdateROI-1142"><span class="linenos">1142</span></a><span class="k">def</span> <span class="nf">UpdateROI</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="UpdateROI-1143"><a href="#UpdateROI-1143"><span class="linenos">1143</span></a>
</span><span id="UpdateROI-1144"><a href="#UpdateROI-1144"><span class="linenos">1144</span></a>    <span class="n">xo</span> <span class="o">=</span>  <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="UpdateROI-1145"><a href="#UpdateROI-1145"><span class="linenos">1145</span></a>    <span class="n">yo</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="UpdateROI-1146"><a href="#UpdateROI-1146"><span class="linenos">1146</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">]</span>
</span><span id="UpdateROI-1147"><a href="#UpdateROI-1147"><span class="linenos">1147</span></a>
</span><span id="UpdateROI-1148"><a href="#UpdateROI-1148"><span class="linenos">1148</span></a>    <span class="c1">#ROI of new reference image</span>
</span><span id="UpdateROI-1149"><a href="#UpdateROI-1149"><span class="linenos">1149</span></a>    <span class="n">x_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sub_size</span>
</span><span id="UpdateROI-1150"><a href="#UpdateROI-1150"><span class="linenos">1150</span></a>    <span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">sub_size</span>
</span><span id="UpdateROI-1151"><a href="#UpdateROI-1151"><span class="linenos">1151</span></a>
</span><span id="UpdateROI-1152"><a href="#UpdateROI-1152"><span class="linenos">1152</span></a>    <span class="n">y_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sub_size</span>
</span><span id="UpdateROI-1153"><a href="#UpdateROI-1153"><span class="linenos">1153</span></a>    <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">sub_size</span>
</span><span id="UpdateROI-1154"><a href="#UpdateROI-1154"><span class="linenos">1154</span></a>
</span><span id="UpdateROI-1155"><a href="#UpdateROI-1155"><span class="linenos">1155</span></a>    <span class="n">ROI</span> <span class="o">=</span>  <span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_min</span><span class="p">,</span> <span class="n">x_max</span><span class="o">-</span><span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span><span class="o">-</span><span class="n">y_min</span><span class="p">)</span>
</span><span id="UpdateROI-1156"><a href="#UpdateROI-1156"><span class="linenos">1156</span></a>    
</span><span id="UpdateROI-1157"><a href="#UpdateROI-1157"><span class="linenos">1157</span></a>    <span class="k">return</span> <span class="n">ROI</span>
</span></pre></div>


    

                </section>
                <section id="ExitCriteriaLocal">
                            <input id="ExitCriteriaLocal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ExitCriteriaLocal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">delta_p</span>, </span><span class="param"><span class="n">hw</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ExitCriteriaLocal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ExitCriteriaLocal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ExitCriteriaLocal-1159"><a href="#ExitCriteriaLocal-1159"><span class="linenos">1159</span></a><span class="k">def</span> <span class="nf">ExitCriteriaLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">delta_p</span><span class="p">,</span> <span class="n">hw</span><span class="p">):</span>
</span><span id="ExitCriteriaLocal-1160"><a href="#ExitCriteriaLocal-1160"><span class="linenos">1160</span></a>
</span><span id="ExitCriteriaLocal-1161"><a href="#ExitCriteriaLocal-1161"><span class="linenos">1161</span></a>    <span class="c1">#hw is the half-width of the subset</span>
</span><span id="ExitCriteriaLocal-1162"><a href="#ExitCriteriaLocal-1162"><span class="linenos">1162</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="ExitCriteriaLocal-1163"><a href="#ExitCriteriaLocal-1163"><span class="linenos">1163</span></a>
</span><span id="ExitCriteriaLocal-1164"><a href="#ExitCriteriaLocal-1164"><span class="linenos">1164</span></a>        <span class="n">hw_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span>
</span><span id="ExitCriteriaLocal-1165"><a href="#ExitCriteriaLocal-1165"><span class="linenos">1165</span></a>                               <span class="mi">1</span><span class="p">,</span><span class="n">hw</span><span class="p">,</span><span class="n">hw</span><span class="p">]])</span>
</span><span id="ExitCriteriaLocal-1166"><a href="#ExitCriteriaLocal-1166"><span class="linenos">1166</span></a>
</span><span id="ExitCriteriaLocal-1167"><a href="#ExitCriteriaLocal-1167"><span class="linenos">1167</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="ExitCriteriaLocal-1168"><a href="#ExitCriteriaLocal-1168"><span class="linenos">1168</span></a>
</span><span id="ExitCriteriaLocal-1169"><a href="#ExitCriteriaLocal-1169"><span class="linenos">1169</span></a>        <span class="n">hw_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
</span><span id="ExitCriteriaLocal-1170"><a href="#ExitCriteriaLocal-1170"><span class="linenos">1170</span></a>                              <span class="mi">1</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">hw</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</span><span id="ExitCriteriaLocal-1171"><a href="#ExitCriteriaLocal-1171"><span class="linenos">1171</span></a>    
</span><span id="ExitCriteriaLocal-1172"><a href="#ExitCriteriaLocal-1172"><span class="linenos">1172</span></a>    <span class="n">exit_criteria</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">delta_p</span><span class="o">*</span><span class="n">hw_vector</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
</span><span id="ExitCriteriaLocal-1173"><a href="#ExitCriteriaLocal-1173"><span class="linenos">1173</span></a>
</span><span id="ExitCriteriaLocal-1174"><a href="#ExitCriteriaLocal-1174"><span class="linenos">1174</span></a>    <span class="k">return</span> <span class="n">exit_criteria</span>
</span></pre></div>


    

                </section>
                <section id="IncrementalLocal">
                            <input id="IncrementalLocal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">IncrementalLocal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">image_set</span>, </span><span class="param"><span class="n">ROI</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="IncrementalLocal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IncrementalLocal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IncrementalLocal-1176"><a href="#IncrementalLocal-1176"><span class="linenos">1176</span></a><span class="k">def</span> <span class="nf">IncrementalLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">):</span>
</span><span id="IncrementalLocal-1177"><a href="#IncrementalLocal-1177"><span class="linenos">1177</span></a>        
</span><span id="IncrementalLocal-1178"><a href="#IncrementalLocal-1178"><span class="linenos">1178</span></a>    <span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">n_image_pairs</span> <span class="o">=</span> <span class="n">RefineImageSet</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="IncrementalLocal-1179"><a href="#IncrementalLocal-1179"><span class="linenos">1179</span></a>
</span><span id="IncrementalLocal-1180"><a href="#IncrementalLocal-1180"><span class="linenos">1180</span></a>    <span class="c1">#number of coefficients in deformation model</span>
</span><span id="IncrementalLocal-1181"><a href="#IncrementalLocal-1181"><span class="linenos">1181</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DeformationModel&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Affine&#39;</span><span class="p">:</span>
</span><span id="IncrementalLocal-1182"><a href="#IncrementalLocal-1182"><span class="linenos">1182</span></a>        <span class="n">n_coeffs</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="IncrementalLocal-1183"><a href="#IncrementalLocal-1183"><span class="linenos">1183</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="IncrementalLocal-1184"><a href="#IncrementalLocal-1184"><span class="linenos">1184</span></a>        <span class="n">n_coeffs</span> <span class="o">=</span> <span class="mi">12</span>
</span><span id="IncrementalLocal-1185"><a href="#IncrementalLocal-1185"><span class="linenos">1185</span></a>    
</span><span id="IncrementalLocal-1186"><a href="#IncrementalLocal-1186"><span class="linenos">1186</span></a>    <span class="c1">#storage array for deformation model coefficients of</span>
</span><span id="IncrementalLocal-1187"><a href="#IncrementalLocal-1187"><span class="linenos">1187</span></a>    <span class="c1">#EACH respective image pair</span>
</span><span id="IncrementalLocal-1188"><a href="#IncrementalLocal-1188"><span class="linenos">1188</span></a>    <span class="n">relative_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([(</span><span class="n">n_coeffs</span><span class="o">*</span><span class="n">n_image_pairs</span><span class="p">),</span> 
</span><span id="IncrementalLocal-1189"><a href="#IncrementalLocal-1189"><span class="linenos">1189</span></a>                                 <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="IncrementalLocal-1190"><a href="#IncrementalLocal-1190"><span class="linenos">1190</span></a>    
</span><span id="IncrementalLocal-1191"><a href="#IncrementalLocal-1191"><span class="linenos">1191</span></a>    <span class="c1">#loop through all image pairs in the incremental range</span>
</span><span id="IncrementalLocal-1192"><a href="#IncrementalLocal-1192"><span class="linenos">1192</span></a>    <span class="n">image_pair</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="IncrementalLocal-1193"><a href="#IncrementalLocal-1193"><span class="linenos">1193</span></a>    <span class="k">for</span> <span class="n">i_image</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span><span class="p">,</span> <span class="n">increment</span><span class="p">):</span>
</span><span id="IncrementalLocal-1194"><a href="#IncrementalLocal-1194"><span class="linenos">1194</span></a>
</span><span id="IncrementalLocal-1195"><a href="#IncrementalLocal-1195"><span class="linenos">1195</span></a>        <span class="c1">#coefficients at convergence for current (i&#39;th) image pair</span>
</span><span id="IncrementalLocal-1196"><a href="#IncrementalLocal-1196"><span class="linenos">1196</span></a>        <span class="n">i_coeffs</span> <span class="o">=</span> <span class="n">GaussNewtonLocal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">,</span> <span class="n">image_pair</span><span class="p">)</span>
</span><span id="IncrementalLocal-1197"><a href="#IncrementalLocal-1197"><span class="linenos">1197</span></a>
</span><span id="IncrementalLocal-1198"><a href="#IncrementalLocal-1198"><span class="linenos">1198</span></a>        <span class="c1">#store coefficients at convergence of current image pair</span>
</span><span id="IncrementalLocal-1199"><a href="#IncrementalLocal-1199"><span class="linenos">1199</span></a>        <span class="n">relative_coeffs</span><span class="p">[</span><span class="n">n_coeffs</span><span class="o">*</span><span class="n">image_pair</span><span class="p">:</span>
</span><span id="IncrementalLocal-1200"><a href="#IncrementalLocal-1200"><span class="linenos">1200</span></a>                        <span class="n">n_coeffs</span><span class="o">*</span><span class="n">image_pair</span> <span class="o">+</span> <span class="n">n_coeffs</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">i_coeffs</span>
</span><span id="IncrementalLocal-1201"><a href="#IncrementalLocal-1201"><span class="linenos">1201</span></a>
</span><span id="IncrementalLocal-1202"><a href="#IncrementalLocal-1202"><span class="linenos">1202</span></a>        <span class="c1">#measurement point coordinates and ROI for next image pair</span>
</span><span id="IncrementalLocal-1203"><a href="#IncrementalLocal-1203"><span class="linenos">1203</span></a>        <span class="n">UpdateMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">i_coeffs</span><span class="p">)</span>
</span><span id="IncrementalLocal-1204"><a href="#IncrementalLocal-1204"><span class="linenos">1204</span></a>        <span class="n">ROI</span> <span class="o">=</span> <span class="n">UpdateROI</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</span><span id="IncrementalLocal-1205"><a href="#IncrementalLocal-1205"><span class="linenos">1205</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image pair </span><span class="si">{}</span><span class="s1"> processed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_pair</span><span class="p">))</span>
</span><span id="IncrementalLocal-1206"><a href="#IncrementalLocal-1206"><span class="linenos">1206</span></a>
</span><span id="IncrementalLocal-1207"><a href="#IncrementalLocal-1207"><span class="linenos">1207</span></a>        <span class="n">image_pair</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="IncrementalLocal-1208"><a href="#IncrementalLocal-1208"><span class="linenos">1208</span></a>
</span><span id="IncrementalLocal-1209"><a href="#IncrementalLocal-1209"><span class="linenos">1209</span></a>    <span class="k">return</span> <span class="n">relative_coeffs</span>
</span></pre></div>


    

                </section>
                <section id="RefineImageSet">
                            <input id="RefineImageSet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RefineImageSet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="RefineImageSet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RefineImageSet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RefineImageSet-1211"><a href="#RefineImageSet-1211"><span class="linenos">1211</span></a><span class="k">def</span> <span class="nf">RefineImageSet</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
</span><span id="RefineImageSet-1212"><a href="#RefineImageSet-1212"><span class="linenos">1212</span></a>
</span><span id="RefineImageSet-1213"><a href="#RefineImageSet-1213"><span class="linenos">1213</span></a>    <span class="c1">#indices of datum and target images in image set</span>
</span><span id="RefineImageSet-1214"><a href="#RefineImageSet-1214"><span class="linenos">1214</span></a>    <span class="n">image0</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;DatumImage&#39;</span><span class="p">]</span>
</span><span id="RefineImageSet-1215"><a href="#RefineImageSet-1215"><span class="linenos">1215</span></a>    <span class="n">image_target</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;TargetImage&#39;</span><span class="p">]</span>
</span><span id="RefineImageSet-1216"><a href="#RefineImageSet-1216"><span class="linenos">1216</span></a>    <span class="c1">#size of referencing increment in image set</span>
</span><span id="RefineImageSet-1217"><a href="#RefineImageSet-1217"><span class="linenos">1217</span></a>    <span class="n">increment</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Increment&#39;</span><span class="p">]</span>
</span><span id="RefineImageSet-1218"><a href="#RefineImageSet-1218"><span class="linenos">1218</span></a>    
</span><span id="RefineImageSet-1219"><a href="#RefineImageSet-1219"><span class="linenos">1219</span></a>    <span class="c1">#number of image pairs to process for incremental referencing strategy</span>
</span><span id="RefineImageSet-1220"><a href="#RefineImageSet-1220"><span class="linenos">1220</span></a>    <span class="n">n_image_pairs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">image_target</span> <span class="o">-</span> <span class="n">image0</span><span class="p">)</span><span class="o">/</span><span class="n">increment</span><span class="p">)</span>
</span><span id="RefineImageSet-1221"><a href="#RefineImageSet-1221"><span class="linenos">1221</span></a>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">no. of image pairs:&#39;</span><span class="p">,</span> <span class="n">n_image_pairs</span><span class="p">)</span>
</span><span id="RefineImageSet-1222"><a href="#RefineImageSet-1222"><span class="linenos">1222</span></a>
</span><span id="RefineImageSet-1223"><a href="#RefineImageSet-1223"><span class="linenos">1223</span></a>    <span class="k">return</span> <span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">n_image_pairs</span>
</span></pre></div>


    

                </section>
                <section id="LocalMeasurementPoints">
                            <input id="LocalMeasurementPoints-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">LocalMeasurementPoints</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">ROI</span><span class="o">=</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LocalMeasurementPoints-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LocalMeasurementPoints"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LocalMeasurementPoints-1225"><a href="#LocalMeasurementPoints-1225"><span class="linenos">1225</span></a><span class="k">def</span> <span class="nf">LocalMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="LocalMeasurementPoints-1226"><a href="#LocalMeasurementPoints-1226"><span class="linenos">1226</span></a>    
</span><span id="LocalMeasurementPoints-1227"><a href="#LocalMeasurementPoints-1227"><span class="linenos">1227</span></a>    <span class="c1">#default, case where the entire image should be populated with measurement points</span>
</span><span id="LocalMeasurementPoints-1228"><a href="#LocalMeasurementPoints-1228"><span class="linenos">1228</span></a>    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ROI</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="LocalMeasurementPoints-1229"><a href="#LocalMeasurementPoints-1229"><span class="linenos">1229</span></a>        <span class="n">x_origin</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LocalMeasurementPoints-1230"><a href="#LocalMeasurementPoints-1230"><span class="linenos">1230</span></a>        <span class="n">y_origin</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="LocalMeasurementPoints-1231"><a href="#LocalMeasurementPoints-1231"><span class="linenos">1231</span></a>        <span class="n">x_bound</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImageColumns&#39;</span><span class="p">]</span>
</span><span id="LocalMeasurementPoints-1232"><a href="#LocalMeasurementPoints-1232"><span class="linenos">1232</span></a>        <span class="n">y_bound</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ImageRows&#39;</span><span class="p">]</span>
</span><span id="LocalMeasurementPoints-1233"><a href="#LocalMeasurementPoints-1233"><span class="linenos">1233</span></a>
</span><span id="LocalMeasurementPoints-1234"><a href="#LocalMeasurementPoints-1234"><span class="linenos">1234</span></a>    <span class="c1">#case where the ROI has been manually refined </span>
</span><span id="LocalMeasurementPoints-1235"><a href="#LocalMeasurementPoints-1235"><span class="linenos">1235</span></a>    <span class="k">else</span><span class="p">:</span> 
</span><span id="LocalMeasurementPoints-1236"><a href="#LocalMeasurementPoints-1236"><span class="linenos">1236</span></a>        <span class="n">x_origin</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LocalMeasurementPoints-1237"><a href="#LocalMeasurementPoints-1237"><span class="linenos">1237</span></a>        <span class="n">y_origin</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LocalMeasurementPoints-1238"><a href="#LocalMeasurementPoints-1238"><span class="linenos">1238</span></a>        <span class="n">x_bound</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="LocalMeasurementPoints-1239"><a href="#LocalMeasurementPoints-1239"><span class="linenos">1239</span></a>        <span class="n">y_bound</span> <span class="o">=</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ROI</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</span><span id="LocalMeasurementPoints-1240"><a href="#LocalMeasurementPoints-1240"><span class="linenos">1240</span></a>
</span><span id="LocalMeasurementPoints-1241"><a href="#LocalMeasurementPoints-1241"><span class="linenos">1241</span></a>    <span class="n">sub_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;SubsetSize&#39;</span><span class="p">])</span>
</span><span id="LocalMeasurementPoints-1242"><a href="#LocalMeasurementPoints-1242"><span class="linenos">1242</span></a>    <span class="n">step_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;StepSize&#39;</span><span class="p">])</span>
</span><span id="LocalMeasurementPoints-1243"><a href="#LocalMeasurementPoints-1243"><span class="linenos">1243</span></a>
</span><span id="LocalMeasurementPoints-1244"><a href="#LocalMeasurementPoints-1244"><span class="linenos">1244</span></a>    <span class="c1">#measurement point coordinates: defined in reference image, i.e subset centres</span>
</span><span id="LocalMeasurementPoints-1245"><a href="#LocalMeasurementPoints-1245"><span class="linenos">1245</span></a>    <span class="n">yo</span><span class="p">,</span> <span class="n">xo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">y_origin</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">step_size</span><span class="p">),</span>
</span><span id="LocalMeasurementPoints-1246"><a href="#LocalMeasurementPoints-1246"><span class="linenos">1246</span></a>                                     <span class="nb">int</span><span class="p">(</span><span class="n">y_bound</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
</span><span id="LocalMeasurementPoints-1247"><a href="#LocalMeasurementPoints-1247"><span class="linenos">1247</span></a>                                     <span class="n">step_size</span><span class="p">),</span> 
</span><span id="LocalMeasurementPoints-1248"><a href="#LocalMeasurementPoints-1248"><span class="linenos">1248</span></a>
</span><span id="LocalMeasurementPoints-1249"><a href="#LocalMeasurementPoints-1249"><span class="linenos">1249</span></a>                          <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_origin</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">step_size</span><span class="p">),</span>
</span><span id="LocalMeasurementPoints-1250"><a href="#LocalMeasurementPoints-1250"><span class="linenos">1250</span></a>                                     <span class="nb">int</span><span class="p">(</span><span class="n">x_bound</span> <span class="o">-</span> <span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">sub_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
</span><span id="LocalMeasurementPoints-1251"><a href="#LocalMeasurementPoints-1251"><span class="linenos">1251</span></a>                                     <span class="n">step_size</span><span class="p">),</span>     
</span><span id="LocalMeasurementPoints-1252"><a href="#LocalMeasurementPoints-1252"><span class="linenos">1252</span></a>                                                                
</span><span id="LocalMeasurementPoints-1253"><a href="#LocalMeasurementPoints-1253"><span class="linenos">1253</span></a>                          <span class="n">indexing</span> <span class="o">=</span> <span class="s1">&#39;ij&#39;</span> <span class="p">)</span>
</span><span id="LocalMeasurementPoints-1254"><a href="#LocalMeasurementPoints-1254"><span class="linenos">1254</span></a>                   
</span><span id="LocalMeasurementPoints-1255"><a href="#LocalMeasurementPoints-1255"><span class="linenos">1255</span></a>    <span class="c1">#flatten measurement point coordinates to vectors</span>
</span><span id="LocalMeasurementPoints-1256"><a href="#LocalMeasurementPoints-1256"><span class="linenos">1256</span></a>    <span class="n">xo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xo</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="LocalMeasurementPoints-1257"><a href="#LocalMeasurementPoints-1257"><span class="linenos">1257</span></a>    <span class="n">yo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">yo</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
</span><span id="LocalMeasurementPoints-1258"><a href="#LocalMeasurementPoints-1258"><span class="linenos">1258</span></a>    <span class="n">measurement_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xo</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">yo</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
</span><span id="LocalMeasurementPoints-1259"><a href="#LocalMeasurementPoints-1259"><span class="linenos">1259</span></a>
</span><span id="LocalMeasurementPoints-1260"><a href="#LocalMeasurementPoints-1260"><span class="linenos">1260</span></a>   
</span><span id="LocalMeasurementPoints-1261"><a href="#LocalMeasurementPoints-1261"><span class="linenos">1261</span></a>    <span class="k">return</span> <span class="n">measurement_points</span>
</span></pre></div>


    

                </section>
                <section id="FastInterpolation">
                            <input id="FastInterpolation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">FastInterpolation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FastInterpolation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FastInterpolation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FastInterpolation-1263"><a href="#FastInterpolation-1263"><span class="linenos">1263</span></a><span class="k">def</span> <span class="nf">FastInterpolation</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
</span><span id="FastInterpolation-1264"><a href="#FastInterpolation-1264"><span class="linenos">1264</span></a>
</span><span id="FastInterpolation-1265"><a href="#FastInterpolation-1265"><span class="linenos">1265</span></a>    <span class="c1">#image dimensions</span>
</span><span id="FastInterpolation-1266"><a href="#FastInterpolation-1266"><span class="linenos">1266</span></a>    <span class="n">ny</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="FastInterpolation-1267"><a href="#FastInterpolation-1267"><span class="linenos">1267</span></a>    <span class="n">nx</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="FastInterpolation-1268"><a href="#FastInterpolation-1268"><span class="linenos">1268</span></a>
</span><span id="FastInterpolation-1269"><a href="#FastInterpolation-1269"><span class="linenos">1269</span></a>    <span class="c1">#interpolation</span>
</span><span id="FastInterpolation-1270"><a href="#FastInterpolation-1270"><span class="linenos">1270</span></a>    <span class="n">image_interpolated</span> <span class="o">=</span> <span class="n">interp2d</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="kc">False</span><span class="p">],</span> <span class="n">e</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="FastInterpolation-1271"><a href="#FastInterpolation-1271"><span class="linenos">1271</span></a>    <span class="k">return</span> <span class="n">image_interpolated</span>
</span></pre></div>


    

                </section>
                <section id="GlobalMeasurementPoints">
                            <input id="GlobalMeasurementPoints-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">GlobalMeasurementPoints</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">ROI</span><span class="o">=</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GlobalMeasurementPoints-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GlobalMeasurementPoints"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GlobalMeasurementPoints-1273"><a href="#GlobalMeasurementPoints-1273"><span class="linenos">1273</span></a><span class="k">def</span> <span class="nf">GlobalMeasurementPoints</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="GlobalMeasurementPoints-1274"><a href="#GlobalMeasurementPoints-1274"><span class="linenos">1274</span></a>    
</span><span id="GlobalMeasurementPoints-1275"><a href="#GlobalMeasurementPoints-1275"><span class="linenos">1275</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="AbsoluteReferencing">
                            <input id="AbsoluteReferencing-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">AbsoluteReferencing</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AbsoluteReferencing-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AbsoluteReferencing"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AbsoluteReferencing-1277"><a href="#AbsoluteReferencing-1277"><span class="linenos">1277</span></a><span class="k">def</span> <span class="nf">AbsoluteReferencing</span><span class="p">():</span>
</span><span id="AbsoluteReferencing-1278"><a href="#AbsoluteReferencing-1278"><span class="linenos">1278</span></a>
</span><span id="AbsoluteReferencing-1279"><a href="#AbsoluteReferencing-1279"><span class="linenos">1279</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="GaussNewtonGlobal">
                            <input id="GaussNewtonGlobal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">GaussNewtonGlobal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">ROI</span>, </span><span class="param"><span class="n">image_set</span>, </span><span class="param"><span class="n">i_image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GaussNewtonGlobal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GaussNewtonGlobal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GaussNewtonGlobal-1281"><a href="#GaussNewtonGlobal-1281"><span class="linenos">1281</span></a><span class="k">def</span> <span class="nf">GaussNewtonGlobal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">):</span>
</span><span id="GaussNewtonGlobal-1282"><a href="#GaussNewtonGlobal-1282"><span class="linenos">1282</span></a>
</span><span id="GaussNewtonGlobal-1283"><a href="#GaussNewtonGlobal-1283"><span class="linenos">1283</span></a>    <span class="c1">#return nodal_displacements</span>
</span><span id="GaussNewtonGlobal-1284"><a href="#GaussNewtonGlobal-1284"><span class="linenos">1284</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="EstimateDisplacementsFourier">
                            <input id="EstimateDisplacementsFourier-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">EstimateDisplacementsFourier</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EstimateDisplacementsFourier-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EstimateDisplacementsFourier"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EstimateDisplacementsFourier-1286"><a href="#EstimateDisplacementsFourier-1286"><span class="linenos">1286</span></a><span class="k">def</span> <span class="nf">EstimateDisplacementsFourier</span><span class="p">():</span>
</span><span id="EstimateDisplacementsFourier-1287"><a href="#EstimateDisplacementsFourier-1287"><span class="linenos">1287</span></a>    
</span><span id="EstimateDisplacementsFourier-1288"><a href="#EstimateDisplacementsFourier-1288"><span class="linenos">1288</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="IncrementalGlobal">
                            <input id="IncrementalGlobal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">IncrementalGlobal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">image_set</span>, </span><span class="param"><span class="n">ROI</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="IncrementalGlobal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#IncrementalGlobal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="IncrementalGlobal-1290"><a href="#IncrementalGlobal-1290"><span class="linenos">1290</span></a><span class="k">def</span> <span class="nf">IncrementalGlobal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">):</span>
</span><span id="IncrementalGlobal-1291"><a href="#IncrementalGlobal-1291"><span class="linenos">1291</span></a>
</span><span id="IncrementalGlobal-1292"><a href="#IncrementalGlobal-1292"><span class="linenos">1292</span></a>    <span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">n_image_pairs</span> <span class="o">=</span> <span class="n">RefineImageSet</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span>
</span><span id="IncrementalGlobal-1293"><a href="#IncrementalGlobal-1293"><span class="linenos">1293</span></a>                                                                <span class="n">image_set</span><span class="p">,</span> <span class="n">ROI</span><span class="p">)</span>
</span><span id="IncrementalGlobal-1294"><a href="#IncrementalGlobal-1294"><span class="linenos">1294</span></a>
</span><span id="IncrementalGlobal-1295"><a href="#IncrementalGlobal-1295"><span class="linenos">1295</span></a>    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;Discretisation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Global&#39;</span><span class="p">:</span>
</span><span id="IncrementalGlobal-1296"><a href="#IncrementalGlobal-1296"><span class="linenos">1296</span></a>
</span><span id="IncrementalGlobal-1297"><a href="#IncrementalGlobal-1297"><span class="linenos">1297</span></a>        <span class="k">for</span> <span class="n">i_image</span> <span class="ow">in</span> <span class="p">(</span><span class="n">image0</span><span class="p">,</span> <span class="n">image_target</span> <span class="o">+</span> <span class="n">increment</span><span class="p">,</span> <span class="n">increment</span><span class="p">):</span>
</span><span id="IncrementalGlobal-1298"><a href="#IncrementalGlobal-1298"><span class="linenos">1298</span></a>            
</span><span id="IncrementalGlobal-1299"><a href="#IncrementalGlobal-1299"><span class="linenos">1299</span></a>            <span class="n">coefficients</span> <span class="o">=</span> <span class="n">GaussNewtonGlobal</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">ROI</span><span class="p">,</span> <span class="n">image_set</span><span class="p">,</span> <span class="n">i_image</span><span class="p">)</span>    
</span><span id="IncrementalGlobal-1300"><a href="#IncrementalGlobal-1300"><span class="linenos">1300</span></a>
</span><span id="IncrementalGlobal-1301"><a href="#IncrementalGlobal-1301"><span class="linenos">1301</span></a>    <span class="c1">#return dofs</span>
</span><span id="IncrementalGlobal-1302"><a href="#IncrementalGlobal-1302"><span class="linenos">1302</span></a>    
</span><span id="IncrementalGlobal-1303"><a href="#IncrementalGlobal-1303"><span class="linenos">1303</span></a>    <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="PlaneFitLS">
                            <input id="PlaneFitLS-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">PlaneFitLS</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Xo_camera</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PlaneFitLS-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PlaneFitLS"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PlaneFitLS-1305"><a href="#PlaneFitLS-1305"><span class="linenos">1305</span></a><span class="k">def</span> <span class="nf">PlaneFitLS</span><span class="p">(</span><span class="n">Xo_camera</span><span class="p">):</span>
</span><span id="PlaneFitLS-1306"><a href="#PlaneFitLS-1306"><span class="linenos">1306</span></a>
</span><span id="PlaneFitLS-1307"><a href="#PlaneFitLS-1307"><span class="linenos">1307</span></a>    <span class="n">xo_c</span> <span class="o">=</span> <span class="n">Xo_camera</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="PlaneFitLS-1308"><a href="#PlaneFitLS-1308"><span class="linenos">1308</span></a>    <span class="n">yo_c</span> <span class="o">=</span> <span class="n">Xo_camera</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="PlaneFitLS-1309"><a href="#PlaneFitLS-1309"><span class="linenos">1309</span></a>    <span class="n">zo_c</span> <span class="o">=</span> <span class="n">Xo_camera</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="PlaneFitLS-1310"><a href="#PlaneFitLS-1310"><span class="linenos">1310</span></a>    
</span><span id="PlaneFitLS-1311"><a href="#PlaneFitLS-1311"><span class="linenos">1311</span></a>    <span class="c1">#plane coefficient matrix</span>
</span><span id="PlaneFitLS-1312"><a href="#PlaneFitLS-1312"><span class="linenos">1312</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="o">*</span><span class="n">xo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="o">*</span><span class="n">yo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="p">)],</span>
</span><span id="PlaneFitLS-1313"><a href="#PlaneFitLS-1313"><span class="linenos">1313</span></a>              
</span><span id="PlaneFitLS-1314"><a href="#PlaneFitLS-1314"><span class="linenos">1314</span></a>                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="o">*</span><span class="n">yo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yo_c</span><span class="o">*</span><span class="n">yo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yo_c</span><span class="p">)],</span>
</span><span id="PlaneFitLS-1315"><a href="#PlaneFitLS-1315"><span class="linenos">1315</span></a>              
</span><span id="PlaneFitLS-1316"><a href="#PlaneFitLS-1316"><span class="linenos">1316</span></a>                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yo_c</span><span class="p">),</span> <span class="n">xo_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
</span><span id="PlaneFitLS-1317"><a href="#PlaneFitLS-1317"><span class="linenos">1317</span></a>
</span><span id="PlaneFitLS-1318"><a href="#PlaneFitLS-1318"><span class="linenos">1318</span></a>    <span class="c1">#plane fit RHS</span>
</span><span id="PlaneFitLS-1319"><a href="#PlaneFitLS-1319"><span class="linenos">1319</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xo_c</span><span class="o">*</span><span class="n">zo_c</span><span class="p">)],</span>
</span><span id="PlaneFitLS-1320"><a href="#PlaneFitLS-1320"><span class="linenos">1320</span></a>                  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yo_c</span><span class="o">*</span><span class="n">zo_c</span><span class="p">)],</span>
</span><span id="PlaneFitLS-1321"><a href="#PlaneFitLS-1321"><span class="linenos">1321</span></a>                  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">zo_c</span><span class="p">)]])</span>
</span><span id="PlaneFitLS-1322"><a href="#PlaneFitLS-1322"><span class="linenos">1322</span></a>
</span><span id="PlaneFitLS-1323"><a href="#PlaneFitLS-1323"><span class="linenos">1323</span></a>    <span class="c1">#coefficients</span>
</span><span id="PlaneFitLS-1324"><a href="#PlaneFitLS-1324"><span class="linenos">1324</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="PlaneFitLS-1325"><a href="#PlaneFitLS-1325"><span class="linenos">1325</span></a>
</span><span id="PlaneFitLS-1326"><a href="#PlaneFitLS-1326"><span class="linenos">1326</span></a>    <span class="c1">#Z coordinates from plane fit parameters and XY camera coordinates</span>
</span><span id="PlaneFitLS-1327"><a href="#PlaneFitLS-1327"><span class="linenos">1327</span></a>
</span><span id="PlaneFitLS-1328"><a href="#PlaneFitLS-1328"><span class="linenos">1328</span></a>    <span class="n">Z</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">xo_c</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">yo_c</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="PlaneFitLS-1329"><a href="#PlaneFitLS-1329"><span class="linenos">1329</span></a>
</span><span id="PlaneFitLS-1330"><a href="#PlaneFitLS-1330"><span class="linenos">1330</span></a>    <span class="k">return</span> <span class="n">C</span><span class="p">,</span> <span class="n">Z</span>
</span></pre></div>


    

                </section>
                <section id="RotationMatrixFromBases">
                            <input id="RotationMatrixFromBases-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RotationMatrixFromBases</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">C</span>, </span><span class="param"><span class="n">axis_world</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="RotationMatrixFromBases-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RotationMatrixFromBases"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RotationMatrixFromBases-1332"><a href="#RotationMatrixFromBases-1332"><span class="linenos">1332</span></a><span class="k">def</span> <span class="nf">RotationMatrixFromBases</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">axis_world</span><span class="p">):</span>
</span><span id="RotationMatrixFromBases-1333"><a href="#RotationMatrixFromBases-1333"><span class="linenos">1333</span></a>
</span><span id="RotationMatrixFromBases-1334"><a href="#RotationMatrixFromBases-1334"><span class="linenos">1334</span></a>    <span class="c1">#find the basis vectors of the best fit plane</span>
</span><span id="RotationMatrixFromBases-1335"><a href="#RotationMatrixFromBases-1335"><span class="linenos">1335</span></a>    <span class="n">Zorigin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="RotationMatrixFromBases-1336"><a href="#RotationMatrixFromBases-1336"><span class="linenos">1336</span></a>    <span class="n">Zx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="RotationMatrixFromBases-1337"><a href="#RotationMatrixFromBases-1337"><span class="linenos">1337</span></a>
</span><span id="RotationMatrixFromBases-1338"><a href="#RotationMatrixFromBases-1338"><span class="linenos">1338</span></a>    <span class="c1">#three basis vectors of best fit plane</span>
</span><span id="RotationMatrixFromBases-1339"><a href="#RotationMatrixFromBases-1339"><span class="linenos">1339</span></a>    <span class="n">g3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="RotationMatrixFromBases-1340"><a href="#RotationMatrixFromBases-1340"><span class="linenos">1340</span></a>    <span class="n">g1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_world</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">axis_world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis_world</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">axis_world</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Zx</span> <span class="o">-</span> <span class="n">Zorigin</span><span class="p">])</span>
</span><span id="RotationMatrixFromBases-1341"><a href="#RotationMatrixFromBases-1341"><span class="linenos">1341</span></a>    <span class="n">g2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">g3</span><span class="p">,</span> <span class="n">g1</span><span class="p">)</span>
</span><span id="RotationMatrixFromBases-1342"><a href="#RotationMatrixFromBases-1342"><span class="linenos">1342</span></a>
</span><span id="RotationMatrixFromBases-1343"><a href="#RotationMatrixFromBases-1343"><span class="linenos">1343</span></a>    <span class="c1">#determine the rotation matrix fromm projections</span>
</span><span id="RotationMatrixFromBases-1344"><a href="#RotationMatrixFromBases-1344"><span class="linenos">1344</span></a>    <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="RotationMatrixFromBases-1345"><a href="#RotationMatrixFromBases-1345"><span class="linenos">1345</span></a>    <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</span><span id="RotationMatrixFromBases-1346"><a href="#RotationMatrixFromBases-1346"><span class="linenos">1346</span></a>    <span class="n">e3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</span><span id="RotationMatrixFromBases-1347"><a href="#RotationMatrixFromBases-1347"><span class="linenos">1347</span></a>    <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e3</span><span class="p">))</span>
</span><span id="RotationMatrixFromBases-1348"><a href="#RotationMatrixFromBases-1348"><span class="linenos">1348</span></a>    <span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="n">g3</span><span class="p">))</span>
</span><span id="RotationMatrixFromBases-1349"><a href="#RotationMatrixFromBases-1349"><span class="linenos">1349</span></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
</span><span id="RotationMatrixFromBases-1350"><a href="#RotationMatrixFromBases-1350"><span class="linenos">1350</span></a>    
</span><span id="RotationMatrixFromBases-1351"><a href="#RotationMatrixFromBases-1351"><span class="linenos">1351</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
</span><span id="RotationMatrixFromBases-1352"><a href="#RotationMatrixFromBases-1352"><span class="linenos">1352</span></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
</span><span id="RotationMatrixFromBases-1353"><a href="#RotationMatrixFromBases-1353"><span class="linenos">1353</span></a>
</span><span id="RotationMatrixFromBases-1354"><a href="#RotationMatrixFromBases-1354"><span class="linenos">1354</span></a>            <span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">G</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:])</span><span class="o">/</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">E</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span><span class="o">*</span><span class="n">norm</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]))</span>
</span><span id="RotationMatrixFromBases-1355"><a href="#RotationMatrixFromBases-1355"><span class="linenos">1355</span></a>
</span><span id="RotationMatrixFromBases-1356"><a href="#RotationMatrixFromBases-1356"><span class="linenos">1356</span></a>    <span class="k">return</span> <span class="n">R</span>
</span></pre></div>


    

                </section>
                <section id="ReadCalibrationParamters">
                            <input id="ReadCalibrationParamters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ReadCalibrationParamters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">data</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ReadCalibrationParamters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ReadCalibrationParamters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ReadCalibrationParamters-1358"><a href="#ReadCalibrationParamters-1358"><span class="linenos">1358</span></a><span class="k">def</span> <span class="nf">ReadCalibrationParamters</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="ReadCalibrationParamters-1359"><a href="#ReadCalibrationParamters-1359"><span class="linenos">1359</span></a>
</span><span id="ReadCalibrationParamters-1360"><a href="#ReadCalibrationParamters-1360"><span class="linenos">1360</span></a>    <span class="n">folder</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CalibrationParametersFolder&#39;</span><span class="p">]</span>
</span><span id="ReadCalibrationParamters-1361"><a href="#ReadCalibrationParamters-1361"><span class="linenos">1361</span></a>
</span><span id="ReadCalibrationParamters-1362"><a href="#ReadCalibrationParamters-1362"><span class="linenos">1362</span></a>    <span class="c1">#left camera</span>
</span><span id="ReadCalibrationParamters-1363"><a href="#ReadCalibrationParamters-1363"><span class="linenos">1363</span></a>    <span class="n">K0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/K0.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="ReadCalibrationParamters-1364"><a href="#ReadCalibrationParamters-1364"><span class="linenos">1364</span></a>    <span class="n">R_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/R_0.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="ReadCalibrationParamters-1365"><a href="#ReadCalibrationParamters-1365"><span class="linenos">1365</span></a>    <span class="n">t_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/t_0.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="ReadCalibrationParamters-1366"><a href="#ReadCalibrationParamters-1366"><span class="linenos">1366</span></a>    <span class="n">r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/r0.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="ReadCalibrationParamters-1367"><a href="#ReadCalibrationParamters-1367"><span class="linenos">1367</span></a>    <span class="n">t_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t_0</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="ReadCalibrationParamters-1368"><a href="#ReadCalibrationParamters-1368"><span class="linenos">1368</span></a>
</span><span id="ReadCalibrationParamters-1369"><a href="#ReadCalibrationParamters-1369"><span class="linenos">1369</span></a>    <span class="c1">#right camera</span>
</span><span id="ReadCalibrationParamters-1370"><a href="#ReadCalibrationParamters-1370"><span class="linenos">1370</span></a>    <span class="n">K1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/K1.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="ReadCalibrationParamters-1371"><a href="#ReadCalibrationParamters-1371"><span class="linenos">1371</span></a>    <span class="n">R_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/R_1.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="ReadCalibrationParamters-1372"><a href="#ReadCalibrationParamters-1372"><span class="linenos">1372</span></a>    <span class="n">t_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/t_1.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="ReadCalibrationParamters-1373"><a href="#ReadCalibrationParamters-1373"><span class="linenos">1373</span></a>    <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/r1.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>
</span><span id="ReadCalibrationParamters-1374"><a href="#ReadCalibrationParamters-1374"><span class="linenos">1374</span></a>    <span class="n">t_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t_1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
</span><span id="ReadCalibrationParamters-1375"><a href="#ReadCalibrationParamters-1375"><span class="linenos">1375</span></a>
</span><span id="ReadCalibrationParamters-1376"><a href="#ReadCalibrationParamters-1376"><span class="linenos">1376</span></a>    <span class="c1">#homogeneous transformation matrics</span>
</span><span id="ReadCalibrationParamters-1377"><a href="#ReadCalibrationParamters-1377"><span class="linenos">1377</span></a>    <span class="n">Rt_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R_0</span><span class="p">,</span> <span class="n">t_0</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="ReadCalibrationParamters-1378"><a href="#ReadCalibrationParamters-1378"><span class="linenos">1378</span></a>    <span class="n">Rt_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R_1</span><span class="p">,</span> <span class="n">t_1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="ReadCalibrationParamters-1379"><a href="#ReadCalibrationParamters-1379"><span class="linenos">1379</span></a>
</span><span id="ReadCalibrationParamters-1380"><a href="#ReadCalibrationParamters-1380"><span class="linenos">1380</span></a>    <span class="c1">#camera projection matrices</span>
</span><span id="ReadCalibrationParamters-1381"><a href="#ReadCalibrationParamters-1381"><span class="linenos">1381</span></a>    <span class="n">P0</span> <span class="o">=</span> <span class="n">K0</span><span class="nd">@Rt_0</span>
</span><span id="ReadCalibrationParamters-1382"><a href="#ReadCalibrationParamters-1382"><span class="linenos">1382</span></a>    <span class="n">P1</span> <span class="o">=</span> <span class="n">K1</span><span class="nd">@Rt_1</span>
</span><span id="ReadCalibrationParamters-1383"><a href="#ReadCalibrationParamters-1383"><span class="linenos">1383</span></a>
</span><span id="ReadCalibrationParamters-1384"><a href="#ReadCalibrationParamters-1384"><span class="linenos">1384</span></a>    <span class="n">K0</span> <span class="o">=</span> <span class="n">K0</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadCalibrationParamters-1385"><a href="#ReadCalibrationParamters-1385"><span class="linenos">1385</span></a>    <span class="n">K1</span> <span class="o">=</span> <span class="n">K1</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
</span><span id="ReadCalibrationParamters-1386"><a href="#ReadCalibrationParamters-1386"><span class="linenos">1386</span></a>
</span><span id="ReadCalibrationParamters-1387"><a href="#ReadCalibrationParamters-1387"><span class="linenos">1387</span></a>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CalibrationParameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">P1</span><span class="p">]</span> 
</span><span id="ReadCalibrationParamters-1388"><a href="#ReadCalibrationParamters-1388"><span class="linenos">1388</span></a>
</span><span id="ReadCalibrationParamters-1389"><a href="#ReadCalibrationParamters-1389"><span class="linenos">1389</span></a>    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data</span>
</span></pre></div>


    

                </section>
                <section id="BestPlaneFit">
                            <input id="BestPlaneFit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">BestPlaneFit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">data</span>, </span><span class="param"><span class="n">image_set_0</span>, </span><span class="param"><span class="n">image_set_1</span>, </span><span class="param"><span class="n">xo_local_L</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BestPlaneFit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BestPlaneFit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BestPlaneFit-1391"><a href="#BestPlaneFit-1391"><span class="linenos">1391</span></a><span class="k">def</span> <span class="nf">BestPlaneFit</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="n">xo_local_L</span><span class="p">):</span>
</span><span id="BestPlaneFit-1392"><a href="#BestPlaneFit-1392"><span class="linenos">1392</span></a>
</span><span id="BestPlaneFit-1393"><a href="#BestPlaneFit-1393"><span class="linenos">1393</span></a>    <span class="c1">#measurement point coordinates in reference image, camera coordinate system</span>
</span><span id="BestPlaneFit-1394"><a href="#BestPlaneFit-1394"><span class="linenos">1394</span></a>    <span class="n">Xo_camera</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xo_camera&#39;</span><span class="p">]</span>
</span><span id="BestPlaneFit-1395"><a href="#BestPlaneFit-1395"><span class="linenos">1395</span></a>    <span class="c1">#measurement point coordinate in deformed imagem, coordinate system of camera</span>
</span><span id="BestPlaneFit-1396"><a href="#BestPlaneFit-1396"><span class="linenos">1396</span></a>    <span class="n">Xd_camera</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xd_camera&#39;</span><span class="p">]</span>
</span><span id="BestPlaneFit-1397"><a href="#BestPlaneFit-1397"><span class="linenos">1397</span></a>    <span class="c1">#load calibration data</span>
</span><span id="BestPlaneFit-1398"><a href="#BestPlaneFit-1398"><span class="linenos">1398</span></a>    <span class="n">K_L</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_L</span><span class="p">,</span> <span class="n">r_R</span><span class="p">,</span> <span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CalibrationParameters&#39;</span><span class="p">]</span>
</span><span id="BestPlaneFit-1399"><a href="#BestPlaneFit-1399"><span class="linenos">1399</span></a>
</span><span id="BestPlaneFit-1400"><a href="#BestPlaneFit-1400"><span class="linenos">1400</span></a>
</span><span id="BestPlaneFit-1401"><a href="#BestPlaneFit-1401"><span class="linenos">1401</span></a>    <span class="n">C</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">PlaneFitLS</span><span class="p">(</span><span class="n">Xo_camera</span><span class="p">)</span>
</span><span id="BestPlaneFit-1402"><a href="#BestPlaneFit-1402"><span class="linenos">1402</span></a>
</span><span id="BestPlaneFit-1403"><a href="#BestPlaneFit-1403"><span class="linenos">1403</span></a>    <span class="c1">#find local axis pixel coordinates in right image</span>
</span><span id="BestPlaneFit-1404"><a href="#BestPlaneFit-1404"><span class="linenos">1404</span></a>    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="s1">&#39;measurement_points_Local.csv&#39;</span><span class="p">,</span> <span class="n">xo_local_L</span><span class="p">,</span> <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span id="BestPlaneFit-1405"><a href="#BestPlaneFit-1405"><span class="linenos">1405</span></a>    <span class="c1">#temporarily change some settings</span>
</span><span id="BestPlaneFit-1406"><a href="#BestPlaneFit-1406"><span class="linenos">1406</span></a>    <span class="n">settings_local</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="BestPlaneFit-1407"><a href="#BestPlaneFit-1407"><span class="linenos">1407</span></a>    <span class="n">settings_local</span><span class="p">[</span><span class="s1">&#39;Import&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Yes&#39;</span>
</span><span id="BestPlaneFit-1408"><a href="#BestPlaneFit-1408"><span class="linenos">1408</span></a>    <span class="n">settings_local</span><span class="p">[</span><span class="s1">&#39;MeasurementPointsName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;measurement_points_Local&#39;</span>
</span><span id="BestPlaneFit-1409"><a href="#BestPlaneFit-1409"><span class="linenos">1409</span></a>    <span class="n">settings_local</span><span class="p">[</span><span class="s1">&#39;CameraNo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BestPlaneFit-1410"><a href="#BestPlaneFit-1410"><span class="linenos">1410</span></a>    <span class="n">p_specimen_L</span><span class="p">,</span> <span class="n">p_specimen_R</span><span class="p">,</span> <span class="n">settings_local</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">StereoDICPlanar</span><span class="p">(</span><span class="n">settings_local</span><span class="p">,</span> <span class="n">image_set_0</span><span class="p">,</span> <span class="n">image_set_1</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;ROI_L0&#39;</span><span class="p">])</span>
</span><span id="BestPlaneFit-1411"><a href="#BestPlaneFit-1411"><span class="linenos">1411</span></a>    <span class="n">xo_local_R</span> <span class="o">=</span> <span class="n">settings_local</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">]</span>
</span><span id="BestPlaneFit-1412"><a href="#BestPlaneFit-1412"><span class="linenos">1412</span></a>
</span><span id="BestPlaneFit-1413"><a href="#BestPlaneFit-1413"><span class="linenos">1413</span></a>    <span class="c1">#3D world coordinates on local axis coordinate system specimen surface</span>
</span><span id="BestPlaneFit-1414"><a href="#BestPlaneFit-1414"><span class="linenos">1414</span></a>    <span class="n">axis_local</span> <span class="o">=</span> <span class="n">TriangulateOCV</span><span class="p">(</span><span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xo_local_L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_L</span><span class="p">,</span> <span class="n">r_L</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
</span><span id="BestPlaneFit-1415"><a href="#BestPlaneFit-1415"><span class="linenos">1415</span></a>                                          <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xo_local_R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_R</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="BestPlaneFit-1416"><a href="#BestPlaneFit-1416"><span class="linenos">1416</span></a>    
</span><span id="BestPlaneFit-1417"><a href="#BestPlaneFit-1417"><span class="linenos">1417</span></a>    <span class="c1">#rotation matrix that brings the left camera coordinate system into the local CS on specimen surface</span>
</span><span id="BestPlaneFit-1418"><a href="#BestPlaneFit-1418"><span class="linenos">1418</span></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">RotationMatrixFromBases</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">axis_local</span><span class="p">)</span>
</span><span id="BestPlaneFit-1419"><a href="#BestPlaneFit-1419"><span class="linenos">1419</span></a>    <span class="c1">#translation from camera coordinate system to origin of locally defined axis CS</span>
</span><span id="BestPlaneFit-1420"><a href="#BestPlaneFit-1420"><span class="linenos">1420</span></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_local</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]])</span><span class="o">.</span><span class="n">T</span>
</span><span id="BestPlaneFit-1421"><a href="#BestPlaneFit-1421"><span class="linenos">1421</span></a>    <span class="n">R_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="BestPlaneFit-1422"><a href="#BestPlaneFit-1422"><span class="linenos">1422</span></a>
</span><span id="BestPlaneFit-1423"><a href="#BestPlaneFit-1423"><span class="linenos">1423</span></a>    <span class="c1">#homogeneous 3D coordinates in camera coordinate system</span>
</span><span id="BestPlaneFit-1424"><a href="#BestPlaneFit-1424"><span class="linenos">1424</span></a>    <span class="n">Xo_camera_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">Xo_camera</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">])</span>
</span><span id="BestPlaneFit-1425"><a href="#BestPlaneFit-1425"><span class="linenos">1425</span></a>    <span class="n">Xo_camera_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo_camera</span>
</span><span id="BestPlaneFit-1426"><a href="#BestPlaneFit-1426"><span class="linenos">1426</span></a>    <span class="n">Xd_camera_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">Xd_camera</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">])</span>
</span><span id="BestPlaneFit-1427"><a href="#BestPlaneFit-1427"><span class="linenos">1427</span></a>    <span class="n">Xd_camera_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xd_camera</span>
</span><span id="BestPlaneFit-1428"><a href="#BestPlaneFit-1428"><span class="linenos">1428</span></a>
</span><span id="BestPlaneFit-1429"><a href="#BestPlaneFit-1429"><span class="linenos">1429</span></a>    <span class="c1">#transform coordinates from camera coordinate system to the locally defined CS</span>
</span><span id="BestPlaneFit-1430"><a href="#BestPlaneFit-1430"><span class="linenos">1430</span></a>    <span class="n">Xo_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R_t</span><span class="p">)</span><span class="nd">@Xo_camera_</span><span class="o">.</span><span class="n">T</span>
</span><span id="BestPlaneFit-1431"><a href="#BestPlaneFit-1431"><span class="linenos">1431</span></a>    <span class="n">Xd_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R_t</span><span class="p">)</span><span class="nd">@Xd_camera_</span><span class="o">.</span><span class="n">T</span>
</span><span id="BestPlaneFit-1432"><a href="#BestPlaneFit-1432"><span class="linenos">1432</span></a>    <span class="n">U_w</span> <span class="o">=</span> <span class="n">Xd_w</span> <span class="o">-</span> <span class="n">Xo_w</span>
</span><span id="BestPlaneFit-1433"><a href="#BestPlaneFit-1433"><span class="linenos">1433</span></a>
</span><span id="BestPlaneFit-1434"><a href="#BestPlaneFit-1434"><span class="linenos">1434</span></a>    <span class="k">return</span> <span class="n">Xo_w</span><span class="p">,</span> <span class="n">Xd_w</span><span class="p">,</span> <span class="n">U_w</span>
</span></pre></div>


    

                </section>
                <section id="UndistortPoints">
                            <input id="UndistortPoints-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">UndistortPoints</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">camera_matrix</span>, </span><span class="param"><span class="n">dist_coeff</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="UndistortPoints-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#UndistortPoints"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="UndistortPoints-1436"><a href="#UndistortPoints-1436"><span class="linenos">1436</span></a><span class="k">def</span> <span class="nf">UndistortPoints</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">camera_matrix</span><span class="p">,</span> <span class="n">dist_coeff</span><span class="p">):</span>
</span><span id="UndistortPoints-1437"><a href="#UndistortPoints-1437"><span class="linenos">1437</span></a>
</span><span id="UndistortPoints-1438"><a href="#UndistortPoints-1438"><span class="linenos">1438</span></a>    <span class="c1">#number of coordinates to undistort</span>
</span><span id="UndistortPoints-1439"><a href="#UndistortPoints-1439"><span class="linenos">1439</span></a>    <span class="n">n_points</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="UndistortPoints-1440"><a href="#UndistortPoints-1440"><span class="linenos">1440</span></a>    <span class="c1">#reshape coordinates to appropriate shape for cv.undistortpoints function</span>
</span><span id="UndistortPoints-1441"><a href="#UndistortPoints-1441"><span class="linenos">1441</span></a>    <span class="n">X_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_points</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</span><span id="UndistortPoints-1442"><a href="#UndistortPoints-1442"><span class="linenos">1442</span></a>    <span class="n">X_</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:]</span>
</span><span id="UndistortPoints-1443"><a href="#UndistortPoints-1443"><span class="linenos">1443</span></a>    <span class="c1"># do the actual undistort</span>
</span><span id="UndistortPoints-1444"><a href="#UndistortPoints-1444"><span class="linenos">1444</span></a>    <span class="n">X_undistorted</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">undistortPoints</span><span class="p">(</span><span class="n">X_</span><span class="p">,</span><span class="n">camera_matrix</span><span class="p">,</span> <span class="n">dist_coeff</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="n">camera_matrix</span><span class="p">)</span>
</span><span id="UndistortPoints-1445"><a href="#UndistortPoints-1445"><span class="linenos">1445</span></a>
</span><span id="UndistortPoints-1446"><a href="#UndistortPoints-1446"><span class="linenos">1446</span></a>    <span class="k">return</span> <span class="n">X_undistorted</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span></pre></div>


    

                </section>
                <section id="TriangulateOCV">
                            <input id="TriangulateOCV-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">TriangulateOCV</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">Q0</span>, </span><span class="param"><span class="n">Q1</span>, </span><span class="param"><span class="n">x0</span>, </span><span class="param"><span class="n">x1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TriangulateOCV-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TriangulateOCV"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TriangulateOCV-1448"><a href="#TriangulateOCV-1448"><span class="linenos">1448</span></a><span class="k">def</span> <span class="nf">TriangulateOCV</span><span class="p">(</span><span class="n">Q0</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">):</span>
</span><span id="TriangulateOCV-1449"><a href="#TriangulateOCV-1449"><span class="linenos">1449</span></a>
</span><span id="TriangulateOCV-1450"><a href="#TriangulateOCV-1450"><span class="linenos">1450</span></a>    <span class="n">coords_hom</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">triangulatePoints</span><span class="p">(</span><span class="n">Q0</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
</span><span id="TriangulateOCV-1451"><a href="#TriangulateOCV-1451"><span class="linenos">1451</span></a>
</span><span id="TriangulateOCV-1452"><a href="#TriangulateOCV-1452"><span class="linenos">1452</span></a>    <span class="n">coords_3D</span> <span class="o">=</span> <span class="p">(</span><span class="n">coords_hom</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span><span class="o">/</span><span class="n">coords_hom</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">T</span>
</span><span id="TriangulateOCV-1453"><a href="#TriangulateOCV-1453"><span class="linenos">1453</span></a>
</span><span id="TriangulateOCV-1454"><a href="#TriangulateOCV-1454"><span class="linenos">1454</span></a>    <span class="k">return</span> <span class="n">coords_3D</span>
</span></pre></div>


    

                </section>
                <section id="VirtualStrainGauge">
                            <input id="VirtualStrainGauge-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">VirtualStrainGauge</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">xo</span>, </span><span class="param"><span class="n">yo</span>, </span><span class="param"><span class="n">U</span>, </span><span class="param"><span class="n">V</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="VirtualStrainGauge-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#VirtualStrainGauge"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="VirtualStrainGauge-1456"><a href="#VirtualStrainGauge-1456"><span class="linenos">1456</span></a><span class="k">def</span> <span class="nf">VirtualStrainGauge</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">xo</span><span class="p">,</span> <span class="n">yo</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
</span><span id="VirtualStrainGauge-1457"><a href="#VirtualStrainGauge-1457"><span class="linenos">1457</span></a>
</span><span id="VirtualStrainGauge-1458"><a href="#VirtualStrainGauge-1458"><span class="linenos">1458</span></a>    <span class="c1">#function can be used for either stereo or 2D-strain filtering</span>
</span><span id="VirtualStrainGauge-1459"><a href="#VirtualStrainGauge-1459"><span class="linenos">1459</span></a>
</span><span id="VirtualStrainGauge-1460"><a href="#VirtualStrainGauge-1460"><span class="linenos">1460</span></a>    <span class="n">size</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterSize&#39;</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1461"><a href="#VirtualStrainGauge-1461"><span class="linenos">1461</span></a>
</span><span id="VirtualStrainGauge-1462"><a href="#VirtualStrainGauge-1462"><span class="linenos">1462</span></a>    <span class="n">n_subsets</span> <span class="o">=</span> <span class="n">xo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1463"><a href="#VirtualStrainGauge-1463"><span class="linenos">1463</span></a>    <span class="n">kNN_VSG_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_subsets</span><span class="p">,</span> <span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</span><span id="VirtualStrainGauge-1464"><a href="#VirtualStrainGauge-1464"><span class="linenos">1464</span></a>    <span class="n">kNN_VSG_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_subsets</span><span class="p">,</span> <span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</span><span id="VirtualStrainGauge-1465"><a href="#VirtualStrainGauge-1465"><span class="linenos">1465</span></a>    <span class="n">kNN_VSG_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">n_subsets</span><span class="p">,</span> <span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
</span><span id="VirtualStrainGauge-1466"><a href="#VirtualStrainGauge-1466"><span class="linenos">1466</span></a>
</span><span id="VirtualStrainGauge-1467"><a href="#VirtualStrainGauge-1467"><span class="linenos">1467</span></a>    <span class="c1">#storage array for each strain measurment</span>
</span><span id="VirtualStrainGauge-1468"><a href="#VirtualStrainGauge-1468"><span class="linenos">1468</span></a>    <span class="n">ux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="VirtualStrainGauge-1469"><a href="#VirtualStrainGauge-1469"><span class="linenos">1469</span></a>    <span class="n">uy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="VirtualStrainGauge-1470"><a href="#VirtualStrainGauge-1470"><span class="linenos">1470</span></a>    <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="VirtualStrainGauge-1471"><a href="#VirtualStrainGauge-1471"><span class="linenos">1471</span></a>    <span class="n">vy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xo</span><span class="p">)</span>
</span><span id="VirtualStrainGauge-1472"><a href="#VirtualStrainGauge-1472"><span class="linenos">1472</span></a>
</span><span id="VirtualStrainGauge-1473"><a href="#VirtualStrainGauge-1473"><span class="linenos">1473</span></a>    <span class="c1">#find the k nearest measurement points to each virtual strain gauge location</span>
</span><span id="VirtualStrainGauge-1474"><a href="#VirtualStrainGauge-1474"><span class="linenos">1474</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_subsets</span><span class="p">):</span>
</span><span id="VirtualStrainGauge-1475"><a href="#VirtualStrainGauge-1475"><span class="linenos">1475</span></a>
</span><span id="VirtualStrainGauge-1476"><a href="#VirtualStrainGauge-1476"><span class="linenos">1476</span></a>        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">xo</span><span class="p">[:])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span> <span class="n">yo</span><span class="p">[:])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="VirtualStrainGauge-1477"><a href="#VirtualStrainGauge-1477"><span class="linenos">1477</span></a>        <span class="c1">#indices of nearest subsests</span>
</span><span id="VirtualStrainGauge-1478"><a href="#VirtualStrainGauge-1478"><span class="linenos">1478</span></a>        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</span><span id="VirtualStrainGauge-1479"><a href="#VirtualStrainGauge-1479"><span class="linenos">1479</span></a>        <span class="c1">#k minimum SSD between subset centre i and all keypoints</span>
</span><span id="VirtualStrainGauge-1480"><a href="#VirtualStrainGauge-1480"><span class="linenos">1480</span></a>        <span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1481"><a href="#VirtualStrainGauge-1481"><span class="linenos">1481</span></a>
</span><span id="VirtualStrainGauge-1482"><a href="#VirtualStrainGauge-1482"><span class="linenos">1482</span></a>    <span class="c1">#fit a polynomial to each measurment point using measurement data in its local neighborhood</span>
</span><span id="VirtualStrainGauge-1483"><a href="#VirtualStrainGauge-1483"><span class="linenos">1483</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_subsets</span><span class="p">):</span>
</span><span id="VirtualStrainGauge-1484"><a href="#VirtualStrainGauge-1484"><span class="linenos">1484</span></a>
</span><span id="VirtualStrainGauge-1485"><a href="#VirtualStrainGauge-1485"><span class="linenos">1485</span></a>        <span class="c1">#relative coordinates of measurement points around current point for strain filter</span>
</span><span id="VirtualStrainGauge-1486"><a href="#VirtualStrainGauge-1486"><span class="linenos">1486</span></a>        <span class="n">x_rel</span> <span class="o">=</span> <span class="n">xo</span><span class="p">[</span><span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">-</span> <span class="n">xo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1487"><a href="#VirtualStrainGauge-1487"><span class="linenos">1487</span></a>        <span class="n">y_rel</span> <span class="o">=</span> <span class="n">yo</span><span class="p">[</span><span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span> <span class="o">-</span> <span class="n">yo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1488"><a href="#VirtualStrainGauge-1488"><span class="linenos">1488</span></a>
</span><span id="VirtualStrainGauge-1489"><a href="#VirtualStrainGauge-1489"><span class="linenos">1489</span></a>        <span class="c1">#diplacements at measurement points around current point for strain filter</span>
</span><span id="VirtualStrainGauge-1490"><a href="#VirtualStrainGauge-1490"><span class="linenos">1490</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</span><span id="VirtualStrainGauge-1491"><a href="#VirtualStrainGauge-1491"><span class="linenos">1491</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">kNN_VSG_indices</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]</span>
</span><span id="VirtualStrainGauge-1492"><a href="#VirtualStrainGauge-1492"><span class="linenos">1492</span></a>
</span><span id="VirtualStrainGauge-1493"><a href="#VirtualStrainGauge-1493"><span class="linenos">1493</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterOrder&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Linear&#39;</span><span class="p">:</span>
</span><span id="VirtualStrainGauge-1494"><a href="#VirtualStrainGauge-1494"><span class="linenos">1494</span></a>            <span class="c1">#strain filter coefficient matrix</span>
</span><span id="VirtualStrainGauge-1495"><a href="#VirtualStrainGauge-1495"><span class="linenos">1495</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="VirtualStrainGauge-1496"><a href="#VirtualStrainGauge-1496"><span class="linenos">1496</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_rel</span>
</span><span id="VirtualStrainGauge-1497"><a href="#VirtualStrainGauge-1497"><span class="linenos">1497</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_rel</span>
</span><span id="VirtualStrainGauge-1498"><a href="#VirtualStrainGauge-1498"><span class="linenos">1498</span></a>
</span><span id="VirtualStrainGauge-1499"><a href="#VirtualStrainGauge-1499"><span class="linenos">1499</span></a>        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;VSGFilterOrder&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Quadratic&#39;</span><span class="p">:</span>
</span><span id="VirtualStrainGauge-1500"><a href="#VirtualStrainGauge-1500"><span class="linenos">1500</span></a>            <span class="c1">#strain filter coefficient matrix</span>
</span><span id="VirtualStrainGauge-1501"><a href="#VirtualStrainGauge-1501"><span class="linenos">1501</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">size</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
</span><span id="VirtualStrainGauge-1502"><a href="#VirtualStrainGauge-1502"><span class="linenos">1502</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_rel</span>
</span><span id="VirtualStrainGauge-1503"><a href="#VirtualStrainGauge-1503"><span class="linenos">1503</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_rel</span>
</span><span id="VirtualStrainGauge-1504"><a href="#VirtualStrainGauge-1504"><span class="linenos">1504</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_rel</span><span class="o">**</span><span class="mi">2</span>
</span><span id="VirtualStrainGauge-1505"><a href="#VirtualStrainGauge-1505"><span class="linenos">1505</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_rel</span><span class="o">*</span><span class="n">y_rel</span>
</span><span id="VirtualStrainGauge-1506"><a href="#VirtualStrainGauge-1506"><span class="linenos">1506</span></a>            <span class="n">A</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_rel</span><span class="o">**</span><span class="mi">2</span>
</span><span id="VirtualStrainGauge-1507"><a href="#VirtualStrainGauge-1507"><span class="linenos">1507</span></a>
</span><span id="VirtualStrainGauge-1508"><a href="#VirtualStrainGauge-1508"><span class="linenos">1508</span></a>        <span class="c1">#LS solution for the strain filter</span>
</span><span id="VirtualStrainGauge-1509"><a href="#VirtualStrainGauge-1509"><span class="linenos">1509</span></a>        <span class="n">u_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="nd">@A</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="nd">@u</span><span class="p">)</span>
</span><span id="VirtualStrainGauge-1510"><a href="#VirtualStrainGauge-1510"><span class="linenos">1510</span></a>        <span class="n">v_coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="nd">@A</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="nd">@v</span><span class="p">)</span>
</span><span id="VirtualStrainGauge-1511"><a href="#VirtualStrainGauge-1511"><span class="linenos">1511</span></a>
</span><span id="VirtualStrainGauge-1512"><a href="#VirtualStrainGauge-1512"><span class="linenos">1512</span></a>        <span class="c1">#return coefficients for displacement gradients</span>
</span><span id="VirtualStrainGauge-1513"><a href="#VirtualStrainGauge-1513"><span class="linenos">1513</span></a>        <span class="n">ux</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1514"><a href="#VirtualStrainGauge-1514"><span class="linenos">1514</span></a>        <span class="n">uy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_coeffs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1515"><a href="#VirtualStrainGauge-1515"><span class="linenos">1515</span></a>
</span><span id="VirtualStrainGauge-1516"><a href="#VirtualStrainGauge-1516"><span class="linenos">1516</span></a>        <span class="n">vx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1517"><a href="#VirtualStrainGauge-1517"><span class="linenos">1517</span></a>        <span class="n">vy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_coeffs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="VirtualStrainGauge-1518"><a href="#VirtualStrainGauge-1518"><span class="linenos">1518</span></a>
</span><span id="VirtualStrainGauge-1519"><a href="#VirtualStrainGauge-1519"><span class="linenos">1519</span></a>    <span class="c1">#green-lagrange strain tensor components</span>
</span><span id="VirtualStrainGauge-1520"><a href="#VirtualStrainGauge-1520"><span class="linenos">1520</span></a>    <span class="n">Ex</span> <span class="o">=</span>  <span class="n">ux</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">ux</span><span class="o">*</span><span class="n">ux</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">vx</span><span class="o">*</span><span class="n">vx</span>
</span><span id="VirtualStrainGauge-1521"><a href="#VirtualStrainGauge-1521"><span class="linenos">1521</span></a>    <span class="n">Ey</span> <span class="o">=</span>  <span class="n">vy</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">vy</span><span class="o">*</span><span class="n">vy</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">uy</span><span class="o">*</span><span class="n">uy</span>
</span><span id="VirtualStrainGauge-1522"><a href="#VirtualStrainGauge-1522"><span class="linenos">1522</span></a>    <span class="n">Exy</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">uy</span> <span class="o">+</span> <span class="n">vx</span> <span class="o">+</span> <span class="n">ux</span><span class="o">*</span><span class="n">uy</span> <span class="o">+</span> <span class="n">vx</span><span class="o">*</span><span class="n">vy</span><span class="p">)</span>    
</span><span id="VirtualStrainGauge-1523"><a href="#VirtualStrainGauge-1523"><span class="linenos">1523</span></a>
</span><span id="VirtualStrainGauge-1524"><a href="#VirtualStrainGauge-1524"><span class="linenos">1524</span></a>    <span class="k">return</span> <span class="n">Ex</span><span class="p">,</span> <span class="n">Ey</span><span class="p">,</span> <span class="n">Exy</span>
</span></pre></div>


    

                </section>
                <section id="DepthFromTwoViewsCameraCS">
                            <input id="DepthFromTwoViewsCameraCS-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">DepthFromTwoViewsCameraCS</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">settings</span>, </span><span class="param"><span class="n">data</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DepthFromTwoViewsCameraCS-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DepthFromTwoViewsCameraCS"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DepthFromTwoViewsCameraCS-1526"><a href="#DepthFromTwoViewsCameraCS-1526"><span class="linenos">1526</span></a><span class="k">def</span> <span class="nf">DepthFromTwoViewsCameraCS</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span id="DepthFromTwoViewsCameraCS-1527"><a href="#DepthFromTwoViewsCameraCS-1527"><span class="linenos">1527</span></a>
</span><span id="DepthFromTwoViewsCameraCS-1528"><a href="#DepthFromTwoViewsCameraCS-1528"><span class="linenos">1528</span></a>    <span class="c1">#find the depth measurements in the reference and deformed positions</span>
</span><span id="DepthFromTwoViewsCameraCS-1529"><a href="#DepthFromTwoViewsCameraCS-1529"><span class="linenos">1529</span></a>    <span class="c1">#in the coordinate system of the reference(left) camera</span>
</span><span id="DepthFromTwoViewsCameraCS-1530"><a href="#DepthFromTwoViewsCameraCS-1530"><span class="linenos">1530</span></a> 
</span><span id="DepthFromTwoViewsCameraCS-1531"><a href="#DepthFromTwoViewsCameraCS-1531"><span class="linenos">1531</span></a>    <span class="c1">#measurement points/subset centre coordinates</span>
</span><span id="DepthFromTwoViewsCameraCS-1532"><a href="#DepthFromTwoViewsCameraCS-1532"><span class="linenos">1532</span></a>    <span class="n">xo_L</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_L0&#39;</span><span class="p">]</span>
</span><span id="DepthFromTwoViewsCameraCS-1533"><a href="#DepthFromTwoViewsCameraCS-1533"><span class="linenos">1533</span></a>    <span class="n">xo_R</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MeasurementPoints_R0&#39;</span><span class="p">]</span>
</span><span id="DepthFromTwoViewsCameraCS-1534"><a href="#DepthFromTwoViewsCameraCS-1534"><span class="linenos">1534</span></a>
</span><span id="DepthFromTwoViewsCameraCS-1535"><a href="#DepthFromTwoViewsCameraCS-1535"><span class="linenos">1535</span></a>    <span class="c1">#total displacements, both image series</span>
</span><span id="DepthFromTwoViewsCameraCS-1536"><a href="#DepthFromTwoViewsCameraCS-1536"><span class="linenos">1536</span></a>    <span class="n">U_L</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_L&#39;</span><span class="p">]</span>
</span><span id="DepthFromTwoViewsCameraCS-1537"><a href="#DepthFromTwoViewsCameraCS-1537"><span class="linenos">1537</span></a>    <span class="n">U_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_R&#39;</span><span class="p">]</span>
</span><span id="DepthFromTwoViewsCameraCS-1538"><a href="#DepthFromTwoViewsCameraCS-1538"><span class="linenos">1538</span></a>
</span><span id="DepthFromTwoViewsCameraCS-1539"><a href="#DepthFromTwoViewsCameraCS-1539"><span class="linenos">1539</span></a>    <span class="c1">#load the internal and stereo calibration parameters</span>
</span><span id="DepthFromTwoViewsCameraCS-1540"><a href="#DepthFromTwoViewsCameraCS-1540"><span class="linenos">1540</span></a>    <span class="n">K_L</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_L</span><span class="p">,</span> <span class="n">r_R</span><span class="p">,</span> <span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;CalibrationParameters&#39;</span><span class="p">]</span>
</span><span id="DepthFromTwoViewsCameraCS-1541"><a href="#DepthFromTwoViewsCameraCS-1541"><span class="linenos">1541</span></a>
</span><span id="DepthFromTwoViewsCameraCS-1542"><a href="#DepthFromTwoViewsCameraCS-1542"><span class="linenos">1542</span></a>    <span class="c1">#displaced subset centre positions in deformed image</span>
</span><span id="DepthFromTwoViewsCameraCS-1543"><a href="#DepthFromTwoViewsCameraCS-1543"><span class="linenos">1543</span></a>    <span class="n">xd_L</span> <span class="o">=</span> <span class="n">xo_L</span> <span class="o">+</span> <span class="n">U_L</span>
</span><span id="DepthFromTwoViewsCameraCS-1544"><a href="#DepthFromTwoViewsCameraCS-1544"><span class="linenos">1544</span></a>    <span class="n">xd_R</span> <span class="o">=</span> <span class="n">xo_R</span> <span class="o">+</span> <span class="n">U_R</span>
</span><span id="DepthFromTwoViewsCameraCS-1545"><a href="#DepthFromTwoViewsCameraCS-1545"><span class="linenos">1545</span></a>
</span><span id="DepthFromTwoViewsCameraCS-1546"><a href="#DepthFromTwoViewsCameraCS-1546"><span class="linenos">1546</span></a>    <span class="c1">#3D world coordinates in (left) camera coordinate system, reference position</span>
</span><span id="DepthFromTwoViewsCameraCS-1547"><a href="#DepthFromTwoViewsCameraCS-1547"><span class="linenos">1547</span></a>    <span class="n">Xo_camera</span> <span class="o">=</span> <span class="n">TriangulateOCV</span><span class="p">(</span><span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xo_L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_L</span><span class="p">,</span> <span class="n">r_L</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xo_R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_R</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="DepthFromTwoViewsCameraCS-1548"><a href="#DepthFromTwoViewsCameraCS-1548"><span class="linenos">1548</span></a>    <span class="c1">#3D world coordinates in (left) camera coordinate system, after deformation</span>
</span><span id="DepthFromTwoViewsCameraCS-1549"><a href="#DepthFromTwoViewsCameraCS-1549"><span class="linenos">1549</span></a>    <span class="n">Xd_camera</span> <span class="o">=</span> <span class="n">TriangulateOCV</span><span class="p">(</span><span class="n">P_L</span><span class="p">,</span> <span class="n">P_R</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xd_L</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_L</span><span class="p">,</span> <span class="n">r_L</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">UndistortPoints</span><span class="p">(</span><span class="n">xd_R</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">K_R</span><span class="p">,</span> <span class="n">r_R</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="DepthFromTwoViewsCameraCS-1550"><a href="#DepthFromTwoViewsCameraCS-1550"><span class="linenos">1550</span></a>    <span class="c1">#3D displacements in (left) camera coordinate system</span>
</span><span id="DepthFromTwoViewsCameraCS-1551"><a href="#DepthFromTwoViewsCameraCS-1551"><span class="linenos">1551</span></a>    <span class="n">U_camera</span> <span class="o">=</span> <span class="n">Xd_camera</span> <span class="o">-</span> <span class="n">Xo_camera</span>
</span><span id="DepthFromTwoViewsCameraCS-1552"><a href="#DepthFromTwoViewsCameraCS-1552"><span class="linenos">1552</span></a>
</span><span id="DepthFromTwoViewsCameraCS-1553"><a href="#DepthFromTwoViewsCameraCS-1553"><span class="linenos">1553</span></a>    <span class="c1">#save data</span>
</span><span id="DepthFromTwoViewsCameraCS-1554"><a href="#DepthFromTwoViewsCameraCS-1554"><span class="linenos">1554</span></a>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xo_camera&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xo_camera</span>
</span><span id="DepthFromTwoViewsCameraCS-1555"><a href="#DepthFromTwoViewsCameraCS-1555"><span class="linenos">1555</span></a>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;Xd_camera&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xd_camera</span>
</span><span id="DepthFromTwoViewsCameraCS-1556"><a href="#DepthFromTwoViewsCameraCS-1556"><span class="linenos">1556</span></a>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;U_camera&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">U_camera</span> 
</span><span id="DepthFromTwoViewsCameraCS-1557"><a href="#DepthFromTwoViewsCameraCS-1557"><span class="linenos">1557</span></a>
</span><span id="DepthFromTwoViewsCameraCS-1558"><a href="#DepthFromTwoViewsCameraCS-1558"><span class="linenos">1558</span></a>    <span class="c1">#u = U_camera[:, 0]</span>
</span><span id="DepthFromTwoViewsCameraCS-1559"><a href="#DepthFromTwoViewsCameraCS-1559"><span class="linenos">1559</span></a>
</span><span id="DepthFromTwoViewsCameraCS-1560"><a href="#DepthFromTwoViewsCameraCS-1560"><span class="linenos">1560</span></a>    <span class="k">return</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data</span>
</span></pre></div>


    

                </section>
    </main>
<script>
    /* Periodically check with the pdoc server if there have been any changes. */
    let mtime_generated = "1703764908.3",
        url = new URL(window.location);
    url.searchParams.set("mtime", 1);
    window.setInterval(function () {
        fetch(url.toString())
            .then(response => response.text())
            .then(mtime => {
                if (mtime_generated !== mtime)
                    location.reload();
            });
    }, 1000);
</script></body>
</html>